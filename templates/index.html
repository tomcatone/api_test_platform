<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>API æ¥å£æ¸¬è©¦å¹³å° v3</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<style>
:root{--pr:#4f46e5;--pl:#6366f1;--ok:#10b981;--err:#ef4444;--warn:#f59e0b;--dark:#1e1b4b;--sw:230px}
*{box-sizing:border-box}body{font-family:'Segoe UI',system-ui,sans-serif;background:#f1f5f9;margin:0}
.sb{position:fixed;left:0;top:0;bottom:0;width:var(--sw);background:var(--dark);color:#c7d2fe;display:flex;flex-direction:column;z-index:100;box-shadow:2px 0 12px rgba(0,0,0,.3)}
.sb-brand{padding:14px 16px;font-size:.95rem;font-weight:700;color:#fff;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:8px}
.sb-brand i{color:#818cf8;font-size:1.1rem}
.sb-nav{flex:1;padding:6px 0;overflow-y:auto}
.sb-nav::-webkit-scrollbar{width:3px}.sb-nav::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:2px}
.grp{padding:10px 14px 2px;font-size:.64rem;text-transform:uppercase;letter-spacing:.1em;color:#6366f1;font-weight:700}
.nb{display:flex;align-items:center;gap:8px;width:100%;padding:8px 14px;border:none;background:transparent;color:#a5b4fc;font-size:.82rem;cursor:pointer;transition:all .15s;text-align:left;border-left:3px solid transparent}
.nb:hover{background:rgba(99,102,241,.15);color:#e0e7ff}.nb.active{background:rgba(99,102,241,.25);color:#fff;border-left-color:#818cf8}
.nb i{width:15px;text-align:center}
.sb-foot{padding:8px 14px;border-top:1px solid rgba(255,255,255,.1);font-size:.68rem;color:#6366f1}
.sb-user{padding:10px 12px;border-top:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.15)}
.sb-user-info{display:flex;align-items:center;gap:9px;margin-bottom:7px}
.sb-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:700;color:#fff;flex-shrink:0}
.sb-user-text{flex:1;min-width:0}
.sb-username{font-size:.82rem;font-weight:600;color:#e0e7ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-role{font-size:.68rem;color:#818cf8}
.sb-user-actions{display:flex;gap:6px}
.sb-action-btn{flex:1;padding:5px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#a5b4fc;border-radius:6px;cursor:pointer;font-size:.75rem;transition:all .15s}
.sb-action-btn:hover{background:rgba(99,102,241,.3);color:#fff;border-color:rgba(99,102,241,.5)}
.ssl-cert-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background .12s;user-select:none}
.ssl-cert-item:hover{background:rgba(99,102,241,.08)}
.ssl-cert-item.selected{background:rgba(99,102,241,.12);border:1px solid rgba(99,102,241,.35)}
.ssl-cert-item:not(.selected){border:1px solid transparent}
.ssl-cert-radio{width:15px;height:15px;accent-color:#6366f1;flex-shrink:0;cursor:pointer}
.ssl-cert-name{flex:1;font-family:monospace;font-size:.78rem;word-break:break-all;color:#1e293b}
.ssl-cert-size{font-size:.72rem;color:#94a3b8;flex-shrink:0}
.ssl-cert-del{background:none;border:none;color:#cbd5e1;padding:2px 5px;border-radius:4px;cursor:pointer;flex-shrink:0;transition:color .12s}
.ssl-cert-del:hover{color:#ef4444}
.main{margin-left:var(--sw);padding:20px;min-height:100vh}
.page{display:none}.page.active{display:block}
.ph{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid #e2e8f0}
.pt{font-size:1.2rem;font-weight:700;color:#1e293b;margin:0}
.card{border:none;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.08)}
.card-header{background:#fff;border-bottom:1px solid #f1f5f9;padding:10px 14px;border-radius:12px 12px 0 0!important;font-weight:600;font-size:.88rem}
.stat{background:#fff;border-radius:10px;padding:12px 14px;box-shadow:0 1px 6px rgba(0,0,0,.07);display:flex;align-items:center;gap:10px}
.si{width:40px;height:40px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.15rem}
.sl{font-size:.72rem;color:#64748b;margin-bottom:1px}.sv{font-size:1.35rem;font-weight:700;color:#1e293b}
.tw{background:#fff;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.07);overflow:hidden}
.table{margin:0}.table thead th{background:#f8fafc;color:#475569;font-weight:600;font-size:.78rem;border-bottom:2px solid #e2e8f0;padding:8px 12px}
.table td{padding:8px 12px;vertical-align:middle;font-size:.82rem;border-bottom:1px solid #f1f5f9}
.table tbody tr:hover{background:#f8fafc}.table tbody tr:last-child td{border-bottom:none}
.bm{display:inline-block;padding:2px 6px;border-radius:4px;font-size:.68rem;font-weight:700}
.get{background:#dbeafe;color:#1d4ed8}.post{background:#dcfce7;color:#15803d}.put{background:#fef3c7;color:#92400e}.delete{background:#fee2e2;color:#991b1b}.patch{background:#f3e8ff;color:#6b21a8}
.bp{background:#d1fae5;color:#065f46}.bf{background:#fee2e2;color:#991b1b}.be{background:#fef3c7;color:#92400e}
.sb2{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
.sb2 .form-control,.sb2 .form-select{max-width:170px;font-size:.82rem}
.pgw{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#fff;border-top:1px solid #f1f5f9}
.pagination{margin:0}.page-link{font-size:.78rem;padding:3px 8px;color:var(--pr)}
.page-item.active .page-link{background-color:var(--pr);border-color:var(--pr)}
.form-label{font-weight:600;font-size:.79rem;color:#374151;margin-bottom:2px}
.form-control,.form-select{font-size:.82rem;border-radius:7px;border-color:#e2e8f0}
.form-control:focus,.form-select:focus{border-color:var(--pl);box-shadow:0 0 0 3px rgba(99,102,241,.12)}
.ca{font-family:'Consolas',monospace;font-size:.77rem;background:#f8fafc}
.fst{font-size:.86rem;font-weight:700;color:var(--pr);margin:10px 0 6px;border-left:3px solid var(--pr);padding-left:7px}
.btn-primary{background:var(--pr);border-color:var(--pr)}.btn-primary:hover{background:var(--pl);border-color:var(--pl)}
.btn-sm{font-size:.75rem;padding:3px 8px}
.bi{width:26px;height:26px;padding:0;display:inline-flex;align-items:center;justify-content:center;border-radius:6px}
.modal-content{border-radius:13px;border:none;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal-header{background:var(--pr);color:#fff;border-radius:13px 13px 0 0;padding:12px 16px}
.modal-title{font-weight:700;font-size:.95rem}.bcw{filter:invert(1) grayscale(100%) brightness(200%)}
.modal-footer{background:#f8fafc;border-radius:0 0 13px 13px}
.at .nav-link{font-size:.79rem;padding:4px 10px;color:#64748b}.at .nav-link.active{color:var(--pr);font-weight:600}
.rb{background:#0f172a;color:#e2e8f0;border-radius:9px;padding:12px;font-family:'Consolas',monospace;font-size:.76rem;max-height:320px;overflow-y:auto;white-space:pre-wrap;word-break:break-all}
.rb .rk{color:#93c5fd}.rb .rvs{color:#86efac}.rb .rvn{color:#fca5a5}.rb .rvb{color:#fbbf24}
.sqr{background:#0f172a;color:#a5f3fc;border-radius:7px;padding:11px;font-family:'Consolas',monospace;font-size:.76rem;max-height:260px;overflow-y:auto;white-space:pre-wrap}
.locust-script{background:#1e1b4b;color:#c7d2fe;border-radius:9px;padding:14px;font-family:'Consolas',monospace;font-size:.74rem;max-height:420px;overflow-y:auto;white-space:pre;border:1px solid #312e81}
.lov{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:9999}
.lb{background:#fff;border-radius:12px;padding:20px 28px;text-align:center}
.spinner-border{color:var(--pr)}
.cp{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px}
.pp{padding:3px 10px;border-radius:18px;font-size:.76rem;cursor:pointer;border:1.5px solid #e2e8f0;background:#fff;color:#475569;transition:all .15s}
.pp:hover,.pp.active{background:var(--pr);color:#fff;border-color:var(--pr)}
.rbar{height:9px;border-radius:5px;overflow:hidden;background:#f1f5f9;display:flex}
.rp{background:var(--ok)}.rf{background:var(--err)}.re{background:var(--warn)}
.enc{background:#fef9f0;border:1px dashed #fbbf24;border-radius:7px;padding:10px;margin-top:6px}
.ar{background:#f8fafc;border-radius:7px;padding:8px;margin-bottom:6px;border:1px solid #e2e8f0;position:relative}
.er{background:#f0fdf4;border-radius:7px;padding:8px;margin-bottom:6px;border:1px solid #bbf7d0;position:relative}
.dr{background:#fdf4ff;border-radius:7px;padding:8px;margin-bottom:6px;border:1px solid #e9d5ff;position:relative}
.ddr{background:#eff6ff;border-radius:7px;padding:8px;margin-bottom:6px;border:1px solid #bfdbfe;position:relative}
.rmb{position:absolute;top:6px;right:6px}
.tc{position:fixed;top:16px;right:16px;z-index:10000}
.tm{background:#fff;border-radius:9px;padding:8px 13px;box-shadow:0 4px 20px rgba(0,0,0,.15);margin-bottom:6px;border-left:4px solid var(--pr);display:flex;align-items:center;gap:8px;font-size:.82rem;animation:sli .2s ease}
.tm.success{border-left-color:var(--ok)}.tm.danger{border-left-color:var(--err)}.tm.warning{border-left-color:var(--warn)}
@keyframes sli{from{transform:translateX(60px);opacity:0}to{transform:translateX(0);opacity:1}}
.asl{max-height:360px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:7px}
.asi{display:flex;align-items:center;gap:7px;padding:6px 11px;border-bottom:1px solid #f1f5f9;cursor:pointer;font-size:.81rem}
.asi:hover{background:#f8fafc}.asi:last-child{border-bottom:none}
.at2{display:inline-block;padding:2px 5px;border-radius:3px;font-size:.67rem;background:#ecfdf5;color:#059669;font-weight:600}
.dt{display:inline-block;padding:2px 5px;border-radius:3px;font-size:.67rem;background:#f3e8ff;color:#7c3aed;font-weight:600}
.lt{display:inline-block;padding:2px 5px;border-radius:3px;font-size:.67rem;background:#fff7ed;color:#c2410c;font-weight:600}
.rklist{max-height:220px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:7px;background:#fff}
.rki{display:flex;align-items:center;gap:7px;padding:5px 11px;border-bottom:1px solid #f1f5f9;cursor:pointer;font-size:.79rem}
.rki:hover{background:#f8fafc}.rki:last-child{border-bottom:none}
.cronhelp{background:#f8fafc;border-radius:7px;padding:9px 12px;font-size:.75rem;color:#475569;line-height:1.9}
.cronhelp code{background:#e2e8f0;padding:1px 4px;border-radius:3px;color:#7c3aed}
.ts-active{color:var(--ok);font-weight:600}.ts-paused{color:var(--warn);font-weight:600}.ts-stopped{color:#94a3b8}
.locust-stat{text-align:center;background:#f8fafc;border-radius:9px;padding:12px 8px}
.locust-stat .val{font-size:1.3rem;font-weight:700;color:#1e293b}
.locust-stat .lbl{font-size:.72rem;color:#64748b}
.pulse{animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
</style>
</head>
<body>
<div class="tc" id="tc"></div>
<div class="lov" id="lov" style="display:none"><div class="lb"><div class="spinner-border mb-2"></div><div id="lt">åŸ·è¡Œä¸­...</div></div></div>

<!-- Sidebar -->
<nav class="sb">
  <div class="sb-brand"><i class="fas fa-flask"></i><span>API æ¸¬è©¦å¹³å° v3</span></div>
  <div class="sb-nav">
    <div class="grp">ç¸½è¦½</div>
    <button class="nb active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i>æ§åˆ¶å°</button>
    <div class="grp">æ¥å£ç®¡ç†</div>
    <button class="nb" data-page="apis"><i class="fas fa-plug"></i>æ¥å£åˆ—è¡¨</button>
    <button class="nb" data-page="categories"><i class="fas fa-tags"></i>æ¥å£åˆ†é¡</button>
    <div class="grp">æ•¸æ“šæºé…ç½®</div>
    <button class="nb" data-page="variables"><i class="fas fa-key"></i>å…¨å±€è®Šé‡/Token</button>
    <button class="nb" data-page="databases"><i class="fas fa-database"></i>MySQL é…ç½®</button>
    <button class="nb" data-page="redis"><i class="fas fa-server"></i>Redis é…ç½®</button>
    <button class="nb" data-page="redis_tool"><i class="fas fa-terminal"></i>Redis å·¥å…·</button>
    <div class="grp">é€šçŸ¥ &amp; éƒµä»¶</div>
    <button class="nb" data-page="email"><i class="fas fa-envelope"></i>éƒµä»¶é…ç½®</button>
    <div class="grp">åŸ·è¡Œ &amp; å ±å‘Š</div>
    <button class="nb" data-page="scheduler"><i class="fas fa-clock"></i>å®šæ™‚ä»»å‹™</button>
    <button class="nb" data-page="runner"><i class="fas fa-play-circle"></i>æ‰¹é‡åŸ·è¡Œ</button>
    <button class="nb" data-page="locust"><i class="fas fa-bug"></i>å£“åŠ›æ¸¬è©¦ Locust</button>
    <button class="nb" data-page="sql_tool"><i class="fas fa-table"></i>SQL å·¥å…·</button>
    <button class="nb" data-page="reports"><i class="fas fa-chart-bar"></i>æ¸¬è©¦å ±å‘Š</button>
    <!-- ç®¡ç†å“¡å°ˆå±¬ï¼šè³¬æˆ¶ç®¡ç† -->
    <div class="grp admin-only" style="display:none">ç³»çµ±ç®¡ç†</div>
    <button class="nb admin-only" data-page="accounts" style="display:none"><i class="fas fa-users-cog"></i>è³¬æˆ¶ç®¡ç†</button>
  </div>
  <!-- åº•éƒ¨ç”¨æˆ¶ä¿¡æ¯ -->
  <div class="sb-user" id="sbUser">
    <div class="sb-user-info">
      <div class="sb-avatar" id="sbAvatar">?</div>
      <div class="sb-user-text">
        <div class="sb-username" id="sbUsername">åŠ è¼‰ä¸­...</div>
        <div class="sb-role" id="sbRole"></div>
      </div>
    </div>
    <div class="sb-user-actions">
      <button class="sb-action-btn" onclick="openChangePwd()" title="ä¿®æ”¹å¯†ç¢¼"><i class="fas fa-key fa-xs"></i></button>
      <button class="sb-action-btn" onclick="doLogout()" title="é€€å‡ºç™»éŒ„"><i class="fas fa-sign-out-alt fa-xs"></i></button>
    </div>
  </div>
</nav>

<div class="main">

<!-- â•â•â• DASHBOARD â•â•â• -->
<div id="page-dashboard" class="page active">
  <div class="ph"><h1 class="pt"><i class="fas fa-tachometer-alt me-2 text-primary"></i>æ§åˆ¶å°</h1>
    <button class="btn btn-sm btn-primary" onclick="loadDash()"><i class="fas fa-sync me-1"></i>åˆ·æ–°</button></div>
  <div class="row g-3 mb-3" id="dashStats">
    <div class="col-6 col-md-2"><div class="stat"><div class="si" style="background:#ede9fe"><i class="fas fa-plug" style="color:#7c3aed"></i></div><div><div class="sl">æ¥å£</div><div class="sv" id="s-api">-</div></div></div></div>
    <div class="col-6 col-md-2"><div class="stat"><div class="si" style="background:#dbeafe"><i class="fas fa-database" style="color:#1d4ed8"></i></div><div><div class="sl">MySQL</div><div class="sv" id="s-db">-</div></div></div></div>
    <div class="col-6 col-md-2"><div class="stat"><div class="si" style="background:#fff1f2"><i class="fas fa-server" style="color:#be123c"></i></div><div><div class="sl">Redis</div><div class="sv" id="s-redis">-</div></div></div></div>
    <div class="col-6 col-md-2"><div class="stat"><div class="si" style="background:#ecfdf5"><i class="fas fa-clock" style="color:#059669"></i></div><div><div class="sl">å®šæ™‚ä»»å‹™</div><div class="sv" id="s-task">-</div></div></div></div>
    <div class="col-6 col-md-2"><div class="stat"><div class="si" style="background:#fef3c7"><i class="fas fa-key" style="color:#b45309"></i></div><div><div class="sl">å…¨å±€è®Šé‡</div><div class="sv" id="s-var">-</div></div></div></div>
    <div class="col-6 col-md-2"><div class="stat"><div class="si" style="background:#dcfce7"><i class="fas fa-chart-bar" style="color:#15803d"></i></div><div><div class="sl">å ±å‘Š</div><div class="sv" id="s-rpt">-</div></div></div></div>
  </div>
  <div class="row g-3">
    <div class="col-md-7"><div class="card"><div class="card-header">æœ€è¿‘æ¸¬è©¦å ±å‘Š</div>
      <div class="tw"><table class="table"><thead><tr><th>å ±å‘Šåç¨±</th><th>é€šéç‡</th><th>çµæœ</th><th>æ™‚é–“</th><th></th></tr></thead>
      <tbody id="dashRpt"><tr><td colspan="5" class="text-center text-muted py-3">åŠ è¼‰ä¸­...</td></tr></tbody></table></div></div></div>
    <div class="col-md-5"><div class="card"><div class="card-header">å¿«é€Ÿæ“ä½œ</div><div class="card-body"><div class="d-grid gap-2">
      <button class="btn btn-outline-primary btn-sm" onclick="go('apis');openApiModal()"><i class="fas fa-plus me-2"></i>æ–°å¢æ¥å£</button>
      <button class="btn btn-outline-danger btn-sm" onclick="go('redis_tool')"><i class="fas fa-server me-2"></i>Redis å–é©—è­‰ç¢¼â†’è®Šé‡</button>
      <button class="btn btn-outline-success btn-sm" onclick="go('runner')"><i class="fas fa-play me-2"></i>æ‰¹é‡åŸ·è¡Œæ¸¬è©¦</button>
      <button class="btn btn-outline-warning btn-sm" onclick="go('scheduler');openTaskModal()"><i class="fas fa-clock me-2"></i>æ–°å»ºå®šæ™‚ä»»å‹™</button>
      <button class="btn btn-outline-dark btn-sm" onclick="go('locust')"><i class="fas fa-bug me-2"></i>Locust å£“åŠ›æ¸¬è©¦</button>
    </div></div></div></div>
  </div>
</div>

<!-- â•â•â• APIS â•â•â• -->
<div id="page-apis" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-plug me-2 text-primary"></i>æ¥å£ç®¡ç†</h1><button class="btn btn-primary btn-sm" onclick="openApiModal()"><i class="fas fa-plus me-1"></i>æ·»åŠ æ¥å£</button></div>
  <div class="cp" id="catPills"><div class="pp active" onclick="fCat('')">å…¨éƒ¨</div></div>
  <div class="sb2">
    <input type="text" class="form-control" id="apiSrc" placeholder="æœç´¢æ¥å£å/URL..." oninput="debLoad(loadApis,350)">
    <select class="form-select" id="mthF" onchange="loadApis()"><option value="">æ‰€æœ‰æ–¹æ³•</option><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option></select>
  </div>
  <div class="tw"><table class="table"><thead><tr>
    <th><input type="checkbox" id="selAll" onchange="togSelAll(this)"></th>
    <th>æ¥å£åç¨±</th><th>åˆ†é¡</th><th>æ–¹æ³•</th><th>URL</th><th>æ¨™è¨˜</th><th>æ›´æ–°æ™‚é–“</th><th>æ“ä½œ</th>
  </tr></thead><tbody id="apiTb"></tbody></table>
  <div class="pgw"><div class="text-muted small" id="apiTot">å…± 0 æ¢</div><nav><ul class="pagination pagination-sm" id="apiPg"></ul></nav></div></div>
  <div class="mt-2 d-flex gap-2">
    <button class="btn btn-success btn-sm" onclick="runSel()"><i class="fas fa-play me-1"></i>åŸ·è¡Œå·²é¸</button>
    <button class="btn btn-danger btn-sm" onclick="delSel()"><i class="fas fa-trash me-1"></i>æ‰¹é‡åˆªé™¤</button>
  </div>
</div>

<!-- â•â•â• CATEGORIES â•â•â• -->
<div id="page-categories" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-tags me-2 text-primary"></i>æ¥å£åˆ†é¡</h1><button class="btn btn-primary btn-sm" onclick="openCatModal()"><i class="fas fa-plus me-1"></i>æ·»åŠ åˆ†é¡</button></div>
  <div class="row g-3" id="catCards"><div class="col-12 text-center text-muted py-4">åŠ è¼‰ä¸­...</div></div>
</div>

<!-- â•â•â• VARIABLES â•â•â• -->
<div id="page-variables" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-key me-2 text-primary"></i>å…¨å±€è®Šé‡ / Token</h1>
    <div class="d-flex gap-2"><button class="btn btn-warning btn-sm" onclick="openTokModal()"><i class="fas fa-magic me-1"></i>ç”ŸæˆToken</button><button class="btn btn-primary btn-sm" onclick="openVarModal()"><i class="fas fa-plus me-1"></i>æ·»åŠ </button></div></div>
  <div class="alert alert-info py-2 mb-3 small"><i class="fas fa-info-circle me-1"></i>åœ¨ URL / Headers / Body / SQL / Redis Key ä¸­ä½¿ç”¨ <code>{{è®Šé‡å}}</code> å¼•ç”¨è®Šé‡</div>

  <!-- å‹•æ…‹è®Šé‡å€å¡Š -->
  <div class="card mb-4 border-warning">
    <div class="card-header d-flex justify-content-between align-items-center py-2" style="background:rgba(251,191,36,.1)">
      <span class="fw-bold"><i class="fas fa-bolt me-1 text-warning"></i>å‹•æ…‹è®Šé‡ <small class="text-muted fw-normal">â€” æ¯æ¬¡æ¥å£è«‹æ±‚å‰è‡ªå‹•é‡æ–°ç”Ÿæˆï¼Œç›´æ¥ç”¨ <code>{{è®Šé‡å}}</code> å¼•ç”¨</small></span>
      <button class="btn btn-warning btn-sm" onclick="openDynVarModal()"><i class="fas fa-plus me-1"></i>æ·»åŠ å‹•æ…‹è®Šé‡</button>
    </div>
    <div class="card-body p-0">
      <table class="table mb-0">
        <thead><tr><th style="width:40px">å•Ÿç”¨</th><th>è®Šé‡å</th><th>é¡å‹</th><th>ç•¶å‰é è¦½å€¼</th><th>å‚™è¨»</th><th style="width:100px">æ“ä½œ</th></tr></thead>
        <tbody id="dynVarTb"><tr><td colspan="6" class="text-center text-muted py-3">åŠ è¼‰ä¸­...</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="tw"><table class="table"><thead><tr><th>è®Šé‡å</th><th>é¡å‹</th><th>å€¼</th><th>æè¿°</th><th>æ›´æ–°</th><th>æ“ä½œ</th></tr></thead>
  <tbody id="varTb"></tbody></table>
  <div class="pgw"><div class="text-muted small" id="varTot">å…± 0 æ¢</div><nav><ul class="pagination pagination-sm" id="varPg"></ul></nav></div></div>
</div>

<!-- â•â•â• ACCOUNTS â•â•â• -->
<div id="page-accounts" class="page">
  <div class="ph">
    <h1 class="pt"><i class="fas fa-users-cog me-2 text-primary"></i>è³¬æˆ¶ç®¡ç†</h1>
    <button class="btn btn-primary btn-sm" onclick="openAccModal()"><i class="fas fa-plus me-1"></i>æ–°å»ºè³¬æˆ¶</button>
  </div>
  <div class="alert alert-info py-2 mb-3 small">
    <i class="fas fa-info-circle me-1"></i>
    ç®¡ç†å“¡å¯å‰µå»ºè³¬æˆ¶ã€ä¿®æ”¹å¯†ç¢¼ã€åˆ‡æ›è§’è‰²ã€‚<strong>æ™®é€šç”¨æˆ¶</strong>æ“æœ‰é™¤è³¬æˆ¶ç®¡ç†å¤–çš„æ‰€æœ‰åŠŸèƒ½æ¬Šé™ã€‚
  </div>
  <div class="tw">
    <table class="table">
      <thead><tr><th>ç”¨æˆ¶å</th><th>é¡¯ç¤ºå</th><th>è§’è‰²</th><th>ç‹€æ…‹</th><th>å‰µå»ºæ™‚é–“</th><th style="width:160px">æ“ä½œ</th></tr></thead>
      <tbody id="accTb"><tr><td colspan="6" class="text-center text-muted py-4">åŠ è¼‰ä¸­...</td></tr></tbody>
    </table>
  </div>
</div>

<!-- â•â•â• DATABASES â•â•â• -->
<div id="page-databases" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-database me-2 text-primary"></i>MySQL é…ç½®</h1><button class="btn btn-primary btn-sm" onclick="openDbModal()"><i class="fas fa-plus me-1"></i>æ·»åŠ </button></div>
  <div class="row g-3" id="dbCards"><div class="col-12 text-center text-muted py-4">åŠ è¼‰ä¸­...</div></div>
</div>

<!-- â•â•â• REDIS CONFIG â•â•â• -->
<div id="page-redis" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-server me-2" style="color:#be123c"></i>Redis é…ç½®</h1><button class="btn btn-primary btn-sm" onclick="openRedisModal()"><i class="fas fa-plus me-1"></i>æ·»åŠ </button></div>
  <div class="alert alert-info py-2 mb-3 small"><i class="fas fa-info-circle me-1"></i>Redis é…ç½®ç”¨æ–¼ Redis å·¥å…· å’Œ é©—è­‰ç¢¼è®€å–ï¼Œæ”¯æŒ String/Hash/List/Set/ZSet é¡å‹ã€‚</div>
  <div class="row g-3" id="redisCards"><div class="col-12 text-center text-muted py-4">åŠ è¼‰ä¸­...</div></div>
</div>

<!-- â•â•â• REDIS TOOL â•â•â• -->
<div id="page-redis_tool" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-terminal me-2" style="color:#be123c"></i>Redis æ“ä½œå·¥å…·</h1></div>
  <div class="row g-3">
    <div class="col-md-5">
      <div class="card mb-3"><div class="card-header">é€£æ¥ &amp; æ“ä½œ</div><div class="card-body p-3">
        <div class="mb-2"><label class="form-label">é¸æ“‡ Redis é€£æ¥</label>
          <select class="form-select" id="rdConn"></select></div>
        <div class="mb-2"><label class="form-label">æ“ä½œé¡å‹</label>
          <select class="form-select" id="rdAction" onchange="rdToggleFields()">
            <option value="scan">SCAN æƒæ Key</option>
            <option value="get">GET è®€å–</option>
            <option value="set">SET å¯«å…¥</option>
            <option value="delete">DELETE åˆªé™¤</option>
            <option value="ttl">TTL æŸ¥è©¢</option>
            <option value="expire">EXPIRE è¨­ç½®éæœŸ</option>
            <option value="fetch_captcha">ğŸ”‘ ç²å–é©—è­‰ç¢¼ â†’ å…¨å±€è®Šé‡</option>
          </select></div>
        <div id="rdPatternWrap" class="mb-2"><label class="form-label">Pattern</label>
          <input type="text" class="form-control ca" id="rdPattern" value="*" placeholder="sms:captcha:*"></div>
        <div id="rdKeyWrap" class="mb-2" style="display:none"><label class="form-label">Key</label>
          <input type="text" class="form-control ca" id="rdKey" placeholder="sms:captcha:13800138000"></div>
        <div id="rdValWrap" class="mb-2" style="display:none"><label class="form-label">Value</label>
          <input type="text" class="form-control ca" id="rdVal"></div>
        <div id="rdTtlWrap" class="mb-2" style="display:none"><label class="form-label">TTL (ç§’ï¼Œ0=æ°¸ä¹…)</label>
          <input type="number" class="form-control" id="rdTtl" value="300"></div>
        <div id="rdCaptchaWrap" style="display:none">
          <div class="alert alert-warning py-2 small mb-2"><i class="fas fa-info-circle me-1"></i>å¾ Redis ç²å–é©—è­‰ç¢¼ï¼Œè‡ªå‹•å­˜å…¥å…¨å±€è®Šé‡ï¼Œæ¥å£ Body ä¸­ç›´æ¥ä½¿ç”¨ <code>{{captcha}}</code></div>
          <div class="mb-2"><label class="form-label">Redis Key <small class="text-muted">(æ”¯æŒ {{è®Šé‡å}})</small></label>
            <input type="text" class="form-control ca" id="rdCapKey" placeholder="sms:captcha:{{mobile}}"></div>
          <div class="mb-2"><label class="form-label">å­˜å…¥å…¨å±€è®Šé‡å</label>
            <input type="text" class="form-control" id="rdCapVar" value="captcha"></div>
          <div class="mb-2"><label class="form-label">æå– JSON å­—æ®µ <small class="text-muted">(å€¼ç‚ºJSONæ™‚å¡«å¯«ï¼Œå¦‚ code)</small></label>
            <input type="text" class="form-control" id="rdCapField" placeholder="code (é¸å¡«)"></div>
        </div>
        <button class="btn btn-danger w-100 mt-2" onclick="execRedis()"><i class="fas fa-play me-1"></i>åŸ·è¡Œ</button>
      </div></div>
    </div>
    <div class="col-md-7">
      <div class="card"><div class="card-header" id="rdResTitle">çµæœ</div>
        <div class="card-body p-0">
          <div id="rdKeyListWrap" style="display:none">
            <div class="px-3 py-2 border-bottom d-flex align-items-center gap-2">
              <span class="text-muted small" id="rdKeyCount"></span>
              <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="rdCopyKeys()"><i class="fas fa-copy me-1"></i>è¤‡è£½å…¨éƒ¨</button>
            </div>
            <div class="rklist" id="rdKeyList"></div>
          </div>
          <div id="rdResWrap" class="p-3" style="display:none">
            <div class="sqr" id="rdResBox"></div>
          </div>
          <div id="rdCapResWrap" class="p-3" style="display:none">
            <div class="alert alert-success mb-2" id="rdCapMsg"></div>
            <table class="table table-sm table-bordered"><tbody id="rdCapDetail"></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• EMAIL â•â•â• -->
<div id="page-email" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-envelope me-2 text-primary"></i>éƒµä»¶é…ç½® (SMTP)</h1><button class="btn btn-primary btn-sm" onclick="openEmailModal()"><i class="fas fa-plus me-1"></i>æ·»åŠ </button></div>
  <div class="alert alert-info py-2 mb-3 small"><i class="fas fa-info-circle me-1"></i>é…ç½® SMTP å¾Œï¼Œå®šæ™‚ä»»å‹™åŸ·è¡Œå®Œç•¢ã€æ‰¹é‡åŸ·è¡Œå®Œç•¢å¯è‡ªå‹•ç™¼é€ç²¾ç¾ HTML å ±å‘Šéƒµä»¶ã€‚</div>
  <div class="row g-3" id="emailCards"><div class="col-12 text-center text-muted py-4">åŠ è¼‰ä¸­...</div></div>
</div>

<!-- â•â•â• SCHEDULER â•â•â• -->
<div id="page-scheduler" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-clock me-2 text-primary"></i>å®šæ™‚ä»»å‹™</h1><button class="btn btn-primary btn-sm" onclick="openTaskModal()"><i class="fas fa-plus me-1"></i>æ–°å»º</button></div>
  <div class="alert alert-info py-2 mb-3 small"><i class="fas fa-info-circle me-1"></i>Cron æ ¼å¼ï¼š<code>åˆ† æ™‚ æ—¥ æœˆ é€±</code>ã€‚ä¾‹ï¼š<code>0 9 * * 1-5</code>ï¼ˆé€±ä¸€è‡³äº”09:00ï¼‰Â· <code>*/30 * * * *</code>ï¼ˆæ¯30åˆ†é˜ï¼‰</div>
  <div class="tw"><table class="table"><thead><tr><th>ä»»å‹™åç¨±</th><th>è§¸ç™¼æ–¹å¼</th><th>ä¸‹æ¬¡åŸ·è¡Œ</th><th>ç‹€æ…‹</th><th>ä¸Šæ¬¡çµæœ</th><th>éƒµä»¶</th><th>æ“ä½œ</th></tr></thead>
  <tbody id="taskTb"><tr><td colspan="7" class="text-center text-muted py-4">åŠ è¼‰ä¸­...</td></tr></tbody></table></div>
</div>

<!-- â•â•â• RUNNER â•â•â• -->
<div id="page-runner" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-play-circle me-2 text-primary"></i>æ‰¹é‡åŸ·è¡Œ</h1></div>
  <div class="row g-3">
    <div class="col-md-5"><div class="card"><div class="card-header d-flex justify-content-between align-items-center">é¸æ“‡æ¥å£
      <div class="d-flex gap-1">
        <button class="btn btn-outline-primary btn-sm" onclick="rnrAll()">å…¨é¸</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="rnrNone()">æ¸…ç©º</button>
      </div></div><div class="card-body p-2">
      <div class="sb2 mb-2">
        <input type="text" class="form-control" id="rnrSrc" placeholder="æœç´¢..." oninput="loadRnrApis()">
        <select class="form-select" id="rnrCat" onchange="loadRnrApis()"><option value="">å…¨éƒ¨åˆ†é¡</option></select>
      </div>
      <div class="asl" id="rnrList">åŠ è¼‰ä¸­...</div>
    </div></div></div>
    <div class="col-md-7">
      <div class="card mb-3"><div class="card-header">åŸ·è¡Œè¨­ç½®</div><div class="card-body">
        <div class="mb-2"><label class="form-label">å ±å‘Šåç¨±ï¼ˆç•™ç©ºè‡ªå‹•ç”Ÿæˆï¼‰</label><input type="text" class="form-control" id="rnrName"></div>
        <div class="mb-2"><label class="form-label">åŸ·è¡Œå¾Œç™¼éƒµä»¶å ±å‘Š</label>
          <div class="input-group input-group-sm"><div class="input-group-text"><input type="checkbox" id="rnrEmail"></div>
          <input type="text" class="form-control" id="rnrEmailTo" placeholder="æ”¶ä»¶äººï¼Œå¤šå€‹é€—è™Ÿåˆ†éš”"></div></div>
        <div class="mb-3 d-flex gap-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="rnrStopOnFail">
            <label class="form-check-label small">
              <i class="fas fa-stop-circle text-danger me-1"></i>å¤±æ•—ç«‹å³åœæ­¢ï¼ˆè¯å‹•æ¸¬è©¦æ¨è–¦é–‹å•Ÿï¼‰
            </label>
          </div>
        </div>
        <div id="rnrSel" class="d-flex flex-wrap gap-1 p-2 border rounded mb-3" style="min-height:38px;background:#f8fafc"><span class="text-muted small">æœªé¸æ“‡æ¥å£</span></div>
        <button class="btn btn-success w-100" onclick="runBatch()"><i class="fas fa-rocket me-2"></i>é–‹å§‹æ‰¹é‡åŸ·è¡Œ</button>
      </div></div>
      <div class="card" id="rnrRes" style="display:none"><div class="card-header">åŸ·è¡Œçµæœ</div><div class="card-body" id="rnrResBody"></div></div>
    </div>
  </div>
</div>

<!-- â•â•â• LOCUST â•â•â• -->
<div id="page-locust" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-bug me-2 text-primary"></i>å£“åŠ›æ¸¬è©¦ (Locust)</h1></div>
  <div class="row g-3">
    <div class="col-md-5">
      <div class="card mb-3"><div class="card-header">é¸æ“‡æ¥å£ &amp; é…ç½®</div><div class="card-body p-2">
        <div class="asl mb-2" id="locustApiList" style="max-height:200px">åŠ è¼‰ä¸­...</div>
        <div class="row g-2 mt-1">
          <div class="col-md-4"><label class="form-label">ä¸¦ç™¼ç”¨æˆ¶æ•¸</label><input type="number" class="form-control" id="lstUsers" value="10" min="1"></div>
          <div class="col-md-4"><label class="form-label">ç”Ÿæˆé€Ÿç‡(u/s)</label><input type="number" class="form-control" id="lstSpawn" value="2" min="1"></div>
          <div class="col-md-4"><label class="form-label">åŸ·è¡Œæ™‚é•·</label><input type="text" class="form-control" id="lstTime" value="60s" placeholder="60s/5m"></div>
        </div>
        <div class="mb-2 mt-2"><label class="form-label">æ”¶é›†å ±å‘Šåç¨±</label><input type="text" class="form-control" id="lstRptName" placeholder="å£“æ¸¬å ±å‘Š-xxx"></div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="locustPreview()"><i class="fas fa-eye me-1"></i>é è¦½è…³æœ¬</button>
          <button class="btn btn-danger btn-sm flex-fill" id="lstStartBtn" onclick="locustStart()"><i class="fas fa-rocket me-1"></i>é–‹å§‹å£“æ¸¬</button>
          <button class="btn btn-warning btn-sm flex-fill" id="lstStopBtn" onclick="locustStop()" style="display:none"><i class="fas fa-stop me-1"></i>åœæ­¢</button>
        </div>
      </div></div>
      <div class="card" id="lstScriptCard" style="display:none"><div class="card-header">ç”Ÿæˆè…³æœ¬é è¦½</div>
        <div class="card-body p-2"><div class="locust-script" id="lstScript"></div></div></div>
    </div>
    <div class="col-md-7">
      <div class="card mb-3"><div class="card-header d-flex justify-content-between align-items-center">å£“æ¸¬ç‹€æ…‹
        <span id="lstStatusBadge" class="badge bg-secondary">æœªé–‹å§‹</span></div>
        <div class="card-body" id="lstStatusBody">
          <div class="text-center text-muted py-4"><i class="fas fa-bug fa-2x mb-2 d-block text-muted"></i>é¸æ“‡æ¥å£ä¸¦é»æ“Šã€Œé–‹å§‹å£“æ¸¬ã€</div>
        </div></div>
      <div class="card" id="lstResultCard" style="display:none"><div class="card-header">å£“æ¸¬çµæœ</div>
        <div class="card-body" id="lstResultBody"></div></div>
    </div>
  </div>
</div>

<!-- â•â•â• SQL TOOL â•â•â• -->
<div id="page-sql_tool" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-table me-2 text-primary"></i>SQL åŸ·è¡Œå·¥å…·</h1></div>
  <div class="row g-3">
    <div class="col-md-8"><div class="card"><div class="card-header">SQL ç·¨è¼¯å™¨</div><div class="card-body">
      <div class="mb-2"><label class="form-label">é¸æ“‡æ•¸æ“šåº«</label><select class="form-select" id="sqlDb"><option value="">-- è«‹é¸æ“‡ --</option></select></div>
      <div class="mb-2"><label class="form-label">SQL èªå¥ï¼ˆæ”¯æŒå¤šæ¢ï¼Œç”¨ ; åˆ†éš”ï¼‰</label>
        <textarea class="form-control ca" id="sqlText" rows="8" placeholder="SELECT * FROM users LIMIT 10;&#10;DELETE FROM tmp WHERE id=1;"></textarea></div>
      <div class="d-flex gap-2">
        <button class="btn btn-success btn-sm" onclick="runSql()"><i class="fas fa-play me-1"></i>åŸ·è¡Œ</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('sqlText').value=''">æ¸…ç©º</button>
      </div>
    </div></div></div>
    <div class="col-md-4"><div class="card"><div class="card-header">SQL æ¨¡æ¿</div><div class="card-body p-2"><div class="d-grid gap-1">
      <button class="btn btn-sm btn-outline-secondary text-start" onclick="insSql('select')"><i class="fas fa-search me-1"></i>SELECT æŸ¥è©¢</button>
      <button class="btn btn-sm btn-outline-secondary text-start" onclick="insSql('count')"><i class="fas fa-hashtag me-1"></i>COUNT è¨ˆæ•¸</button>
      <button class="btn btn-sm btn-outline-danger text-start" onclick="insSql('delete')"><i class="fas fa-trash me-1"></i>DELETE åˆªé™¤è¡Œ</button>
      <button class="btn btn-sm btn-outline-danger text-start" onclick="insSql('truncate')"><i class="fas fa-broom me-1"></i>TRUNCATE æ¸…ç©ºè¡¨</button>
      <button class="btn btn-sm btn-outline-secondary text-start" onclick="insSql('tables')"><i class="fas fa-list me-1"></i>SHOW TABLES</button>
      <button class="btn btn-sm btn-outline-secondary text-start" onclick="insSql('desc')"><i class="fas fa-info-circle me-1"></i>DESCRIBE</button>
    </div></div></div></div>
    <div class="col-12" id="sqlResWrap" style="display:none">
      <div class="card"><div class="card-header" id="sqlResTitle">çµæœ</div><div class="card-body p-0" id="sqlResBody"></div></div>
    </div>
  </div>
</div>

<!-- â•â•â• REPORTS â•â•â• -->
<div id="page-reports" class="page">
  <div class="ph"><h1 class="pt"><i class="fas fa-chart-bar me-2 text-primary"></i>æ¸¬è©¦å ±å‘Š</h1>
    <button class="btn btn-sm btn-outline-secondary" onclick="loadRpts()"><i class="fas fa-sync me-1"></i>åˆ·æ–°</button></div>
  <div class="tw"><table class="table"><thead><tr><th>å ±å‘Šåç¨±</th><th>é€šéç‡</th><th>é€šé/å¤±æ•—/éŒ¯èª¤</th><th>ç¸½æ•¸</th><th>è€—æ™‚</th><th>æ™‚é–“</th><th>æ“ä½œ</th></tr></thead>
  <tbody id="rptTb"></tbody></table>
  <div class="pgw"><div class="text-muted small" id="rptTot">å…± 0 æ¢</div><nav><ul class="pagination pagination-sm" id="rptPg"></ul></nav></div></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â• -->
<!-- API Modal -->
<div class="modal fade" id="apiModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="apiMT">æ·»åŠ æ¥å£</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <input type="hidden" id="apiId">
    <div class="row g-2 mb-2">
      <div class="col-md-5"><label class="form-label">æ¥å£åç¨± *</label><input type="text" class="form-control" id="apiName"></div>
      <div class="col-md-3"><label class="form-label">åˆ†é¡</label><select class="form-select" id="apiCat"><option value="">æœªåˆ†é¡</option></select></div>
      <div class="col-md-2"><label class="form-label">æ’åº</label><input type="number" class="form-control" id="apiSort" value="0"></div>
      <div class="col-md-2"><label class="form-label">è¶…æ™‚(ç§’)</label><input type="number" class="form-control" id="apiTimeout" value="30" min="1"></div>
      <div class="col-md-2"><label class="form-label">HTTPæ–¹æ³• *</label><select class="form-select" id="apiMth" onchange="togApiBody()"><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option><option>PATCH</option><option>HEAD</option><option>OPTIONS</option></select></div>
      <div class="col-md-3" id="ctWrap"><label class="form-label">Bodyé¡å‹</label>
        <select class="form-select" id="apiBodyType">
          <option value="json">JSON &nbsp;â†’&nbsp; json=body</option>
          <option value="data">Data &nbsp;â†’&nbsp; data=body</option>
          <option value="params">Params &nbsp;â†’&nbsp; params=body</option>
          <option value="form">Form (form-urlencoded)</option>
          <option value="text">Text/Plain (text/plain)</option>
          <option value="raw">Raw (è‡ªå®šç¾©/json.dumps)</option>
          <option value="files">Files (multipart/form-data)</option>
        </select></div>
      <div class="col-md-2">
        <label class="form-label">è«‹æ±‚æ¨¡å¼</label>
        <div class="form-check form-switch mt-1"><input class="form-check-input" type="checkbox" id="apiAsync"><label class="form-check-label small" for="apiAsync"><span class="at2">httpxç•°æ­¥</span></label></div>
        <div class="form-check form-switch mt-1"><input class="form-check-input" type="checkbox" id="apiSession"><label class="form-check-label small" for="apiSession">Sessionä¿æŒ</label></div>
      </div>
      <div class="col-md-5"><label class="form-label">URL * <small class="text-muted">(æ”¯æŒ {{è®Šé‡å}})</small></label><input type="text" class="form-control" id="apiUrl" placeholder="https://api.example.com/users"></div>
      <div class="col-md-12"><label class="form-label">æè¿°</label><input type="text" class="form-control" id="apiDesc"></div>
    </div>
    <ul class="nav nav-tabs at mb-0" id="apiTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tH">Headers</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tP">Params</a></li>
      <li class="nav-item" id="tBli"><a class="nav-link" data-bs-toggle="tab" href="#tB">Body <small class="text-muted" id="tBBadge"></small></a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tEx">æå–è®Šé‡</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tAs">HTTPæ–·è¨€</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tDD">DeepDiff<span class="dt ms-1">DD</span></a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tDA">DBæ–·è¨€<span class="dt ms-1">DB</span></a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tSql">å‰å¾Œç½®SQL</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tRedis">å‰ç½®Redis<span class="badge bg-danger ms-1" style="font-size:.6rem">RD</span></a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tSsl">SSL <span class="badge bg-success ms-1" style="font-size:.6rem">ğŸ”’</span></a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tEnc">åŠ å¯† <span class="badge bg-danger" style="font-size:.6rem">GCM</span></a></li>
    </ul>
    <!-- å…§å»ºå‹•æ…‹è®Šé‡æç¤ºï¼ˆæ¯æ¬¡è«‹æ±‚è‡ªå‹•ç”Ÿæˆï¼Œå¯åœ¨ä»»æ„æ¬„ä½ä½¿ç”¨ï¼‰ -->
    <div class="d-flex flex-wrap gap-1 px-1 py-2 border border-top-0 border-bottom-0" style="background:#f8f9ff">
      <span class="text-muted" style="font-size:.72rem;line-height:2">å…§å»ºè®Šé‡ï¼š</span>
      <code class="badge bg-secondary" title="éš¨æ©Ÿä¸­åœ‹æ‰‹æ©Ÿè™Ÿ å¦‚13812345678" style="cursor:default">{{rand_mobile}}</code>
      <code class="badge bg-secondary" title="Unixæ™‚é–“æˆ³ï¼ˆç§’ï¼‰" style="cursor:default">{{timestamp}}</code>
      <code class="badge bg-secondary" title="Unixæ™‚é–“æˆ³ï¼ˆæ¯«ç§’ï¼‰" style="cursor:default">{{timestamp_ms}}</code>
      <code class="badge bg-secondary" title="ç•¶å‰æ—¥æœŸæ™‚é–“ å¦‚2026-02-22 14:30:00" style="cursor:default">{{datetime}}</code>
      <code class="badge bg-secondary" title="ç•¶å‰æ—¥æœŸ å¦‚2026-02-22" style="cursor:default">{{date}}</code>
      <code class="badge bg-secondary" title="éš¨æ©Ÿ6ä½æ•´æ•¸" style="cursor:default">{{rand_int}}</code>
      <code class="badge bg-secondary" title="éš¨æ©Ÿ8ä½å­—æ¯æ•¸å­—" style="cursor:default">{{rand_str}}</code>
      <span class="text-muted ms-1" style="font-size:.7rem;line-height:2">æ¯æ¬¡è«‹æ±‚é‡æ–°ç”Ÿæˆ Â· é»æ“Šè¤‡è£½</span>
    </div>
    <div class="tab-content p-3 border border-top-0 rounded-bottom" style="max-height:340px;overflow-y:auto">
      <div class="tab-pane fade show active" id="tH">
        <div class="fst">è«‹æ±‚é ­ (JSON)</div>
        <textarea class="form-control ca" id="apiHdr" rows="5" placeholder='{"Authorization":"Bearer {{token}}","Content-Type":"application/json"}'></textarea></div>
      <div class="tab-pane fade" id="tP">
        <div class="fst">Query Params <small class="text-muted fw-normal">â€” æ”¯æŒ JSON / key=value / ç´”å­—ç¬¦ä¸²</small></div>
        <div class="alert alert-info py-1 small mb-2">
          JSONï¼š<code>{"page":"1","size":"10"}</code> &nbsp;|&nbsp;
          key=valï¼š<code>page=1&size=10</code> &nbsp;|&nbsp;
          ç´”å­—ç¬¦ä¸²ï¼š<code>ef47c91e-06e7-4311-a0d2-974cbcacbb4f</code>ï¼ˆè¿½åŠ åˆ° URL è·¯å¾‘ï¼‰
        </div>
        <textarea class="form-control ca" id="apiPrm" rows="4" placeholder='{"page":"1","size":"10"}
æˆ–: page=1&size=10
æˆ–: ef47c91e-06e7-4311-a0d2-974cbcacbb4f'></textarea></div>
      <div class="tab-pane fade" id="tB">
        <div class="fst">è«‹æ±‚é«”</div>
        <div id="bodyTypeHint" class="alert alert-info py-1 small mb-2">JSON æ¨¡å¼ï¼šå¡«å¯« JSON å°è±¡ï¼Œè‡ªå‹•åºåˆ—åŒ–ç™¼é€</div>
        <div id="textPlainGuide" style="display:none" class="alert alert-success py-2 small mb-2">
          <strong>âœ… Text/Plain æ¨¡å¼ï¼ˆå°æ‡‰ Python <code>data=xxx</code>ï¼‰ï¼š</strong><br>
          â€¢ Body ç›´æ¥å¡«åŸå§‹å…§å®¹ï¼Œä¾‹å¦‚ï¼š<code>10,5,20,1,33,4</code>ï¼›æ”¯æŒ <code>{{è®Šé‡å}}</code><br>
          â€¢ <strong>éœ€è¦å…ˆåŠ å¯†å†ç™¼é€ï¼Ÿ</strong> åˆ‡æ›åˆ°ã€ŒåŠ å¯† GCMã€Tab â†’ é¸ AES-GCM â†’ å¡« raw å¯†é‘° â†’ å‹¾é¸ã€Œå•Ÿç”¨æ•´é«” Body åŠ å¯†ã€<br>
          â€¢ <span class="fw-bold text-success">å®Œå…¨ä¸éœ€è¦å¡«å­—æ®µå</span>ï¼Œç­‰åƒ¹ï¼š<code>requests.post(url, data=encrypt(body), headers=headers)</code>
        </div>
        <textarea class="form-control ca" id="apiBdy" rows="6" placeholder='{"username":"{{user}}","password":"{{pass}}"}'></textarea>
        <div id="filesHint" style="display:none" class="mt-2 small text-muted"><i class="fas fa-info-circle me-1"></i>æ–‡ä»¶ä¸Šå‚³ï¼šåœ¨JSONä¸­ç”¨ <code>__files__</code> å­—æ®µæŒ‡å®šæ–‡ä»¶åˆ—è¡¨ï¼Œå¦‚ <code>{"__files__":[{"field":"avatar","path":"/tmp/a.jpg"}],"name":"test"}</code></div>
      </div>
      <div class="tab-pane fade" id="tEx">
        <div class="fst">å¾éŸ¿æ‡‰æå–è®Šé‡</div>
        <p class="text-muted small mb-2">è·¯å¾‘ï¼š<code>data.token</code> / <code>data.list[0].id</code></p>
        <div id="exRules"></div>
        <button class="btn btn-sm btn-outline-success" onclick="addEx()"><i class="fas fa-plus me-1"></i>æ·»åŠ æå–è¦å‰‡</button>
      </div>
      <div class="tab-pane fade" id="tAs">
        <div class="fst">HTTP æ–·è¨€è¦å‰‡</div><div id="asRules"></div>
        <button class="btn btn-sm btn-outline-primary" onclick="addAs()"><i class="fas fa-plus me-1"></i>æ·»åŠ æ–·è¨€</button>
      </div>
      <div class="tab-pane fade" id="tDD">
        <div class="fst">DeepDiff æ·±åº¦æ¯”å°æ–·è¨€ <span class="dt">DD</span></div>
        <p class="text-muted small mb-2">ä½¿ç”¨ <code>deepdiff</code> åº«å°éŸ¿æ‡‰é«”æ·±åº¦æ¯”å°ï¼Œæ”¯æŒå¿½ç•¥ç‰¹å®šå­—æ®µï¼ˆå¦‚ timestamp/id ç­‰ï¼‰</p>
        <div id="ddRules"></div>
        <button class="btn btn-sm btn-outline-primary" onclick="addDD()"><i class="fas fa-plus me-1"></i>æ·»åŠ DeepDiffæ–·è¨€</button>
      </div>
      <div class="tab-pane fade" id="tDA">
        <div class="fst">æ•¸æ“šåº«æ–·è¨€ <span class="dt">DB</span></div>
        <p class="text-muted small mb-2">æ”¯æŒ<strong>å¤šå­—æ®µæ–·è¨€</strong>ï¼šæ¯æ¢è¦å‰‡å¯å°æŸ¥è©¢çµæœçš„å¤šå€‹å­—æ®µåŒæ™‚åšæ–·è¨€ã€‚æ”¯æŒ {{è®Šé‡å}} æ›¿æ› SQL ä¸­çš„åƒæ•¸ã€‚</p>
        <div id="daRules"></div>
        <button class="btn btn-sm btn-outline-primary" onclick="addDa()"><i class="fas fa-plus me-1"></i>æ·»åŠ DBæ–·è¨€</button>
      </div>
      <div class="tab-pane fade" id="tSql">
        <div class="fst">å‰ç½® SQLï¼ˆHTTP è«‹æ±‚å‰åŸ·è¡Œï¼‰</div>
        <div class="row g-2 mb-3"><div class="col-md-5"><select class="form-select" id="apiPreDb"><option value="">ä¸ä½¿ç”¨</option></select></div>
          <div class="col-12"><textarea class="form-control ca" id="apiPreSql" rows="3" placeholder="DELETE FROM temp WHERE user_id={{user_id}};"></textarea></div></div>
        <div class="fst">å¾Œç½® SQLï¼ˆHTTP è«‹æ±‚å¾ŒåŸ·è¡Œï¼‰</div>
        <div class="row g-2"><div class="col-md-5"><select class="form-select" id="apiPostDb"><option value="">ä¸ä½¿ç”¨</option></select></div>
          <div class="col-12"><textarea class="form-control ca" id="apiPostSql" rows="3" placeholder="UPDATE orders SET status='done' WHERE id={{order_id}};"></textarea></div></div>
      </div>
      <div class="tab-pane fade" id="tRedis">
        <div class="fst">å‰ç½® Redis å–å€¼ <small class="text-muted fw-normal">â€” è«‹æ±‚å‰å¾ Redis è®€å– keyï¼Œæ³¨å…¥ç‚º {{è®Šé‡å}} ä¾› Body/Headers/Params ä½¿ç”¨</small></div>
        <div class="alert alert-info py-2 small mb-2">
          <strong>å…¸å‹å ´æ™¯ï¼š</strong>é©—è­‰ç¢¼å­˜åœ¨ Redisï¼Œè®€å‡ºå¾Œå¡«å…¥è«‹æ±‚é«”<br>
          Key æ”¯æŒ <code>{{è®Šé‡å}}</code>ï¼Œå¦‚ <code>sms:{{mobile}}</code>ï¼›value æ˜¯ JSON æ™‚å¯æŒ‡å®šæå–å­—æ®µ
        </div>
        <div id="preRedisRules"></div>
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="addPreRedis()">
          <i class="fas fa-plus me-1"></i>æ·»åŠ  Redis å–å€¼è¦å‰‡
        </button>
      </div>
      <div class="tab-pane fade" id="tSsl">
        <div class="fst">SSL / HTTPS é©—è­‰è¨­ç½®</div>
        <div class="mb-3">
          <label class="form-label">SSL é©—è­‰æ¨¡å¼</label>
          <select class="form-select" id="apiSslVerify" onchange="togSslCert()">
            <option value="true">âœ… é©—è­‰ SSL è­‰æ›¸ï¼ˆé»˜èªï¼Œå®‰å…¨ï¼‰</option>
            <option value="false">âš ï¸ è·³é SSL é©—è­‰ï¼ˆå¿½ç•¥è‡ªç°½å / å…§ç¶²è­‰æ›¸ï¼‰</option>
            <option value="custom">ğŸ“ ä½¿ç”¨è‡ªå®šç¾© CA è­‰æ›¸</option>
          </select>
          <div class="form-text text-warning" id="sslWarnText" style="display:none">
            <i class="fas fa-exclamation-triangle me-1"></i>è·³é SSL é©—è­‰å­˜åœ¨å®‰å…¨é¢¨éšªï¼Œåƒ…å»ºè­°åœ¨å…§ç¶²æ¸¬è©¦ç’°å¢ƒä½¿ç”¨ã€‚
          </div>
        </div>
        <div id="sslCertSection" style="display:none">
          <div class="fst mb-2">è‡ªå®šç¾© CA è­‰æ›¸ <small class="text-muted fw-normal">ï¼ˆæ”¯æŒ .pem / .crt / .cerï¼Œå–®é¸ï¼‰</small></div>

          <!-- è­‰æ›¸åˆ—è¡¨ï¼šRadio å–®é¸ -->
          <div class="border rounded mb-2" id="sslCertListWrap" style="max-height:180px;overflow-y:auto;background:#fafafa">
            <div id="sslCertItems" style="padding:4px 2px">
              <div class="text-center text-muted py-2 small">åŠ è¼‰ä¸­...</div>
            </div>
          </div>

          <!-- ç•¶å‰é¸ä¸­è·¯å¾‘ï¼ˆéš±è—ï¼Œä¾›å¾Œç«¯ä¿å­˜ç”¨ï¼‰ -->
          <input type="hidden" id="apiSslCertPath" value="">

          <!-- é¸ä¸­ç‹€æ…‹å±•ç¤º + ä¸Šå‚³/åˆ·æ–° -->
          <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
            <div class="flex-fill small text-truncate" id="sslSelectedLabel"
                 style="color:#6366f1;min-width:0;font-family:monospace">
              <i class="fas fa-shield-alt me-1 text-muted"></i>æœªé¸æ“‡è­‰æ›¸
            </div>
            <label class="btn btn-sm btn-outline-primary mb-0 flex-shrink-0" for="sslCertFile">
              <i class="fas fa-upload me-1"></i>ä¸Šå‚³
            </label>
            <input type="file" id="sslCertFile" accept=".pem,.crt,.cer,.ca-bundle" style="display:none" onchange="uploadSslCert(this)">
            <button class="btn btn-sm btn-outline-secondary flex-shrink-0" onclick="loadSslCerts()">
              <i class="fas fa-sync fa-xs"></i>
            </button>
          </div>
          <div id="sslUploadStatus" class="small text-muted" style="min-height:18px"></div>
        </div>

        <!-- â”€â”€ mTLS å®¢æˆ¶ç«¯è­‰æ›¸å€å¡Š â”€â”€ -->
        <hr class="my-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <div class="fst mb-0">å®¢æˆ¶ç«¯è­‰æ›¸ <span class="badge bg-warning text-dark ms-1" style="font-size:.6rem">mTLS</span></div>
          <div class="form-check form-switch ms-auto mb-0">
            <input class="form-check-input" type="checkbox" id="apiClientCertEnabled" onchange="togMtls()">
            <label class="form-check-label small" for="apiClientCertEnabled">å•Ÿç”¨é›™å‘èªè­‰</label>
          </div>
        </div>
        <div class="text-muted small mb-2">æœå‹™ç«¯è¦æ±‚é©—è­‰å®¢æˆ¶ç«¯èº«ä»½æ™‚ä½¿ç”¨ã€‚éœ€æä¾›å®¢æˆ¶ç«¯è­‰æ›¸å’Œç§é‘°ã€‚</div>
        <div id="mtlsSection" style="display:none">
          <!-- å®¢æˆ¶ç«¯è­‰æ›¸ -->
          <div class="border rounded p-2 mb-2" style="background:#fafff9">
            <div class="d-flex align-items-center gap-2 mb-1">
              <span class="small fw-bold text-success"><i class="fas fa-id-card me-1"></i>å®¢æˆ¶ç«¯è­‰æ›¸ (.pem/.crt)</span>
              <label class="btn btn-outline-success btn-sm mb-0 ms-auto py-0" for="mtlsCertFile">
                <i class="fas fa-upload fa-xs me-1"></i>ä¸Šå‚³
              </label>
              <input type="file" id="mtlsCertFile" accept=".pem,.crt,.cer" style="display:none" onchange="uploadClientFile(this,'cert')">
              <button class="btn btn-outline-secondary btn-sm py-0" onclick="loadClientCerts('cert')"><i class="fas fa-sync fa-xs"></i></button>
            </div>
            <div id="mtlsCertItems" class="border rounded" style="max-height:120px;overflow-y:auto;background:#fff;min-height:32px">
              <div class="text-center text-muted py-1 small">æš«ç„¡è­‰æ›¸</div>
            </div>
            <input type="hidden" id="apiClientCertPath" value="">
            <div class="small text-muted mt-1" id="mtlsCertLabel"><i class="fas fa-circle-notch text-muted me-1"></i>æœªé¸æ“‡</div>
          </div>
          <!-- å®¢æˆ¶ç«¯ç§é‘° -->
          <div class="border rounded p-2 mb-2" style="background:#fffaf9">
            <div class="d-flex align-items-center gap-2 mb-1">
              <span class="small fw-bold text-danger"><i class="fas fa-key me-1"></i>å®¢æˆ¶ç«¯ç§é‘° (.pem/.key)</span>
              <label class="btn btn-outline-danger btn-sm mb-0 ms-auto py-0" for="mtlsKeyFile">
                <i class="fas fa-upload fa-xs me-1"></i>ä¸Šå‚³
              </label>
              <input type="file" id="mtlsKeyFile" accept=".pem,.key,.p8" style="display:none" onchange="uploadClientFile(this,'key')">
              <button class="btn btn-outline-secondary btn-sm py-0" onclick="loadClientCerts('key')"><i class="fas fa-sync fa-xs"></i></button>
            </div>
            <div id="mtlsKeyItems" class="border rounded" style="max-height:120px;overflow-y:auto;background:#fff;min-height:32px">
              <div class="text-center text-muted py-1 small">æš«ç„¡ç§é‘°</div>
            </div>
            <input type="hidden" id="apiClientKeyPath" value="">
            <div class="small text-muted mt-1" id="mtlsKeyLabel"><i class="fas fa-circle-notch text-muted me-1"></i>æœªé¸æ“‡</div>
          </div>
          <div class="form-text text-info">
            <i class="fas fa-info-circle me-1"></i>è‹¥è­‰æ›¸å’Œç§é‘°åˆä½µåœ¨åŒä¸€ .pem æ–‡ä»¶ï¼Œåªéœ€ä¸Šå‚³ä¸¦é¸ä¸­è­‰æ›¸ï¼Œç§é‘°ç•™ç©ºã€‚
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="tEnc">
        <div class="fst">åŠ å¯†è¨­ç½®</div>
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <label class="form-label">åŠ å¯†ç®—æ³•</label>
            <select class="form-select" id="apiEncAlgo" onchange="togEncMode()">
              <option value="">ä¸ä½¿ç”¨åŠ å¯†</option>
              <option value="AES-GCM">AES-GCMï¼ˆæ¨è–¦ï¼‰</option>
              <option value="AES">AES-CBC</option>
              <option value="BASE64">BASE64</option>
              <option value="MD5">MD5</option>
            </select>
          </div>
          <div class="col-md-8">
            <label class="form-label">å…¨å±€å¯†é‘° raw <small class="text-muted">ï¼ˆBodyå­—æ®µåŠ å¯†çš„é»˜èªå¯†é‘°ï¼Œå¦‚ DLMwO2OmfYnEfo7sï¼‰</small></label>
            <input type="text" class="form-control ca" id="apiEncKey" placeholder="DLMwO2OmfYnEfo7s">
          </div>
        </div>
        <!-- å…¨å±€ Body åŠ å¯† -->
        <div id="globalEncSec" style="display:none">
          <div class="enc mb-3">
            <div class="form-check mb-1">
              <input class="form-check-input" type="checkbox" id="apiEnc">
              <label class="form-check-label" for="apiEnc">
                <strong>å•Ÿç”¨æ•´é«” Body åŠ å¯†</strong>
              </label>
            </div>
            <div class="mt-1 ps-4 small text-muted">
              å°‡æ•´å€‹ body <code>json.dumps</code> å¾ŒåŠ å¯†ï¼Œç™¼é€æ–¹å¼ç”± <strong>Body é¡å‹</strong> æ±ºå®šï¼š<br>
              â€¢ <strong>Text/Plain</strong> â†’ <code>requests.post(url, data=encrypt(payload), headers={"Content-Type":"text/plain"})</code><br>
              â€¢ <strong>JSON</strong> â†’ åŠ å¯†çµæœåŒ…è£æˆ <code>{"encrypted":"..."}</code><br>
              <span class="text-success">ğŸ’¡ <strong>data= è£¸å­—ç¬¦ä¸²</strong>å ´æ™¯ï¼šBody é¡å‹é¸ <strong>Text/Plain</strong> + å‹¾é¸æ­¤é …å³å¯ï¼Œ<strong>ç„¡éœ€å¡«å­—æ®µå</strong></span>
            </div>
          </div>
        </div>
        <!-- Body å­—æ®µç´š AES-GCM åŠ å¯†è¦å‰‡ -->
        <div id="fieldEncSec" style="display:none">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fst mb-0">Body å­—æ®µç´šåŠ å¯†è¦å‰‡ <span class="badge bg-danger ms-1">AES-GCM</span></div>
            <button class="btn btn-sm btn-outline-danger" onclick="addEncRule()"><i class="fas fa-plus me-1"></i>æ·»åŠ å­—æ®µè¦å‰‡</button>
          </div>
          <div class="alert alert-info py-2 mb-2 small">
            <strong>ä½¿ç”¨å ´æ™¯ï¼š</strong>
            <code>{"param": encrypt(json.dumps(payload)), "url": encrypt("user/loginAndRegister")}</code><br>
            ssrc æ”¯æŒ <code>{{è®Šé‡å}}</code> å¼•ç”¨ï¼›json_dumps=é–‹å•Ÿæ™‚å…ˆå°å€¼åš json.dumps å†åŠ å¯†ï¼›raw ç•™ç©ºå‰‡ä½¿ç”¨å…¨å±€å¯†é‘°ã€‚
          </div>
          <div id="encRules"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button>
    <button class="btn btn-info btn-sm" onclick="saveRunApi()"><i class="fas fa-play me-1"></i>ä¿å­˜ä¸¦åŸ·è¡Œ</button>
    <button class="btn btn-primary btn-sm" onclick="saveApi()"><i class="fas fa-save me-1"></i>ä¿å­˜</button>
  </div>
</div></div></div>

<!-- Cat Modal -->
<div class="modal fade" id="catModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="catMT">æ·»åŠ åˆ†é¡</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><input type="hidden" id="catId">
    <div class="mb-2"><label class="form-label">åç¨± *</label><input type="text" class="form-control" id="catName"></div>
    <div class="mb-2"><label class="form-label">æè¿°</label><input type="text" class="form-control" id="catDesc"></div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary btn-sm" onclick="saveCat()">ä¿å­˜</button></div>
</div></div></div>

<!-- DynVar Modal -->
<div class="modal fade" id="dynVarModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="dynVarMT">æ·»åŠ å‹•æ…‹è®Šé‡</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><input type="hidden" id="dynVarId">
    <div class="mb-2"><label class="form-label">è®Šé‡å * <small class="text-muted">ï¼ˆç”¨ {{è®Šé‡å}} å¼•ç”¨ï¼‰</small></label>
      <input type="text" class="form-control" id="dynVarName" placeholder="mobile / ts / uid"></div>
    <div class="mb-2"><label class="form-label">é¡å‹ *</label>
      <select class="form-select" id="dynVarType">
        <option value="phone">ğŸ‡¨ğŸ‡³ éš¨æ©Ÿä¸­åœ‹æ‰‹æ©Ÿè™Ÿ</option>
        <option value="timestamp">â± ç•¶å‰æ™‚é–“æˆ³ï¼ˆç§’ï¼‰</option>
        <option value="timestamp_ms">â± ç•¶å‰æ™‚é–“æˆ³ï¼ˆæ¯«ç§’ï¼‰</option>
        <option value="datetime">ğŸ“… ç•¶å‰æ—¥æœŸæ™‚é–“ï¼ˆyyyy-MM-dd HH:mm:ssï¼‰</option>
        <option value="date">ğŸ“… ç•¶å‰æ—¥æœŸï¼ˆyyyy-MM-ddï¼‰</option>
        <option value="uuid">ğŸ”‘ éš¨æ©Ÿ UUID</option>
      </select></div>
    <div class="mb-2"><label class="form-label">å‚™è¨»</label>
      <input type="text" class="form-control" id="dynVarDesc" placeholder="ç”¨é€”èªªæ˜"></div>
    <div class="form-check form-switch mb-2">
      <input class="form-check-input" type="checkbox" id="dynVarEnabled" checked>
      <label class="form-check-label">å•Ÿç”¨ï¼ˆæ¯æ¬¡è«‹æ±‚å‰è‡ªå‹•ç”Ÿæˆï¼‰</label>
    </div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-warning btn-sm" onclick="saveDynVar()">ä¿å­˜</button></div>
</div></div></div>

<!-- Var Modal -->
<div class="modal fade" id="varModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="varMT">æ·»åŠ è®Šé‡</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><input type="hidden" id="varId">
    <div class="mb-2"><label class="form-label">è®Šé‡å *</label><input type="text" class="form-control" id="varName" placeholder="token / captcha"></div>
    <div class="mb-2"><label class="form-label">é¡å‹</label><select class="form-select" id="varType"><option value="string">å­—ç¬¦ä¸²</option><option value="token">Token</option><option value="json">JSON</option></select></div>
    <div class="mb-2"><label class="form-label">å€¼ *</label><textarea class="form-control ca" id="varVal" rows="3"></textarea></div>
    <div class="mb-2"><label class="form-label">æè¿°</label><input type="text" class="form-control" id="varDesc"></div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary btn-sm" onclick="saveVar()">ä¿å­˜</button></div>
</div></div></div>

<!-- Token Modal -->
<div class="modal fade" id="tokModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">ç”Ÿæˆ Token</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <div class="mb-2"><label class="form-label">ä¿å­˜ç‚ºè®Šé‡å</label><input type="text" class="form-control" id="tokVar" value="token"></div>
    <div class="mb-2"><label class="form-label">Token é¡å‹</label><select class="form-select" id="tokType" onchange="togTokCustom()"><option value="uuid">UUID</option><option value="hex32">HEX32</option><option value="hex64">HEX64</option><option value="urlsafe">URLSafe Base64</option><option value="custom">è‡ªå®šç¾©</option></select></div>
    <div id="tokCustom" style="display:none" class="mb-2"><label class="form-label">è‡ªå®šç¾©å€¼</label><input type="text" class="form-control" id="tokCustomVal"></div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-warning btn-sm" onclick="genToken()"><i class="fas fa-magic me-1"></i>ç”Ÿæˆä¸¦ä¿å­˜</button></div>
</div></div></div>

<!-- DB Modal -->
<div class="modal fade" id="dbModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="dbMT">MySQL é…ç½®</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><input type="hidden" id="dbId">
    <div class="row g-2">
      <div class="col-12"><label class="form-label">é…ç½®åç¨± *</label><input type="text" class="form-control" id="dbName"></div>
      <div class="col-md-8"><label class="form-label">ä¸»æ©Ÿ</label><input type="text" class="form-control" id="dbHost" value="127.0.0.1"></div>
      <div class="col-md-4"><label class="form-label">ç«¯å£</label><input type="number" class="form-control" id="dbPort" value="3306"></div>
      <div class="col-md-6"><label class="form-label">ç”¨æˆ¶å *</label><input type="text" class="form-control" id="dbUser"></div>
      <div class="col-md-6"><label class="form-label">å¯†ç¢¼</label><input type="password" class="form-control" id="dbPwd" placeholder="ç•™ç©ºä¸ä¿®æ”¹"></div>
      <div class="col-md-8"><label class="form-label">æ•¸æ“šåº«å *</label><input type="text" class="form-control" id="dbDb"></div>
      <div class="col-md-4"><label class="form-label">å­—ç¬¦é›†</label><input type="text" class="form-control" id="dbCharset" value="utf8mb4"></div>
      <div class="col-12"><label class="form-label">æè¿°</label><input type="text" class="form-control" id="dbDesc"></div>
    </div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary btn-sm" onclick="saveDb()">ä¿å­˜</button></div>
</div></div></div>

<!-- Redis Modal -->
<div class="modal fade" id="redisModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="redisMT">Redis é…ç½®</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><input type="hidden" id="redisId">
    <div class="row g-2">
      <div class="col-12"><label class="form-label">é…ç½®åç¨± *</label><input type="text" class="form-control" id="redisName"></div>
      <div class="col-md-8"><label class="form-label">ä¸»æ©Ÿ</label><input type="text" class="form-control" id="redisHost" value="127.0.0.1"></div>
      <div class="col-md-4"><label class="form-label">ç«¯å£</label><input type="number" class="form-control" id="redisPort" value="6379"></div>
      <div class="col-md-8"><label class="form-label">å¯†ç¢¼ï¼ˆç„¡å¯†ç¢¼ç•™ç©ºï¼‰</label><input type="password" class="form-control" id="redisPwd"></div>
      <div class="col-md-4"><label class="form-label">DB ç´¢å¼• (0-15)</label><input type="number" class="form-control" id="redisDb" value="0" min="0" max="15"></div>
      <div class="col-12"><label class="form-label">æè¿°</label><input type="text" class="form-control" id="redisDesc"></div>
    </div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary btn-sm" onclick="saveRedis()">ä¿å­˜</button></div>
</div></div></div>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="emailMT">éƒµä»¶é…ç½® (SMTP)</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><input type="hidden" id="emailId">
    <div class="row g-2">
      <div class="col-12"><label class="form-label">é…ç½®åç¨±</label><input type="text" class="form-control" id="emailName" value="é»˜èªéƒµä»¶é…ç½®"></div>
      <div class="col-md-8"><label class="form-label">SMTP ä¸»æ©Ÿ</label><input type="text" class="form-control" id="emailSmtpHost" placeholder="smtp.163.com"></div>
      <div class="col-md-4"><label class="form-label">ç«¯å£</label><input type="number" class="form-control" id="emailSmtpPort" value="465"></div>
      <div class="col-md-6"><div class="form-check mt-3"><input class="form-check-input" type="checkbox" id="emailSsl" checked><label class="form-check-label" for="emailSsl">ä½¿ç”¨ SSL (ç«¯å£465)</label></div></div>
      <div class="col-md-6"><div class="form-check mt-3"><input class="form-check-input" type="checkbox" id="emailTls"><label class="form-check-label" for="emailTls">ä½¿ç”¨ TLS/STARTTLS (ç«¯å£587)</label></div></div>
      <div class="col-md-6"><label class="form-label">éƒµç®±è³¬è™Ÿ *</label><input type="text" class="form-control" id="emailUser"></div>
      <div class="col-md-6"><label class="form-label">å¯†ç¢¼/æˆæ¬Šç¢¼ *</label><input type="password" class="form-control" id="emailPwd"></div>
      <div class="col-md-8"><label class="form-label">ç™¼ä»¶äººåœ°å€</label><input type="text" class="form-control" id="emailFrom"></div>
      <div class="col-md-4"><label class="form-label">ç™¼ä»¶äººåç¨±</label><input type="text" class="form-control" id="emailFromName" value="APIæ¸¬è©¦å¹³å°"></div>
      <div class="col-12"><div class="form-check"><input class="form-check-input" type="checkbox" id="emailActive" checked><label class="form-check-label" for="emailActive">å•Ÿç”¨æ­¤é…ç½®ï¼ˆåŒæ™‚åªä¸€å€‹ç”Ÿæ•ˆï¼‰</label></div></div>
    </div>
    <div class="mt-2 p-2 bg-light rounded small text-muted">å¸¸ç”¨SMTPï¼š163=smtp.163.com:465(SSL) Â· QQ=smtp.qq.com:465(SSL) Â· Gmail=smtp.gmail.com:587(TLS)</div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button>
    <button class="btn btn-outline-warning btn-sm" onclick="testEmailSend()"><i class="fas fa-paper-plane me-1"></i>ç™¼é€æ¸¬è©¦éƒµä»¶</button>
    <button class="btn btn-primary btn-sm" onclick="saveEmail()">ä¿å­˜</button>
  </div>
</div></div></div>

<!-- Task Modal -->
<div class="modal fade" id="taskModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="taskMT">æ–°å»ºå®šæ™‚ä»»å‹™</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><input type="hidden" id="taskId">
    <div class="row g-2">
      <div class="col-md-8"><label class="form-label">ä»»å‹™åç¨± *</label><input type="text" class="form-control" id="taskName"></div>
      <div class="col-md-4"><label class="form-label">ç‹€æ…‹</label><select class="form-select" id="taskStatus"><option value="active">é‹è¡Œä¸­</option><option value="paused">æš«åœ</option></select></div>
      <div class="col-md-4"><label class="form-label">è§¸ç™¼æ–¹å¼</label>
        <select class="form-select" id="taskTrigger" onchange="togTaskTrigger()"><option value="cron">Cron è¡¨é”å¼</option><option value="interval">å›ºå®šé–“éš”</option></select></div>
      <div class="col-md-8" id="taskCronWrap">
        <label class="form-label">Cron è¡¨é”å¼ <small class="text-muted">åˆ† æ™‚ æ—¥ æœˆ é€±</small></label>
        <input type="text" class="form-control ca" id="taskCron" value="0 9 * * *">
        <div class="cronhelp mt-1"><code>0 9 * * 1-5</code> é€±ä¸€è‡³äº” Â· <code>*/30 * * * *</code> æ¯30åˆ†é˜ Â· <code>0 0 * * *</code> æ¯å¤©å‡Œæ™¨</div>
      </div>
      <div class="col-md-8" id="taskIntervalWrap" style="display:none">
        <label class="form-label">é–“éš”ç§’æ•¸ <small class="text-muted">(æœ€å°60ç§’)</small></label>
        <input type="number" class="form-control" id="taskInterval" value="3600" min="60"></div>
      <div class="col-12"><label class="form-label">é¸æ“‡åŸ·è¡Œæ¥å£</label>
        <div class="asl" id="taskApiList" style="max-height:200px">åŠ è¼‰ä¸­...</div></div>
      <div class="col-12"><label class="form-label">å ±å‘Šåç¨±æ¨¡æ¿ <small class="text-muted">({task}=ä»»å‹™å {time}=æ™‚é–“)</small></label>
        <input type="text" class="form-control" id="taskRptTpl" value="å®šæ™‚ä»»å‹™-{task}"></div>
      <div class="col-12">
        <div class="form-check mb-1"><input class="form-check-input" type="checkbox" id="taskSendEmail"><label class="form-check-label" for="taskSendEmail">åŸ·è¡Œå®Œæˆå¾Œç™¼é€éƒµä»¶å ±å‘Š</label></div>
        <input type="text" class="form-control" id="taskEmailTo" placeholder="æ”¶ä»¶äººï¼Œå¤šå€‹ç”¨é€—è™Ÿåˆ†éš”"></div>
      <div class="col-12"><label class="form-label">æè¿°</label><input type="text" class="form-control" id="taskDesc"></div>
    </div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary btn-sm" onclick="saveTask()">ä¿å­˜</button></div>
</div></div></div>

<!-- Report Detail Modal -->
<div class="modal fade" id="rptModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="rptMT">æ¸¬è©¦å ±å‘Š</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body" id="rptBody"><div class="text-center py-4"><div class="spinner-border text-primary"></div></div></div>
</div></div></div>

<!-- Single Run Modal -->
<div class="modal fade" id="runModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">å–®æ¥å£åŸ·è¡Œçµæœ</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body" id="runBody"></div>
</div></div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•
const S = {apiPg:1, varPg:1, rptPg:1, curCat:'', cats:[], dbs:[], redis:[],
           lstTaskId:null, lstPollTimer:null};
const SQL_TPL = {
  select:'SELECT * FROM table_name LIMIT 10;',
  count:'SELECT count(*) as total FROM table_name;',
  delete:'DELETE FROM table_name WHERE id=1;',
  truncate:'TRUNCATE TABLE table_name;',
  tables:'SHOW TABLES;',
  desc:'DESCRIBE table_name;'
};

// â•â•â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•â•â•
const $ = id => document.getElementById(id);
function toast(msg, t='success') {
  const e = document.createElement('div');
  e.className = 'tm ' + t;
  const ic = {success:'check-circle', danger:'times-circle', warning:'exclamation-triangle'}[t] || 'info-circle';
  e.innerHTML = '<i class="fas fa-' + ic + '"></i> ' + msg;
  $('tc').appendChild(e);
  setTimeout(() => e.remove(), 3500);
}
function load(show, t='åŸ·è¡Œä¸­...') { $('lov').style.display = show ? 'flex' : 'none'; $('lt').textContent = t; }
async function R(method, url, body=null) {
  const o = {method, credentials:'same-origin', headers:{'Content-Type':'application/json'}};
  if (body) o.body = JSON.stringify(body);
  try {
    const res = await fetch(url, o);
    const data = await res.json();
    // Session éæœŸæˆ–æœªç™»éŒ„ï¼šå…¨å±€è·³è½‰åˆ°ç™»éŒ„é 
    if (data.code === 401 && !url.includes('/auth/')) {
      window.location.href = '/login';
      return data;
    }
    return data;
  } catch(err) {
    return {code: -1, message: 'ç¶²çµ¡éŒ¯èª¤: ' + err.message, data: null};
  }
}
let _debTimer = null;
function debLoad(fn, ms) { clearTimeout(_debTimer); _debTimer = setTimeout(fn, ms); }
function eh(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function esc(s) { return (s||'').replace(/'/g,"\\'"); }
function jhl(s) {
  return eh(s)
    .replace(/"([^"]+)":/g,'<span class="rk">"$1":</span>')
    .replace(/: "([^"]*)"/g,': <span class="rvs">"$1"</span>')
    .replace(/: (\d+\.?\d*)/g,': <span class="rvn">$1</span>')
    .replace(/: (true|false)/g,': <span class="rvb">$1</span>');
}
function hl(str) {
  if (!str) return '<span class="text-muted">(ç©º)</span>';
  try { return jhl(JSON.stringify(JSON.parse(str), null, 2)); } catch(e) { return eh(str); }
}
function pgRender(cid, p, tp, fn) {
  const e = $(cid); if (!e) return;
  let h = '';
  if (p > 1) h += '<li class="page-item"><a class="page-link" onclick="'+fn+'('+(p-1)+')">â€¹</a></li>';
  const s = Math.max(1, p-2), ed = Math.min(tp, p+2);
  if (s > 1) h += '<li class="page-item"><a class="page-link" onclick="'+fn+'(1)">1</a></li>' + (s>2?'<li class="page-item disabled"><a class="page-link">â€¦</a></li>':'');
  for (let i=s; i<=ed; i++) h += '<li class="page-item '+(i===p?'active':'')+'"><a class="page-link" onclick="'+fn+'('+i+')">'+i+'</a></li>';
  if (ed < tp) h += (ed<tp-1?'<li class="page-item disabled"><a class="page-link">â€¦</a></li>':'') + '<li class="page-item"><a class="page-link" onclick="'+fn+'('+tp+')">'+tp+'</a></li>';
  if (p < tp) h += '<li class="page-item"><a class="page-link" onclick="'+fn+'('+(p+1)+')">â€º</a></li>';
  e.innerHTML = h;
}

// â•â•â•â•â•â•â•â•â•â• NAVIGATION â•â•â•â•â•â•â•â•â•â•
function go(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(b => b.classList.remove('active'));
  const pg = $('page-' + name);
  if (pg) pg.classList.add('active');
  document.querySelectorAll('.nb[data-page="' + name + '"]').forEach(b => b.classList.add('active'));
  const map = {
    accounts: loadAccs,
    dashboard: loadDash,
    apis: () => { loadCats(); loadApis(); },
    categories: loadCats,
    variables: () => { loadVars(); loadDynVars(); },
    databases: loadDbs,
    redis: loadRedis,
    redis_tool: loadRdTool,
    email: loadEmails,
    scheduler: () => { loadTasks(); loadTaskApis(); },
    runner: () => { loadCats(); loadRnrApis(); },
    locust: loadLocustApis,
    sql_tool: loadSqlDbs,
    reports: loadRpts
  };
  map[name] && map[name]();
}
document.querySelectorAll('.nb[data-page]').forEach(b => {
  b.addEventListener('click', () => go(b.dataset.page));
});

// â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•
async function loadDash() {
  const [ar, dr, rr, tr, vr, rpr] = await Promise.all([
    R('GET','/api/apis/?page=1&page_size=1'),
    R('GET','/api/db/configs/'),
    R('GET','/api/redis/configs/'),
    R('GET','/api/scheduler/tasks/'),
    R('GET','/api/variables/?page=1&page_size=1'),
    R('GET','/api/reports/?page=1&page_size=5')
  ]);
  $('s-api').textContent = ar.data?.total || 0;
  $('s-db').textContent = dr.data?.length || 0;
  $('s-redis').textContent = rr.data?.length || 0;
  $('s-task').textContent = tr.data?.length || 0;
  $('s-var').textContent = vr.data?.total || 0;
  $('s-rpt').textContent = rpr.data?.total || 0;
  const tb = $('dashRpt');
  if (!rpr.data?.items?.length) { tb.innerHTML='<tr><td colspan="5" class="text-center text-muted py-3">æš«ç„¡å ±å‘Š</td></tr>'; return; }
  tb.innerHTML = rpr.data.items.map(r =>
    '<tr><td>' + r.name + '</td><td><div class="rbar mb-1"><div class="rp" style="width:'+r.pass_rate+'%"></div></div><small>'+r.pass_rate+'%</small></td><td><span class="text-success">'+r.passed+'</span>/<span class="text-danger">'+r.failed+'</span>/<span class="text-warning">'+r.error+'</span></td><td><small class="text-muted">'+r.created_at+'</small></td><td><button class="btn btn-outline-primary" style="font-size:.72rem;padding:2px 7px" onclick="showRpt('+r.id+')">æŸ¥çœ‹</button></td></tr>'
  ).join('');
}

// â•â•â•â•â•â•â•â•â•â• CATEGORIES â•â•â•â•â•â•â•â•â•â•
async function loadCats() {
  const r = await R('GET','/api/categories/');
  if (r.code !== 0) return;
  S.cats = r.data || [];
  // Pills
  const pills = $('catPills');
  if (pills) {
    pills.innerHTML = '<div class="pp' + (!S.curCat?' active':'') + '" onclick="fCat(\'\')">å…¨éƒ¨</div>' +
      S.cats.map(c => '<div class="pp' + (S.curCat==c.id?' active':'') + '" onclick="fCat('+c.id+')">' + c.name + ' <span class="badge bg-secondary">'+c.api_count+'</span></div>').join('');
  }
  // Category selects
  ['apiCat','rnrCat'].forEach(sid => {
    const s = $(sid); if (!s) return;
    const pf = sid === 'rnrCat' ? '<option value="">å…¨éƒ¨åˆ†é¡</option>' : '<option value="">æœªåˆ†é¡</option>';
    s.innerHTML = pf + S.cats.map(c => '<option value="'+c.id+'">'+c.name+'</option>').join('');
  });
  // Task api list cat filter
  const rc = $('rnrCat');
  if (rc) rc.innerHTML = '<option value="">å…¨éƒ¨åˆ†é¡</option>' + S.cats.map(c => '<option value="'+c.id+'">'+c.name+'</option>').join('');
  // Cat cards page
  const cc = $('catCards');
  if (cc) {
    if (!r.data?.length) { cc.innerHTML='<div class="col-12 text-center text-muted py-4">æš«ç„¡åˆ†é¡ï¼Œé»æ“Šå³ä¸Šè§’æ·»åŠ </div>'; return; }
    cc.innerHTML = r.data.map(c =>
      '<div class="col-md-4 col-lg-3"><div class="card text-center p-3"><div style="font-size:1.7rem;color:var(--pr)"><i class="fas fa-folder"></i></div><div class="fw-bold mt-2">'+c.name+'</div><div class="text-muted small">'+eh(c.description||'')+'</div><div class="badge bg-primary mt-1">'+c.api_count+' å€‹æ¥å£</div><div class="d-flex justify-content-center gap-2 mt-3"><button class="btn btn-sm btn-outline-primary" onclick="editCat('+c.id+',\''+esc(c.name)+'\',\''+esc(c.description||'')+'\')">ç·¨è¼¯</button><button class="btn btn-sm btn-outline-danger" onclick="delCat('+c.id+')">åˆªé™¤</button></div></div></div>'
    ).join('');
  }
}
function fCat(id) {
  S.curCat = id; S.apiPg = 1;
  document.querySelectorAll('#catPills .pp').forEach(p => {
    const onclick = p.getAttribute('onclick') || '';
    p.classList.toggle('active', id ? onclick.includes('('+id+')') : onclick.includes("('')"));
  });
  loadApis();
}
function openCatModal(id, n, d) {
  $('catId').value = id || ''; $('catName').value = n || ''; $('catDesc').value = d || '';
  $('catMT').textContent = id ? 'ç·¨è¼¯åˆ†é¡' : 'æ·»åŠ åˆ†é¡';
  bootstrap.Modal.getOrCreateInstance($('catModal')).show();
}
function editCat(id, n, d) { openCatModal(id, n, d); }
async function saveCat() {
  const id = $('catId').value, name = $('catName').value.trim();
  if (!name) { toast('è«‹å¡«å¯«åç¨±','warning'); return; }
  const r = id ? await R('PUT','/api/categories/'+id+'/',{name, description:$('catDesc').value})
              : await R('POST','/api/categories/',{name, description:$('catDesc').value});
  r.code === 0 ? (toast(r.message), bootstrap.Modal.getInstance($('catModal'))?.hide(), loadCats()) : toast(r.message,'danger');
}
async function delCat(id) {
  if (!confirm('ç¢ºèªåˆªé™¤åˆ†é¡ï¼Ÿ')) return;
  const r = await R('DELETE','/api/categories/'+id+'/');
  r.code === 0 ? (toast('åˆªé™¤æˆåŠŸ'), loadCats()) : toast(r.message,'danger');
}

// â•â•â•â•â•â•â•â•â•â• APIS â•â•â•â•â•â•â•â•â•â•
async function loadApis(p) {
  if (p) S.apiPg = p;
  const kw = $('apiSrc')?.value || '', mth = $('mthF')?.value || '';
  let url = '/api/apis/?page='+S.apiPg+'&page_size=10&keyword='+encodeURIComponent(kw)+'&method='+mth;
  if (S.curCat) url += '&category_id=' + S.curCat;
  const r = await R('GET', url); if (r.code !== 0) return;
  const {items, total, pages, page:cur} = r.data;
  const tb = $('apiTb');
  if (!items.length) { tb.innerHTML='<tr><td colspan="8" class="text-center text-muted py-4">æš«ç„¡æ¥å£</td></tr>'; $('apiTot').textContent='å…± 0 æ¢'; $('apiPg').innerHTML=''; return; }
  tb.innerHTML = items.map(a =>
    '<tr><td><input type="checkbox" class="api-cb form-check-input" value="'+a.id+'"></td>' +
    '<td><strong>'+eh(a.name)+'</strong></td>' +
    '<td><span class="badge bg-light text-secondary">'+eh(a.category_name)+'</span></td>' +
    '<td><span class="bm '+a.method.toLowerCase()+'">'+a.method+'</span></td>' +
    '<td class="text-muted" style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+eh(a.url)+'">'+eh(a.url)+'</td>' +
    '<td>'+(a.encrypted?'<span class="badge bg-warning text-dark"><i class="fas fa-lock"></i></span>':'')+' '+(a.use_async?'<span class="at2">async</span>':'')+' '+(a.use_session?'<span class="badge bg-info">session</span>':'')+'</td>' +
    '<td class="text-muted small">'+a.updated_at+'</td>' +
    '<td>' +
    '<button class="btn bi btn-outline-success btn-sm me-1" onclick="run1('+a.id+')" title="åŸ·è¡Œ"><i class="fas fa-play fa-xs"></i></button>' +
    '<button class="btn bi btn-outline-primary btn-sm me-1" onclick="editApi('+a.id+')" title="ç·¨è¼¯"><i class="fas fa-edit fa-xs"></i></button>' +
    '<button class="btn bi btn-outline-danger btn-sm" onclick="delApi('+a.id+')" title="åˆªé™¤"><i class="fas fa-trash fa-xs"></i></button>' +
    '</td></tr>'
  ).join('');
  $('apiTot').textContent = 'å…± ' + total + ' æ¢';
  pgRender('apiPg', cur, pages, 'loadApis');
  $('selAll').checked = false;
}
function togSelAll(cb) { document.querySelectorAll('.api-cb').forEach(c => c.checked = cb.checked); }
function getSelIds() { return [...document.querySelectorAll('.api-cb:checked')].map(c => +c.value); }
async function runSel() {
  const ids = getSelIds(); if (!ids.length) { toast('è«‹å…ˆé¸æ“‡æ¥å£','warning'); return; }
  S.rnrSel = new Set(ids); go('runner'); await loadRnrApis(); updRnrBadges();
}
async function delSel() {
  const ids = getSelIds(); if (!ids.length) { toast('è«‹å…ˆé¸æ“‡','warning'); return; }
  if (!confirm('ç¢ºèªåˆªé™¤ '+ids.length+' å€‹æ¥å£ï¼Ÿ')) return;
  await Promise.all(ids.map(id => R('DELETE','/api/apis/'+id+'/')));
  toast('å·²åˆªé™¤ '+ids.length+' å€‹'); loadApis();
}
async function delApi(id) {
  if (!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return;
  const r = await R('DELETE','/api/apis/'+id+'/');
  r.code === 0 ? (toast('åˆªé™¤æˆåŠŸ'), loadApis()) : toast(r.message,'danger');
}

// â•â•â•â•â•â•â•â•â•â• API MODAL â•â•â•â•â•â•â•â•â•â•
function fillDbSelects() {
  const dbOpts = '<option value="">ä¸ä½¿ç”¨</option>' + S.dbs.map(d => '<option value="'+d.id+'">'+d.name+'</option>').join('');
  ['apiPreDb','apiPostDb'].forEach(sid => { const s=$(sid); if(s) s.innerHTML = dbOpts; });
}
function openApiModal() {
  clearApiForm(); $('apiMT').textContent='æ·»åŠ æ¥å£';
  fillCatSelApi(); fillDbSelects();
  bootstrap.Modal.getOrCreateInstance($('apiModal')).show();
}
function clearApiForm() {
  ['apiId','apiName','apiUrl','apiDesc','apiHdr','apiPrm','apiBdy','apiEncKey','apiPreSql','apiPostSql'].forEach(id => { const e=$(id); if(e) e.value=''; });
  $('apiMth').value='POST'; $('apiBodyType').value='json'; $('apiCat').value='';
  $('apiSort').value='0'; $('apiTimeout').value='30';
  $('apiAsync').checked=false; $('apiSession').checked=false; $('apiEnc').checked=false;
  $('apiEncAlgo').value=''; $('apiEncKey').value='';
  const sv = $('apiSslVerify'); if(sv) sv.value='true';
  const sc = $('apiSslCertPath'); if(sc) sc.value='';
  if (typeof _updateSslSelectedLabel === 'function') _updateSslSelectedLabel('');
  const cce = $('apiClientCertEnabled'); if(cce) cce.checked=false;
  const cc = $('apiClientCertPath'); if(cc) cc.value='';
  const ck = $('apiClientKeyPath'); if(ck) ck.value='';
  _updateMtlsLabel('cert',''); _updateMtlsLabel('key','');
  togSslCert(); togMtls();
  $('globalEncSec').style.display='none'; $('fieldEncSec').style.display='none';
  $('encRules').innerHTML='';
  $('exRules').innerHTML=''; $('asRules').innerHTML='';
  $('ddRules').innerHTML=''; $('daRules').innerHTML=''; $('apiPreDb').value=''; $('apiPostDb').value='';
  $('preRedisRules').innerHTML='';
  togApiBody(); updBodyTypeHint();
}
function fillCatSelApi() {
  const s = $('apiCat'); if (!s) return;
  const cur = s.value;
  s.innerHTML = '<option value="">æœªåˆ†é¡</option>' + S.cats.map(c => '<option value="'+c.id+'"'+(c.id==cur?' selected':'')+'>'+c.name+'</option>').join('');
}
async function editApi(id) {
  clearApiForm();
  const r = await R('GET','/api/apis/'+id+'/'); if (r.code !== 0) { toast(r.message,'danger'); return; }
  const a = r.data;

  // â‘  å…ˆå¡«å……ä¸‹æ‹‰é¸é …ï¼ˆå¿…é ˆåœ¨è¨­ç½® .value ä¹‹å‰ï¼Œå¦å‰‡ä¸å­˜åœ¨çš„é¸é …å€¼æœƒè¢«ç€è¦½å™¨é‡ç½®ç‚º ''ï¼‰
  fillCatSelApi(); fillDbSelects();

  // â‘¡ å†è¨­ç½®å„å­—æ®µå€¼
  $('apiId').value=a.id; $('apiName').value=a.name; $('apiUrl').value=a.url;
  $('apiMth').value=a.method; $('apiBodyType').value=a.body_type||'json';
  $('apiCat').value=a.category_id||'';           // åˆ†é¡ï¼ˆoptions å·²å­˜åœ¨ï¼Œvalue èƒ½æ­£ç¢ºé¸ä¸­ï¼‰
  $('apiSort').value=a.sort_order; $('apiTimeout').value=a.timeout||30;
  $('apiDesc').value=a.description;
  $('apiHdr').value=a.headers||'{}';
  $('apiPrm').value=a.params||'{}';
  $('apiBdy').value=a.body||'{}';
  $('apiAsync').checked=a.use_async; $('apiSession').checked=a.use_session;
  $('apiEnc').checked=a.encrypted;
  $('apiEncAlgo').value=a.encryption_algorithm||'';
  const sv = $('apiSslVerify'); if(sv) sv.value = a.ssl_verify||'true';
  const sc = $('apiSslCertPath'); if(sc) sc.value = a.ssl_cert||'';
  if (typeof _updateSslSelectedLabel === 'function') _updateSslSelectedLabel(a.ssl_cert||'');
  togSslCert();
  // mTLS å®¢æˆ¶ç«¯è­‰æ›¸
  const cce = $('apiClientCertEnabled'); if(cce) cce.checked = !!a.client_cert_enabled;
  const cc = $('apiClientCertPath'); if(cc) cc.value = a.client_cert||'';
  const ck = $('apiClientKeyPath'); if(ck) ck.value = a.client_key||'';
  _updateMtlsLabel('cert', a.client_cert||'');
  _updateMtlsLabel('key', a.client_key||'');
  togMtls();
  $('apiEncKey').value=a.encryption_key||'';
  togEncMode();
  $('apiPreSql').value=a.pre_sql||''; $('apiPostSql').value=a.post_sql||'';
  if (a.pre_sql_db_id) $('apiPreDb').value=a.pre_sql_db_id;
  if (a.post_sql_db_id) $('apiPostDb').value=a.post_sql_db_id;

  // â‘¢ å‹•æ…‹è¦å‰‡
  try { JSON.parse(a.extract_vars||'[]').forEach(x => addEx(x.name, x.path)); } catch(e){}
  try { JSON.parse(a.assertions||'[]').forEach(x => addAs(x.type, x.expected, x.path)); } catch(e){}
  try { JSON.parse(a.deepdiff_assertions||'[]').forEach(x => addDD(x.label, x.expected, x.ignore_fields?.join(','), x.check_path)); } catch(e){}
  try { JSON.parse(a.db_assertions||'[]').forEach(x => addDa(x)); } catch(e){}
  try { JSON.parse(a.body_enc_rules||'[]').forEach(x => addEncRule(x)); } catch(e){}
  try { JSON.parse(a.pre_redis_rules||'[]').forEach(x => addPreRedis(x)); } catch(e){}

  // â‘£ æœ€å¾Œæ›´æ–° UI ç‹€æ…‹å¾Œé–‹å•Ÿ Modal
  $('apiMT').textContent='ç·¨è¼¯æ¥å£'; togApiBody(); updBodyTypeHint();
  bootstrap.Modal.getOrCreateInstance($('apiModal')).show();
}
function togApiBody() {
  const mth = $('apiMth').value;
  // HEAD/OPTIONS é€šå¸¸ç„¡ Request Bodyï¼ˆHTTP è¦ç¯„ï¼‰
  const noBody = ['HEAD', 'OPTIONS'].includes(mth);
  const isPost = ['POST','PUT','PATCH','DELETE'].includes(mth);
  $('tBli').style.display  = (isPost && !noBody) ? '' : 'none';
  $('ctWrap').style.display = (isPost && !noBody) ? '' : 'none';
  // HEAD/OPTIONS é¡¯ç¤ºæç¤º
  let hint = $('noBodyHint');
  if (!hint && noBody) {
    hint = document.createElement('div');
    hint.id = 'noBodyHint';
    hint.className = 'text-muted small mt-1';
    hint.innerHTML = '<i class="fas fa-info-circle me-1"></i>' + mth + ' æ–¹æ³•é€šå¸¸ç„¡ Request Body';
    $('tBli')?.parentNode?.insertBefore(hint, $('tBli'));
  } else if (hint) {
    hint.style.display = noBody ? '' : 'none';
    if (noBody) hint.innerHTML = '<i class="fas fa-info-circle me-1"></i>' + mth + ' æ–¹æ³•é€šå¸¸ç„¡ Request Body';
  }
}
function updBodyTypeHint() {
  const bt = $('apiBodyType')?.value || 'json';
  const hints = {
    json:   'JSON â†’ requests.post(url, json=body) â”‚ åŠ å¯†æ¨¡å¼ï¼šåŒ…è£æˆ {"encrypted":"..."}',
    data:   'âœ… Data â†’ requests.post(url, data=body) â”‚ åŸå§‹å­—ç¬¦ä¸²/dict â”‚ åŠ å¯†å¾Œç›´æ¥ data=encrypted_str ç™¼é€',
    params: 'Params â†’ requests.post(url, params=body) â”‚ Body å…§å®¹è¿½åŠ åˆ° URL query string',
    form:   'Form â†’ requests.post(url, data=body) â”‚ form-urlencoded æ ¼å¼',
    raw:    'âœ… Raw â†’ requests.post(url, data=str) â”‚ json.dumps å¾Œç™¼é€ â”‚ åŠ å¯†å¾Œç›´æ¥ data=encrypted_str',
    text:   'âœ… Text/Plain â†’ requests.post(url, data=str, headers={"Content-Type":"text/plain"}) â”‚ åŠ å¯†å¾Œç›´æ¥ data=encrypted_str',
    files:  'Files â†’ requests.post(url, files=...) â”‚ ç”¨ __files__ å­—æ®µæŒ‡å®šæ–‡ä»¶'
  };
  const hint = $('bodyTypeHint');
  const tpg  = $('textPlainGuide');
  const fh   = $('filesHint');
  const ta   = $('apiBdy');
  const isRaw = bt === 'text' || bt === 'data';

  if (hint) {
    hint.style.display = isRaw ? 'none' : '';
    if (!isRaw) hint.textContent = hints[bt] || '';
  }
  if (tpg) {
    tpg.style.display = isRaw ? '' : 'none';
    // Update guide text based on mode
    const tpgTitle = tpg.querySelector('strong');
    if (tpgTitle) {
      if (bt === 'text') tpgTitle.innerHTML = 'âœ… Text/Plain æ¨¡å¼ï¼ˆ<code>data=raw_string</code>ï¼‰ï¼š';
      else if (bt === 'data') tpgTitle.innerHTML = 'âœ… Data æ¨¡å¼ï¼ˆ<code>data=body</code>ï¼‰ï¼š';
    }
  }
  if (fh)  fh.style.display  = bt === 'files' ? '' : 'none';
  if (ta) {
    const placeholders = {
      json:   '{"username":"{{user}}","password":"{{pass}}"}',
      data:   '{"key":"value"}\næˆ–åŸå§‹å­—ç¬¦ä¸²ï¼š10,5,20,1,33,4',
      params: '{"page":"1","size":"10","keyword":"{{search}}"}',
      form:   '{"username":"{{user}}","password":"{{pass}}"}',
      raw:    '{"key":"value"} æˆ–ä»»æ„å­—ç¬¦ä¸²',
      text:   '10,5,20,1,33,4\nï¼ˆç›´æ¥å¡«è¦ç™¼é€çš„å…§å®¹ï¼‰',
      files:  '{"__files__":[{"field":"file","path":"/tmp/a.jpg"}],"extra_field":"val"}'
    };
    ta.placeholder = placeholders[bt] || '';
  }
}
// â•â•â•â•â•â•â•â•â•â• SSL é©—è­‰ â•â•â•â•â•â•â•â•â•â•
function togSslCert() {
  const v = $('apiSslVerify')?.value;
  const sec = $('sslCertSection');
  const warn = $('sslWarnText');
  if (sec) sec.style.display = v === 'custom' ? '' : 'none';
  if (warn) warn.style.display = v === 'false' ? '' : 'none';
  if (v === 'custom') loadSslCerts();
}

async function loadSslCerts() {
  const r = await R('GET', '/api/ssl/certs/');
  if (r.code !== 0) return;
  const items = r.data.items || [];
  const wrap = $('sslCertItems');
  if (!wrap) return;

  if (!items.length) {
    wrap.innerHTML = '<div class="text-center text-muted py-3 small"><i class="fas fa-folder-open me-1"></i>æš«ç„¡è­‰æ›¸ï¼Œè«‹ä¸Šå‚³</div>';
    _updateSslSelectedLabel('');
    return;
  }

  let curPath = $('apiSslCertPath')?.value || '';

  // â”€â”€ é»˜èªé¸æœ€æ–°ï¼šcurPath ç‚ºç©ºæ™‚è‡ªå‹•é¸ç¬¬ä¸€æ¢ï¼ˆå¾Œç«¯å·²æŒ‰ mtime é™åºï¼‰â”€â”€
  if (!curPath && items.length > 0) {
    curPath = items[0].path;
    const p = $('apiSslCertPath'); if (p) p.value = curPath;
  }

  const fmtSize = b => b < 1024 ? b + 'B' : (b / 1024).toFixed(1) + 'KB';
  const fmtTime = ts => {
    if (!ts) return '';
    const d = new Date(ts * 1000);
    return d.toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
  };

  wrap.innerHTML = items.map((c, idx) => {
    const sel = c.path === curPath;
    return (
      '<div class="ssl-cert-item' + (sel ? ' selected' : '') + '" id="ssl-row-' + idx + '">' +
        '<input class="ssl-cert-radio" type="radio" name="sslCertRadio" ' +
          'id="ssl-radio-' + idx + '" value="' + eh(c.path) + '" ' +
          (sel ? 'checked' : '') +
          ' onchange="onSslRadioChange(this,\'' + eh(c.filename) + '\')">' +
        '<label class="ssl-cert-name" for="ssl-radio-' + idx + '" title="' + eh(c.path) + '">' +
          (idx === 0 ? '<span class="badge bg-success me-1" style="font-size:.58rem;vertical-align:middle">æœ€æ–°</span>' : '') +
          eh(c.filename) +
        '</label>' +
        '<span class="ssl-cert-size text-muted">' + fmtSize(c.size) +
          (c.mtime ? ' Â· ' + fmtTime(c.mtime) : '') +
        '</span>' +
        '<button class="ssl-cert-del" onclick="deleteSslCert(\'' + eh(c.filename) + '\',\'' + eh(c.path) + '\')" title="åˆªé™¤">' +
          '<i class="fas fa-trash fa-xs"></i>' +
        '</button>' +
      '</div>'
    );
  }).join('');

  _updateSslSelectedLabel(curPath, items);
}

// Radio åˆ‡æ›ï¼šç´” DOM æ“ä½œï¼Œä¸éœ€è¦é‡æ–°è«‹æ±‚æ¥å£
function onSslRadioChange(radio, filename) {
  const path = radio.value;
  const p = $('apiSslCertPath'); if (p) p.value = path;
  // æ›´æ–°æ‰€æœ‰è¡Œé«˜äº®ï¼ˆä¿è­‰åªæœ‰ä¸€è¡Œé¸ä¸­ï¼‰
  document.querySelectorAll('.ssl-cert-item').forEach(row => {
    const rb = row.querySelector('input[type="radio"]');
    if (rb) row.classList.toggle('selected', rb.checked);
  });
  _updateSslSelectedLabel(path, null, filename);
}

function _updateSslSelectedLabel(path, items, filename) {
  const lbl = $('sslSelectedLabel'); if (!lbl) return;
  if (!path) {
    lbl.innerHTML = '<i class="fas fa-shield-alt me-1 text-muted"></i>æœªé¸æ“‡è­‰æ›¸';
    return;
  }
  let name = filename;
  if (!name && items) {
    const found = items.find(c => c.path === path);
    name = found ? found.filename : path.split('/').pop();
  }
  if (!name) name = path.split('/').pop() || path;
  lbl.innerHTML = '<i class="fas fa-check-circle me-1 text-success"></i>' +
    '<span title="' + eh(path) + '">' + eh(name) + '</span>';
}

// æ•´è¡Œé»æ“Šè§¸ç™¼ï¼ˆlabel å·²è™•ç†å¤§éƒ¨åˆ†ï¼Œé€™è£¡å‚™ç”¨æ–¼è¡Œé»æ“Šï¼‰
function selectSslCert(path, filename) {
  const p = $('apiSslCertPath'); if (p) p.value = path;
  document.querySelectorAll('input[name="sslCertRadio"]').forEach(rb => {
    rb.checked = (rb.value === path);
    rb.closest('.ssl-cert-item')?.classList.toggle('selected', rb.checked);
  });
  _updateSslSelectedLabel(path, null, filename);
}

async function deleteSslCert(filename, path) {
  if (!confirm('ç¢ºèªåˆªé™¤è­‰æ›¸ã€Œ' + filename + 'ã€ï¼Ÿ\n\nå·²ä½¿ç”¨æ­¤è­‰æ›¸çš„æ¥å£éœ€è¦é‡æ–°é¸æ“‡ã€‚')) return;
  const r = await R('DELETE', '/api/ssl/cert/delete/', { filename });
  if (r.code === 0) {
    toast('è­‰æ›¸å·²åˆªé™¤');
    const p = $('apiSslCertPath');
    if (p && p.value === path) {
      p.value = '';
      _updateSslSelectedLabel('');
    }
    await loadSslCerts();
  } else {
    toast(r.message, 'danger');
  }
}

async function uploadSslCert(input) {
  const f = input.files[0]; if (!f) return;
  const status = $('sslUploadStatus');
  if (status) status.textContent = 'ä¸Šå‚³ä¸­...';
  const fd = new FormData();
  fd.append('cert', f);
  try {
    const res = await fetch('/api/ssl/cert/upload/', { method: 'POST', body: fd, credentials: 'same-origin' });
    const data = await res.json();
    if (data.code === 0) {
      toast('è­‰æ›¸ä¸Šå‚³æˆåŠŸï¼š' + data.data.filename);
      if (status) status.textContent = 'âœ“ ' + data.data.filename;
      // è‡ªå‹•é¸ä¸­å‰›ä¸Šå‚³çš„è­‰æ›¸
      const p = $('apiSslCertPath'); if (p) p.value = data.data.path;
      await loadSslCerts();
    } else {
      toast(data.message, 'danger');
      if (status) status.textContent = 'âœ— ä¸Šå‚³å¤±æ•—';
    }
  } catch(err) {
    toast('ä¸Šå‚³å¤±æ•—: ' + err.message, 'danger');
    if (status) status.textContent = 'âœ— ç¶²çµ¡éŒ¯èª¤';
  }
  input.value = '';
}

// â•â•â•â•â•â•â•â•â•â• mTLS å®¢æˆ¶ç«¯è­‰æ›¸ â•â•â•â•â•â•â•â•â•â•
function togMtls() {
  const enabled = !!$('apiClientCertEnabled')?.checked;
  const sec = $('mtlsSection');
  if (sec) {
    sec.style.display = enabled ? '' : 'none';
    if (enabled) {
      loadClientCerts('cert');
      loadClientCerts('key');
    }
  }
}

async function loadClientCerts(kind) {
  // kind: 'cert' | 'key'
  const r = await R('GET', '/api/ssl/client-certs/');
  if (r.code !== 0) return;
  const items = (kind === 'cert' ? r.data.certs : r.data.keys) || [];
  const container = $(kind === 'cert' ? 'mtlsCertItems' : 'mtlsKeyItems');
  if (!container) return;

  const curPath = $(kind === 'cert' ? 'apiClientCertPath' : 'apiClientKeyPath')?.value || '';

  let autoPath = curPath;
  if (!autoPath && items.length > 0) {
    autoPath = items[0].path;
    const inp = $(kind === 'cert' ? 'apiClientCertPath' : 'apiClientKeyPath');
    if (inp) inp.value = autoPath;
    _updateMtlsLabel(kind, autoPath, items);
  }

  if (!items.length) {
    container.innerHTML = '<div class="text-center text-muted py-1 small">æš«ç„¡æ–‡ä»¶</div>';
    return;
  }

  const fmtTime = ts => {
    if (!ts) return '';
    const d = new Date(ts * 1000);
    return d.toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
  };
  const fmtSize = b => b < 1024 ? b+'B' : (b/1024).toFixed(1)+'KB';

  container.innerHTML = items.map((c, idx) => {
    const sel = c.path === autoPath;
    const radioName = `mtls${kind}Radio`;
    return (
      '<div class="d-flex align-items-center gap-1 px-2 py-1' + (sel ? ' bg-light-success' : '') +
      '" style="' + (sel ? 'background:#f0fff4;' : '') + 'cursor:pointer" onclick="selectMtlsFile(\'' +
      eh(c.path) + '\',\'' + kind + '\',\'' + eh(c.filename) + '\')">' +
        '<input type="radio" name="' + radioName + '" value="' + eh(c.path) + '"' +
          (sel ? ' checked' : '') +
          ' onchange="selectMtlsFile(\'' + eh(c.path) + '\',\'' + kind + '\',\'' + eh(c.filename) + '\')"' +
          ' onclick="event.stopPropagation()">' +
        '<span class="small flex-fill text-truncate" style="font-family:monospace;font-size:.75rem" title="' + eh(c.path) + '">' +
          (idx === 0 ? '<span class="badge bg-success me-1" style="font-size:.55rem">æœ€æ–°</span>' : '') +
          eh(c.filename) +
        '</span>' +
        '<span class="text-muted" style="font-size:.7rem;white-space:nowrap">' + fmtSize(c.size) + ' ' + fmtTime(c.mtime) + '</span>' +
        '<button class="btn btn-outline-danger btn-sm bi py-0" style="font-size:.65rem" ' +
          'onclick="event.stopPropagation();deleteClientFile(\'' + eh(c.filename) + '\',\'' + kind + '\',\'' + eh(c.path) + '\')" title="åˆªé™¤">' +
          '<i class="fas fa-trash fa-xs"></i>' +
        '</button>' +
      '</div>'
    );
  }).join('');

  _updateMtlsLabel(kind, autoPath, items);
}

function selectMtlsFile(path, kind, filename) {
  const inp = $(kind === 'cert' ? 'apiClientCertPath' : 'apiClientKeyPath');
  if (inp) inp.value = path;
  document.querySelectorAll(`input[name="mtls${kind}Radio"]`).forEach(rb => {
    rb.checked = (rb.value === path);
  });
  _updateMtlsLabel(kind, path, null, filename);
}

function _updateMtlsLabel(kind, path, items, filename) {
  const lbl = $(kind === 'cert' ? 'mtlsCertLabel' : 'mtlsKeyLabel');
  if (!lbl) return;
  if (!path) {
    lbl.innerHTML = '<i class="fas fa-circle-notch text-muted me-1"></i>æœªé¸æ“‡';
    return;
  }
  let name = filename;
  if (!name && items) {
    const found = items.find(c => c.path === path);
    name = found ? found.filename : path.split('/').pop();
  }
  if (!name) name = path.split('/').pop() || path;
  const icon = kind === 'cert' ? 'fas fa-id-card text-success' : 'fas fa-key text-danger';
  lbl.innerHTML = '<i class="' + icon + ' me-1"></i><span title="' + eh(path) + '">' + eh(name) + '</span>';
}

async function uploadClientFile(input, kind) {
  const f = input.files[0]; if (!f) return;
  const fd = new FormData();
  fd.append('file', f);
  fd.append('type', kind);
  try {
    const res = await fetch('/api/ssl/client-cert/upload/', {method:'POST', body:fd, credentials:'same-origin'});
    const data = await res.json();
    if (data.code === 0) {
      toast(data.message || 'ä¸Šå‚³æˆåŠŸ');
      const inp = $(kind === 'cert' ? 'apiClientCertPath' : 'apiClientKeyPath');
      if (inp) inp.value = data.data.path;
      await loadClientCerts(kind);
    } else {
      toast(data.message, 'danger');
    }
  } catch(err) {
    toast('ä¸Šå‚³å¤±æ•—: ' + err.message, 'danger');
  }
  input.value = '';
}

async function deleteClientFile(filename, kind, path) {
  const label = kind === 'cert' ? 'å®¢æˆ¶ç«¯è­‰æ›¸' : 'ç§é‘°';
  if (!confirm(`ç¢ºèªåˆªé™¤${label}ã€Œ${filename}ã€ï¼Ÿ`)) return;
  const r = await R('DELETE', '/api/ssl/client-cert/delete/', {filename, type: kind});
  if (r.code === 0) {
    toast(r.message || 'å·²åˆªé™¤');
    const inp = $(kind === 'cert' ? 'apiClientCertPath' : 'apiClientKeyPath');
    if (inp && inp.value === path) {
      inp.value = '';
      _updateMtlsLabel(kind, '');
    }
    await loadClientCerts(kind);
  } else {
    toast(r.message, 'danger');
  }
}

function togEncMode() {
  const algo = $('apiEncAlgo')?.value || '';
  // æ‰€æœ‰ç®—æ³•éƒ½é¡¯ç¤ºæ•´é«”åŠ å¯†é¸é …
  $('globalEncSec').style.display = algo ? '' : 'none';
  // å­—æ®µç´šåŠ å¯†åªå° AES-GCM é¡¯ç¤º
  $('fieldEncSec').style.display  = algo === 'AES-GCM' ? '' : 'none';
  if (!algo) $('apiEnc').checked = false;
}
function togEnc() { togEncMode(); }

// â•â•â•â•â•â•â•â•â•â• å‰ç½® Redis å–å€¼ â•â•â•â•â•â•â•â•â•â•
function addPreRedis(rule) {
  const redisId      = rule?.redis_id      || '';
  const key          = rule?.key           || '';
  const varName      = rule?.var_name      || '';
  const extractField = rule?.extract_field || '';

  // Build Redis select options from S.redis
  const redisOpts = (S.redis||[]).map(r =>
    '<option value="'+r.id+'"'+(r.id==redisId?' selected':'')+'>'+eh(r.name)+'</option>'
  ).join('');

  const d = document.createElement('div');
  d.className = 'card mb-2 p-2 pre-redis-rule';
  d.innerHTML =
    '<div class="d-flex justify-content-between align-items-center mb-2">' +
      '<span class="badge bg-danger">Redis å–å€¼</span>' +
      '<button class="btn btn-xs btn-outline-danger btn-sm py-0" onclick="this.closest(\'.pre-redis-rule\').remove()"><i class="fas fa-times fa-xs"></i></button>' +
    '</div>' +
    '<div class="row g-2">' +
      '<div class="col-md-4">' +
        '<label class="form-label" style="font-size:.75rem">Redis é€£æ¥</label>' +
        '<select class="form-select form-select-sm rr-redis"><option value="">è«‹é¸æ“‡</option>' + redisOpts + '</select>' +
      '</div>' +
      '<div class="col-md-8">' +
        '<label class="form-label" style="font-size:.75rem">Keyï¼ˆæ”¯æŒ <code>{{è®Šé‡å}}</code>ï¼‰</label>' +
        '<input type="text" class="form-control form-control-sm ca rr-key" value="'+eh(key)+'" placeholder="sms:{{mobile}} æˆ– captcha:{{session_id}}">' +
      '</div>' +
      '<div class="col-md-5">' +
        '<label class="form-label" style="font-size:.75rem">å­˜å…¥è®Šé‡å <code>{{captcha}}</code></label>' +
        '<input type="text" class="form-control form-control-sm ca rr-var" value="'+eh(varName)+'" placeholder="captcha">' +
      '</div>' +
      '<div class="col-md-7">' +
        '<label class="form-label" style="font-size:.75rem">æå–å­—æ®µï¼ˆå€¼ç‚º JSON æ™‚ç”¨ï¼Œå¦‚ <code>code</code>ï¼Œç•™ç©ºå–æ•´å€‹å€¼ï¼‰</label>' +
        '<input type="text" class="form-control form-control-sm ca rr-field" value="'+eh(extractField)+'" placeholder="codeï¼ˆç•™ç©ºå‰‡å–æ•´å€‹ valueï¼‰">' +
      '</div>' +
    '</div>';
  $('preRedisRules').appendChild(d);
}

function addEncRule(rule) {
  const field   = rule?.field     || '';
  const ssrc    = rule?.ssrc      || '';
  const raw     = rule?.raw       || '';
  const dumps   = rule?.json_dumps || false;
  const d = document.createElement('div'); d.className='enc-rule mb-2 p-2 border rounded';
  d.innerHTML =
    '<button class="btn bi btn-outline-danger btn-sm float-end" onclick="this.closest(\'.enc-rule\').remove()"><i class="fas fa-times fa-xs"></i></button>' +
    '<div class="row g-1">' +
    '<div class="col-md-3"><label class="form-label" style="font-size:.74rem">ç›®æ¨™å­—æ®µ field</label><input type="text" class="form-control form-control-sm ca er-field" value="'+eh(field)+'" placeholder="param"></div>' +
    '<div class="col-md-5"><label class="form-label" style="font-size:.74rem">ssrc è¦åŠ å¯†çš„å€¼ <small class="text-muted">ï¼ˆæ”¯æŒ{{è®Šé‡å}}ï¼‰</small></label><input type="text" class="form-control form-control-sm ca er-ssrc" value="'+eh(ssrc)+'" placeholder="{{payload}} æˆ– user/loginAndRegister"></div>' +
    '<div class="col-md-4"><label class="form-label" style="font-size:.74rem">raw å¯†é‘°ï¼ˆç•™ç©ºç”¨å…¨å±€ï¼‰</label><input type="text" class="form-control form-control-sm ca er-raw" value="'+eh(raw)+'" placeholder="DLMwO2OmfYnEfo7s"></div>' +
    '<div class="col-12 mt-1"><div class="form-check form-check-inline"><input class="form-check-input er-dumps" type="checkbox"'+(dumps?' checked':'')+'><label class="form-check-label small">json_dumpsï¼ˆå…ˆå° ssrc çš„å€¼ json.dumps å†åŠ å¯†ï¼‰</label></div></div>' +
    '</div>';
  $('encRules').appendChild(d);
}

// Rule builders
function addEx(n='', p='') {
  const d = document.createElement('div'); d.className='er';
  d.innerHTML = '<button class="btn bi btn-outline-danger btn-sm rmb" onclick="this.closest(\'.er\').remove()"><i class="fas fa-times fa-xs"></i></button>' +
    '<div class="row g-1"><div class="col-md-5"><label class="form-label">è®Šé‡å</label><input type="text" class="form-control ex-n" value="'+eh(n)+'" placeholder="token"></div>' +
    '<div class="col-md-7"><label class="form-label">JSONè·¯å¾‘</label><input type="text" class="form-control ex-p" value="'+eh(p)+'" placeholder="data.token"></div></div>';
  $('exRules').appendChild(d);
}
function addAs(type='status_code', exp='200', path='') {
  const d = document.createElement('div'); d.className='ar';
  const needPath = type==='json_path'||type==='not_empty'||type==='regex';
  const noExp = type==='not_empty';
  d.innerHTML = '<button class="btn bi btn-outline-danger btn-sm rmb" onclick="this.closest(\'.ar\').remove()"><i class="fas fa-times fa-xs"></i></button>' +
    '<div class="row g-1"><div class="col-md-4"><label class="form-label">é¡å‹</label><select class="form-select as-t" onchange="updAs(this)">' +
    ['status_code','json_path','contains','not_empty','regex'].map(o => '<option value="'+o+'"'+(o===type?' selected':'')+'>'+{status_code:'ç‹€æ…‹ç¢¼',json_path:'JSONè·¯å¾‘',contains:'åŒ…å«æ–‡æœ¬',not_empty:'ä¸ç‚ºç©º',regex:'æ­£å‰‡åŒ¹é…'}[o]+'</option>').join('') +
    '</select></div>' +
    '<div class="col-md-4 as-pw" style="'+(needPath?'':'display:none')+'"><label class="form-label">JSONè·¯å¾‘</label><input type="text" class="form-control as-p" value="'+eh(path)+'" placeholder="data.code"></div>' +
    '<div class="col-md-4 as-ew" style="'+(noExp?'display:none':'')+'"><label class="form-label">æœŸæœ›å€¼</label><input type="text" class="form-control as-e" value="'+eh(exp)+'" placeholder="200"></div></div>';
  $('asRules').appendChild(d);
}
function updAs(sel) {
  const r=sel.closest('.ar'), t=sel.value;
  r.querySelector('.as-pw').style.display = (t==='json_path'||t==='not_empty'||t==='regex') ? '' : 'none';
  r.querySelector('.as-ew').style.display = t==='not_empty' ? 'none' : '';
}
function addDD(label='éŸ¿æ‡‰é«”å°æ¯”', exp='{}', ignores='', cp='') {
  const d = document.createElement('div'); d.className='ddr';
  d.innerHTML = '<button class="btn bi btn-outline-danger btn-sm rmb" onclick="this.closest(\'.ddr\').remove()"><i class="fas fa-times fa-xs"></i></button>' +
    '<div class="row g-1">' +
    '<div class="col-md-4"><label class="form-label">æ¨™ç±¤</label><input type="text" class="form-control dd-label" value="'+eh(label)+'" placeholder="éŸ¿æ‡‰é«”å°æ¯”"></div>' +
    '<div class="col-md-4"><label class="form-label">JSONè·¯å¾‘ï¼ˆé¸å¡«ï¼‰</label><input type="text" class="form-control dd-cp" value="'+eh(cp)+'" placeholder="data.result"></div>' +
    '<div class="col-md-4"><label class="form-label">å¿½ç•¥å­—æ®µï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label><input type="text" class="form-control dd-ign" value="'+eh(ignores)+'" placeholder="id,created_at,timestamp"></div>' +
    '<div class="col-12"><label class="form-label">æœŸæœ›å€¼ï¼ˆJSONï¼‰</label><textarea class="form-control ca dd-exp" rows="3" placeholder=\'{"code":0,"data":{"name":"test"}}\'>' + eh(typeof exp==='string'?exp:JSON.stringify(exp,null,2)) + '</textarea></div></div>';
  $('ddRules').appendChild(d);
}
function addDa(rule) {
  // rule å¯ä»¥æ˜¯èˆŠæ ¼å¼ {db_id,sql,field,operator,expected,label} æˆ–æ–°æ ¼å¼ {db_id,sql,fields:[...],label}
  const dbid    = rule?.db_id   || '';
  const sql     = rule?.sql     || '';
  const label   = rule?.label   || '';
  const dbOpts  = S.dbs.map(db => '<option value="'+db.id+'"'+(db.id==dbid?' selected':'')+'>'+db.name+'</option>').join('');

  // å…¼å®¹èˆŠæ ¼å¼ï¼šfields æ•¸çµ„
  let fields = [];
  if (rule?.fields && Array.isArray(rule.fields)) {
    fields = rule.fields;
  } else if (rule?.field !== undefined) {
    // èˆŠæ ¼å¼
    fields = [{field: rule.field||'', operator: rule.operator||'==', expected: rule.expected||''}];
  } else {
    fields = [{field:'', operator:'==', expected:''}];
  }

  const d = document.createElement('div'); d.className='dr mb-2';
  d.innerHTML =
    '<button class="btn bi btn-outline-danger btn-sm rmb" onclick="this.closest(\'.dr\').remove()"><i class="fas fa-times fa-xs"></i></button>' +
    '<div class="row g-1 mb-1">' +
    '<div class="col-md-5"><label class="form-label">æ•¸æ“šåº« <span class="dt">DB</span></label><select class="form-select da-db"><option value="">è«‹é¸æ“‡</option>'+dbOpts+'</select></div>' +
    '<div class="col-md-7"><label class="form-label">æè¿°æ¨™ç±¤ï¼ˆå¯é¸ï¼‰</label><input type="text" class="form-control da-label" value="'+eh(label)+'" placeholder="å¦‚ï¼šé©—è­‰ç”¨æˆ¶ç‹€æ…‹"></div>' +
    '<div class="col-12"><label class="form-label">SQLï¼ˆSELECTèªå¥ï¼Œæ”¯æŒ{{è®Šé‡}}ï¼‰</label><input type="text" class="form-control ca da-sql" value="'+eh(sql)+'" placeholder="SELECT name, status, age FROM users WHERE id={{user_id}}"></div>' +
    '</div>' +
    '<div class="da-fields-wrap">' +
    fields.map((f,i) => buildDaField(f.field||'', f.operator||'==', f.expected||'', i===0)).join('') +
    '</div>' +
    '<button class="btn btn-xs btn-outline-secondary mt-1" style="font-size:.73rem;padding:2px 8px" onclick="addDaField(this)"><i class="fas fa-plus me-1"></i>æ·»åŠ å­—æ®µæ–·è¨€</button>';

  $('daRules').appendChild(d);
}

function buildDaField(field, op, exp, isFirst) {
  const ops = ['==','!=','>','<','>=','<=','contains','not_empty'];
  return '<div class="da-field-row d-flex gap-1 align-items-end mt-1">' +
    '<div style="flex:2"><label class="form-label" style="font-size:.72rem">å­—æ®µå</label><input type="text" class="form-control form-control-sm ca da-field-name" value="'+eh(field)+'" placeholder="cnt / name / status"></div>' +
    '<div style="flex:2"><label class="form-label" style="font-size:.72rem">æ¯”è¼ƒç¬¦</label><select class="form-select form-select-sm da-field-op">'+ops.map(o=>'<option'+(o===op?' selected':'')+'>'+o+'</option>').join('')+'</select></div>' +
    '<div style="flex:3"><label class="form-label" style="font-size:.72rem">æœŸæœ›å€¼</label><input type="text" class="form-control form-control-sm da-field-exp" value="'+eh(exp)+'" placeholder="1"></div>' +
    '<div style="padding-bottom:2px">'+(isFirst?'<span style="display:inline-block;width:28px"></span>':'<button class="btn bi btn-outline-danger btn-sm" onclick="this.closest(\'.da-field-row\').remove()"><i class="fas fa-times fa-xs"></i></button>')+'</div>' +
    '</div>';
}

function addDaField(btn) {
  const wrap = btn.previousElementSibling;
  wrap.insertAdjacentHTML('beforeend', buildDaField('','==','',false));
}

function tryJSON(val, fieldName) {
  if (!val || val.trim() === '') return '{}';
  try { JSON.parse(val); return val; }
  catch(e) {
    toast(fieldName + ' ä¸æ˜¯åˆæ³• JSONï¼Œå·²è‡ªå‹•æ¸…ç©ºï¼ˆåŸå€¼ï¼š' + val.substring(0,30) + '...ï¼‰', 'warning');
    return '{}';
  }
}

function colApiData() {
  const exRules = [...$('exRules').querySelectorAll('.er')].map(r=>({name:r.querySelector('.ex-n').value.trim(),path:r.querySelector('.ex-p').value.trim()})).filter(r=>r.name&&r.path);
  const asRules = [...$('asRules').querySelectorAll('.ar')].map(r=>({type:r.querySelector('.as-t').value,expected:r.querySelector('.as-e')?.value||'',path:r.querySelector('.as-p')?.value||''}));
  const ddRules = [...$('ddRules').querySelectorAll('.ddr')].map(r=>({
    label:r.querySelector('.dd-label').value.trim(),
    expected:r.querySelector('.dd-exp').value.trim(),
    ignore_fields:(r.querySelector('.dd-ign').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    check_path:r.querySelector('.dd-cp').value.trim()
  })).filter(r=>r.label);

  // DB assertions â€” multi-field format
  const daRules = [...$('daRules').querySelectorAll('.dr')].map(r => {
    const db_id = r.querySelector('.da-db').value;
    const sql   = r.querySelector('.da-sql').value.trim();
    const label = r.querySelector('.da-label')?.value.trim() || '';
    const fieldRows = [...r.querySelectorAll('.da-field-row')].map(fr=>({
      field:    fr.querySelector('.da-field-name').value.trim(),
      operator: fr.querySelector('.da-field-op').value,
      expected: fr.querySelector('.da-field-exp').value.trim()
    })).filter(fr=>fr.field||fr.expected);
    return {db_id, sql, label, fields: fieldRows};
  }).filter(r=>r.db_id&&r.sql);

  // Body field-level AES-GCM enc rules
  const encRules = [...$('encRules').querySelectorAll('.enc-rule')].map(r=>({
    field:      r.querySelector('.er-field').value.trim(),
    ssrc:       r.querySelector('.er-ssrc').value.trim(),
    raw:        r.querySelector('.er-raw').value.trim(),
    json_dumps: r.querySelector('.er-dumps').checked
  })).filter(r=>r.field&&r.ssrc);

  const algo = $('apiEncAlgo')?.value || '';
  return {
    name:$('apiName').value.trim(), url:$('apiUrl').value.trim(),
    method:$('apiMth').value, body_type:$('apiBodyType').value,
    category_id:$('apiCat').value||null, sort_order:+$('apiSort').value||0,
    timeout:+$('apiTimeout').value||30, description:$('apiDesc').value,
    headers: tryJSON($('apiHdr').value, 'Headers'),
    params:  ($('apiPrm').value||'').trim() || '{}',
    body:    $('apiBdy').value || '{}',
    use_async:$('apiAsync').checked, use_session:$('apiSession').checked,
    encrypted:$('apiEnc').checked,
    encryption_key:$('apiEncKey').value,
    encryption_algorithm: algo || 'AES',
    body_enc_rules: JSON.stringify(encRules),
    extract_vars:JSON.stringify(exRules),
    assertions:JSON.stringify(asRules),
    deepdiff_assertions:JSON.stringify(ddRules),
    db_assertions:JSON.stringify(daRules),
    ssl_verify: $('apiSslVerify')?.value || 'true',
    ssl_cert:   ($('apiSslVerify')?.value === 'custom' ? ($('apiSslCertPath')?.value||'') : ''),
    client_cert_enabled: !!$('apiClientCertEnabled')?.checked,
    client_cert: ($('apiClientCertEnabled')?.checked ? ($('apiClientCertPath')?.value||'') : ''),
    client_key:  ($('apiClientCertEnabled')?.checked ? ($('apiClientKeyPath')?.value||'') : ''),
    pre_sql_db_id:$('apiPreDb').value||null, pre_sql:$('apiPreSql').value,
    post_sql_db_id:$('apiPostDb').value||null, post_sql:$('apiPostSql').value,
    pre_redis_rules: JSON.stringify([...$('preRedisRules').querySelectorAll('.pre-redis-rule')].map(r=>({
      redis_id: +r.querySelector('.rr-redis').value,
      key:      r.querySelector('.rr-key').value.trim(),
      var_name: r.querySelector('.rr-var').value.trim(),
      extract_field: r.querySelector('.rr-field').value.trim()
    })).filter(r=>r.redis_id&&r.key&&r.var_name))
  };
}
async function saveApi() {
  const data = colApiData();
  if (!data.name || !data.url) { toast('è«‹å¡«å¯«åç¨±å’ŒURL','warning'); return; }
  const id = $('apiId').value;
  const r = id ? await R('PUT','/api/apis/'+id+'/',data) : await R('POST','/api/apis/',data);
  if (r.code === 0) {
    toast(r.message);
    bootstrap.Modal.getOrCreateInstance($('apiModal')).hide();
    loadApis();
  } else {
    toast(r.message, 'danger');
  }
}
async function saveRunApi() {
  const data = colApiData();
  if (!data.name || !data.url) { toast('è«‹å¡«å¯«åç¨±å’ŒURL','warning'); return; }
  const id = $('apiId').value;
  let r = id ? await R('PUT','/api/apis/'+id+'/',data) : await R('POST','/api/apis/',data);
  if (r.code !== 0) { toast(r.message,'danger'); return; }
  bootstrap.Modal.getOrCreateInstance($('apiModal')).hide(); loadApis();
  run1(r.data.id);
}
async function run1(id) {
  load(true,'åŸ·è¡Œæ¥å£...');
  const r = await R('POST','/api/apis/'+id+'/run/',{});
  load(false); showRun(r.data);
}
function showRun(data) {
  if (!data) { toast('åŸ·è¡Œå¤±æ•—','danger'); return; }
  const sc = data.status==='pass'?'success':data.status==='fail'?'danger':'warning';
  const hc = data.response_status>=200&&data.response_status<300?'success':'danger';
  let h = '<div class="d-flex gap-2 mb-3 flex-wrap align-items-center">' +
    '<span class="badge bg-'+sc+' fs-6 px-3 py-2">'+(data.status==='pass'?'âœ“ é€šé':data.status==='fail'?'âœ— å¤±æ•—':'âš  éŒ¯èª¤')+'</span>' +
    '<span class="badge bg-'+hc+'">HTTP '+data.response_status+'</span>' +
    '<span class="badge bg-secondary">'+data.response_time+'ms</span>' +
    (data.use_async?'<span class="at2">httpx async</span>':'') +
    (data.use_session?'<span class="badge bg-info">Session</span>':'') + '</div>';
  if (data.enc_applied?.length) {
    h += '<div class="mb-2"><strong>å­—æ®µåŠ å¯† <span class="badge bg-danger">AES-GCM</span>ï¼š</strong> ' +
      data.enc_applied.map(r=>'<code>'+eh(r.field)+'</code>').join(' Â· ') + '</div>';
  }
  if (data.encrypted_body) {
    h += '<div class="mb-2"><strong>å…¨å±€åŠ å¯†ï¼š</strong><code class="small">'+eh(data.encrypted_body.substring(0,60))+'...</code></div>';
  }
  if (data.error_message) h += '<div class="alert alert-danger py-2 small">'+eh(data.error_message)+'</div>';
  if (data.assertion_results?.length) {
    h += '<div class="mb-2"><strong>HTTP æ–·è¨€ï¼š</strong><br>' +
      data.assertion_results.map(a=>'<span class="badge bg-'+(a.passed?'success':'danger')+' d-inline-block me-1 mb-1">'+eh(a.passed?'âœ“':'âœ—')+' '+eh(a.message||'')+'</span>').join('') + '</div>';
  }
  if (data.deepdiff_results?.length) {
    h += '<div class="mb-2"><strong>DeepDiff æ–·è¨€ <span class="dt">DD</span>ï¼š</strong><br>' +
      data.deepdiff_results.map(a=>'<div class="badge bg-'+(a.passed?'success':'danger')+' d-block text-start mb-1">'+eh(a.message||'')+'</div>').join('') + '</div>';
  }
  if (data.db_assertion_results?.length) {
    h += '<div class="mb-2"><strong>DB æ–·è¨€ <span class="dt">DB</span>ï¼š</strong><br>' +
      data.db_assertion_results.map(a => {
        const main = '<span class="badge bg-'+(a.passed?'success':'danger')+' d-block text-start mb-1">'+eh(a.passed?'âœ“':'âœ—')+' '+eh(a.message||'')+'</span>';
        const subs = (a.field_results||[]).length > 1
          ? '<div class="ms-3">' + a.field_results.map(f=>'<span class="badge bg-'+(f.passed?'success':'danger')+' d-inline-block me-1 mb-1 text-start">'+eh(f.message||'')+'</span>').join('') + '</div>'
          : '';
        return main + subs;
      }).join('') + '</div>';
  }
  if (data.pre_redis_log?.length) {
    h += '<div class="mb-2"><strong>å‰ç½® Redis <span class="badge bg-danger" style="font-size:.65rem">RD</span>ï¼š</strong><br>' +
      data.pre_redis_log.map(r =>
        '<span class="badge bg-'+(r.success?'success':'danger')+' d-inline-block me-1 mb-1">' +
        eh(r.success ? 'âœ“ '+r.key+' â†’ {{'+r.var_name+'}}='+r.value : 'âœ— '+r.key+': '+(r.error||'')) +
        '</span>'
      ).join('') + '</div>';
  }
  if (data.pre_sql_result) h += '<div class="mb-2"><strong>å‰ç½®SQLï¼š</strong><div class="sqr mt-1" style="max-height:80px">'+eh(data.pre_sql_result)+'</div></div>';
  if (data.post_sql_result) h += '<div class="mb-2"><strong>å¾Œç½®SQLï¼š</strong><div class="sqr mt-1" style="max-height:80px">'+eh(data.post_sql_result)+'</div></div>';
  if (data.extracted_vars && Object.keys(data.extracted_vars).length) {
    h += '<div class="mb-2"><strong>æå–è®Šé‡ï¼š</strong>' +
      Object.entries(data.extracted_vars).map(([k,v])=>'<code>'+k+'</code>=<span class="text-success">'+eh(String(v))+'</span> ').join('') + '</div>';
  }
  h += '<div><strong>éŸ¿æ‡‰é«”ï¼š</strong><div class="rb mt-1">'+hl(data.response_body)+'</div></div>';
  $('runBody').innerHTML = h;
  bootstrap.Modal.getOrCreateInstance($('runModal')).show();
}

// â•â•â•â•â•â•â•â•â•â• å‹•æ…‹è®Šé‡ â•â•â•â•â•â•â•â•â•â•
async function loadDynVars() {
  const r = await R('GET', '/api/dynamic-vars/');
  if (r.code !== 0) return;
  const items = r.data.items || [];
  const typeColors = {phone:'success',timestamp:'primary',timestamp_ms:'primary',datetime:'info',date:'info',uuid:'secondary'};
  $('dynVarTb').innerHTML = items.length ? items.map(v =>
    '<tr>' +
    '<td><div class="form-check form-switch mb-0"><input class="form-check-input" type="checkbox" '+(v.enabled?'checked':'')+
      ' onchange="toggleDynVar('+v.id+',this)"></div></td>' +
    '<td><code class="text-warning">{{'+eh(v.name)+'}}</code></td>' +
    '<td><span class="badge bg-'+( typeColors[v.dyn_type]||'secondary')+'" style="font-size:.72rem">'+eh(v.type_label)+'</span></td>' +
    '<td class="text-muted small font-monospace">'+eh(v.preview)+'</td>' +
    '<td class="text-muted small">'+eh(v.description||'-')+'</td>' +
    '<td><button class="btn bi btn-outline-primary btn-sm me-1" onclick="editDynVar('+v.id+')" title="ç·¨è¼¯"><i class="fas fa-edit fa-xs"></i></button>' +
    '<button class="btn bi btn-outline-danger btn-sm" onclick="delDynVar('+v.id+')" title="åˆªé™¤"><i class="fas fa-trash fa-xs"></i></button></td>' +
    '</tr>'
  ).join('') : '<tr><td colspan="6" class="text-center text-muted py-3">æš«ç„¡å‹•æ…‹è®Šé‡ï¼Œé»æ“Šã€Œæ·»åŠ å‹•æ…‹è®Šé‡ã€å‰µå»º</td></tr>';
}
function openDynVarModal() {
  ['dynVarId','dynVarName','dynVarDesc'].forEach(id=>{ const e=$(id); if(e) e.value=''; });
  $('dynVarType').value='phone'; $('dynVarEnabled').checked=true;
  $('dynVarMT').textContent='æ·»åŠ å‹•æ…‹è®Šé‡';
  bootstrap.Modal.getOrCreateInstance($('dynVarModal')).show();
}
async function editDynVar(id) {
  const r = await R('GET','/api/dynamic-vars/'+id+'/'); if(r.code!==0){toast(r.message,'danger');return;}
  const v = r.data;
  $('dynVarId').value=v.id; $('dynVarName').value=v.name; $('dynVarType').value=v.dyn_type;
  $('dynVarDesc').value=v.description||''; $('dynVarEnabled').checked=v.enabled;
  $('dynVarMT').textContent='ç·¨è¼¯å‹•æ…‹è®Šé‡';
  bootstrap.Modal.getOrCreateInstance($('dynVarModal')).show();
}
async function saveDynVar() {
  const id = $('dynVarId').value;
  const body = {
    name: $('dynVarName').value.trim(), dyn_type: $('dynVarType').value,
    enabled: $('dynVarEnabled').checked, description: $('dynVarDesc').value.trim()
  };
  if (!body.name) { toast('è«‹å¡«å¯«è®Šé‡å','warning'); return; }
  const r = id ? await R('PUT','/api/dynamic-vars/'+id+'/',body) : await R('POST','/api/dynamic-vars/',body);
  if (r.code===0) {
    toast(r.message); bootstrap.Modal.getInstance($('dynVarModal'))?.hide(); loadDynVars();
  } else { toast(r.message,'danger'); }
}
async function delDynVar(id) {
  if (!confirm('ç¢ºèªåˆªé™¤æ­¤å‹•æ…‹è®Šé‡ï¼Ÿ')) return;
  const r = await R('DELETE','/api/dynamic-vars/'+id+'/');
  r.code===0 ? (toast('å·²åˆªé™¤'), loadDynVars()) : toast(r.message,'danger');
}
async function toggleDynVar(id, cb) {
  const r = await R('POST','/api/dynamic-vars/'+id+'/toggle/');
  if (r.code===0) { toast(r.message); loadDynVars(); }
  else { cb.checked = !cb.checked; toast(r.message,'danger'); }
}

// â•â•â•â•â•â•â•â•â•â• VARIABLES â•â•â•â•â•â•â•â•â•â•
async function loadVars(p) {
  if (p) S.varPg = p;
  const r = await R('GET','/api/variables/?page='+S.varPg+'&page_size=10');
  if (r.code !== 0) return;
  const {items, total, pages, page:cur} = r.data;
  const tc = {string:'secondary',token:'warning',json:'info'};
  $('varTb').innerHTML = items.length ? items.map(v =>
    '<tr><td><code>'+eh(v.name)+'</code></td>' +
    '<td><span class="badge bg-'+(tc[v.var_type]||'secondary')+' text-dark">'+v.var_type+'</span></td>' +
    '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+eh(v.value)+'">'+eh(v.value)+'</td>' +
    '<td class="text-muted small">'+eh(v.description||'-')+'</td>' +
    '<td class="text-muted small">'+v.updated_at+'</td>' +
    '<td><button class="btn bi btn-outline-primary btn-sm me-1" onclick="editVar('+v.id+')"><i class="fas fa-edit fa-xs"></i></button>' +
    '<button class="btn bi btn-outline-danger btn-sm" onclick="delVar('+v.id+')"><i class="fas fa-trash fa-xs"></i></button></td></tr>'
  ).join('') : '<tr><td colspan="6" class="text-center text-muted py-4">æš«ç„¡è®Šé‡</td></tr>';
  $('varTot').textContent = 'å…± ' + total + ' æ¢';
  pgRender('varPg', cur, pages, 'loadVars');
}
function openVarModal() {
  ['varId','varName','varVal','varDesc'].forEach(id => { const e=$(id); if(e) e.value=''; });
  $('varType').value='string'; $('varMT').textContent='æ·»åŠ è®Šé‡';
  bootstrap.Modal.getOrCreateInstance($('varModal')).show();
}
async function editVar(id) {
  const r = await R('GET','/api/variables/'+id+'/'); if (r.code !== 0) return;
  const v = r.data;
  $('varId').value=v.id; $('varName').value=v.name; $('varType').value=v.var_type;
  $('varVal').value=v.value; $('varDesc').value=v.description;
  $('varMT').textContent='ç·¨è¼¯è®Šé‡'; bootstrap.Modal.getOrCreateInstance($('varModal')).show();
}
async function saveVar() {
  const id = $('varId').value;
  const body = {name:$('varName').value.trim(),value:$('varVal').value,var_type:$('varType').value,description:$('varDesc').value};
  if (!body.name) { toast('è«‹å¡«å¯«è®Šé‡å','warning'); return; }
  const r = id ? await R('PUT','/api/variables/'+id+'/',body) : await R('POST','/api/variables/',body);
  r.code===0 ? (toast(r.message), bootstrap.Modal.getInstance($('varModal'))?.hide(), loadVars()) : toast(r.message,'danger');
}
async function delVar(id) {
  if (!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return;
  const r = await R('DELETE','/api/variables/'+id+'/');
  r.code===0 ? (toast('åˆªé™¤æˆåŠŸ'), loadVars()) : toast(r.message,'danger');
}
function openTokModal() {
  $('tokVar').value='token'; $('tokType').value='uuid'; $('tokCustom').style.display='none';
  bootstrap.Modal.getOrCreateInstance($('tokModal')).show();
}
function togTokCustom() { $('tokCustom').style.display = $('tokType').value==='custom' ? '' : 'none'; }
async function genToken() {
  const r = await R('POST','/api/variables/token/generate/',{type:$('tokType').value,var_name:$('tokVar').value.trim(),value:$('tokCustomVal')?.value||''});
  r.code===0 ? (toast('Token å·²ç”Ÿæˆä¸¦ä¿å­˜'), bootstrap.Modal.getInstance($('tokModal'))?.hide(), loadVars()) : toast(r.message,'danger');
}

// â•â•â•â•â•â•â•â•â•â• DATABASES â•â•â•â•â•â•â•â•â•â•
async function loadDbs() {
  const r = await R('GET','/api/db/configs/'); if (r.code !== 0) return;
  S.dbs = r.data || [];
  const cc = $('dbCards'); if (!cc) return;
  if (!r.data?.length) { cc.innerHTML='<div class="col-12 text-center text-muted py-4">æš«ç„¡MySQLé…ç½®ï¼Œé»æ“Šå³ä¸Šè§’æ·»åŠ </div>'; return; }
  cc.innerHTML = r.data.map(d =>
    '<div class="col-md-6 col-lg-4"><div class="card p-3">' +
    '<div class="d-flex align-items-center gap-2 mb-2"><div style="font-size:1.6rem;color:#1d4ed8"><i class="fas fa-database"></i></div><div><div class="fw-bold">'+eh(d.name)+'</div><div class="text-muted small">'+d.host+':'+d.port+'/'+d.database+'</div></div></div>' +
    (d.description?'<div class="text-muted small mb-2">'+eh(d.description)+'</div>':'') +
    '<div class="d-flex gap-1"><button class="btn btn-sm btn-outline-success flex-fill" onclick="testDb('+d.id+')"><i class="fas fa-plug me-1"></i>æ¸¬è©¦</button><button class="btn btn-sm btn-outline-primary" onclick="editDb('+d.id+')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="delDb('+d.id+')"><i class="fas fa-trash"></i></button></div>' +
    '</div></div>'
  ).join('');
}
function openDbModal() {
  ['dbId','dbName','dbUser','dbPwd','dbDb','dbDesc'].forEach(id=>{const e=$(id);if(e)e.value='';});
  $('dbHost').value='127.0.0.1'; $('dbPort').value='3306'; $('dbCharset').value='utf8mb4';
  $('dbMT').textContent='æ·»åŠ MySQLé…ç½®'; bootstrap.Modal.getOrCreateInstance($('dbModal')).show();
}
async function editDb(id) {
  const r = await R('GET','/api/db/configs/'+id+'/'); if (r.code !== 0) return;
  const d = r.data;
  $('dbId').value=d.id; $('dbName').value=d.name; $('dbHost').value=d.host; $('dbPort').value=d.port;
  $('dbUser').value=d.username; $('dbPwd').value=''; $('dbDb').value=d.database;
  $('dbCharset').value=d.charset; $('dbDesc').value=d.description;
  $('dbMT').textContent='ç·¨è¼¯MySQLé…ç½®'; bootstrap.Modal.getOrCreateInstance($('dbModal')).show();
}
async function saveDb() {
  const id = $('dbId').value;
  const body = {name:$('dbName').value.trim(),host:$('dbHost').value,port:+$('dbPort').value,username:$('dbUser').value,password:$('dbPwd').value,database:$('dbDb').value,charset:$('dbCharset').value,description:$('dbDesc').value};
  if (!body.name) { toast('è«‹å¡«å¯«åç¨±','warning'); return; }
  const r = id ? await R('PUT','/api/db/configs/'+id+'/',body) : await R('POST','/api/db/configs/',body);
  r.code===0 ? (toast(r.message), bootstrap.Modal.getInstance($('dbModal'))?.hide(), loadDbs()) : toast(r.message,'danger');
}
async function delDb(id) { if (!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return; const r=await R('DELETE','/api/db/configs/'+id+'/'); r.code===0?(toast('åˆªé™¤æˆåŠŸ'),loadDbs()):toast(r.message,'danger'); }
async function testDb(id) { load(true,'æ¸¬è©¦é€£æ¥...'); const r=await R('POST','/api/db/configs/'+id+'/test/',{}); load(false); toast(r.data?.message||r.message,r.data?.connected?'success':'danger'); }

// â•â•â•â•â•â•â•â•â•â• REDIS CONFIG â•â•â•â•â•â•â•â•â•â•
async function loadRedis() {
  const r = await R('GET','/api/redis/configs/'); if (r.code !== 0) return;
  S.redis = r.data || [];
  const cc = $('redisCards'); if (!cc) return;
  if (!r.data?.length) { cc.innerHTML='<div class="col-12 text-center text-muted py-4">æš«ç„¡Redisé…ç½®ï¼Œé»æ“Šå³ä¸Šè§’æ·»åŠ </div>'; return; }
  cc.innerHTML = r.data.map(d =>
    '<div class="col-md-6 col-lg-4"><div class="card p-3">' +
    '<div class="d-flex align-items-center gap-2 mb-2"><div style="font-size:1.6rem;color:#be123c"><i class="fas fa-server"></i></div><div><div class="fw-bold">'+eh(d.name)+'</div><div class="text-muted small">'+d.host+':'+d.port+' / db'+d.db+'</div></div></div>' +
    (d.description?'<div class="text-muted small mb-2">'+eh(d.description)+'</div>':'') +
    '<div class="d-flex gap-1"><button class="btn btn-sm btn-outline-success flex-fill" onclick="testRedis('+d.id+')"><i class="fas fa-plug me-1"></i>æ¸¬è©¦</button><button class="btn btn-sm btn-outline-primary" onclick="editRedis('+d.id+')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="delRedis('+d.id+')"><i class="fas fa-trash"></i></button></div>' +
    '</div></div>'
  ).join('');
}
function openRedisModal() {
  ['redisId','redisName','redisPwd','redisDesc'].forEach(id=>{const e=$(id);if(e)e.value='';});
  $('redisHost').value='127.0.0.1'; $('redisPort').value='6379'; $('redisDb').value='0';
  $('redisMT').textContent='æ·»åŠ Redisé…ç½®'; bootstrap.Modal.getOrCreateInstance($('redisModal')).show();
}
async function editRedis(id) {
  const r = await R('GET','/api/redis/configs/'+id+'/'); if (r.code !== 0) return;
  const d = r.data;
  $('redisId').value=d.id; $('redisName').value=d.name; $('redisHost').value=d.host;
  $('redisPort').value=d.port; $('redisPwd').value=''; $('redisDb').value=d.db; $('redisDesc').value=d.description;
  $('redisMT').textContent='ç·¨è¼¯Redisé…ç½®'; bootstrap.Modal.getOrCreateInstance($('redisModal')).show();
}
async function saveRedis() {
  const id = $('redisId').value;
  const body = {name:$('redisName').value.trim(),host:$('redisHost').value,port:+$('redisPort').value,password:$('redisPwd').value,db:+$('redisDb').value,description:$('redisDesc').value};
  if (!body.name) { toast('è«‹å¡«å¯«åç¨±','warning'); return; }
  const r = id ? await R('PUT','/api/redis/configs/'+id+'/',body) : await R('POST','/api/redis/configs/',body);
  r.code===0 ? (toast(r.message), bootstrap.Modal.getInstance($('redisModal'))?.hide(), loadRedis()) : toast(r.message,'danger');
}
async function delRedis(id) { if (!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return; const r=await R('DELETE','/api/redis/configs/'+id+'/'); r.code===0?(toast('åˆªé™¤æˆåŠŸ'),loadRedis()):toast(r.message,'danger'); }
async function testRedis(id) { load(true,'æ¸¬è©¦Redisé€£æ¥...'); const r=await R('POST','/api/redis/configs/'+id+'/test/',{}); load(false); toast(r.data?.message||r.message,r.data?.connected?'success':'danger'); }

// â•â•â•â•â•â•â•â•â•â• REDIS TOOL â•â•â•â•â•â•â•â•â•â•
async function loadRdTool() {
  const r = await R('GET','/api/redis/configs/');
  S.redis = r.data || [];
  const sel = $('rdConn'); if (!sel) return;
  sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ Redis --</option>' +
    S.redis.map(d => '<option value="'+d.id+'">'+d.name+' ('+d.host+':'+d.port+'/db'+d.db+')</option>').join('');
  rdToggleFields();
}
function rdToggleFields() {
  const a = $('rdAction').value;
  $('rdPatternWrap').style.display = a==='scan' ? '' : 'none';
  $('rdKeyWrap').style.display = ['get','set','delete','ttl','expire'].includes(a) ? '' : 'none';
  $('rdValWrap').style.display = a==='set' ? '' : 'none';
  $('rdTtlWrap').style.display = ['set','expire'].includes(a) ? '' : 'none';
  $('rdCaptchaWrap').style.display = a==='fetch_captcha' ? '' : 'none';
}
async function execRedis() {
  const rdId = $('rdConn').value;
  if (!rdId) { toast('è«‹é¸æ“‡Redisé€£æ¥','warning'); return; }
  const action = $('rdAction').value;
  const body = {redis_id:+rdId, action};
  if (action==='scan') body.pattern = $('rdPattern').value || '*';
  else if (action==='get'||action==='ttl') body.key = $('rdKey').value;
  else if (action==='set') { body.key=$('rdKey').value; body.value=$('rdVal').value; body.ttl=+$('rdTtl').value||0; }
  else if (action==='delete') body.keys = [$('rdKey').value];
  else if (action==='expire') { body.key=$('rdKey').value; body.ttl=+$('rdTtl').value; }
  else if (action==='fetch_captcha') {
    body.key = $('rdCapKey').value; body.var_name = $('rdCapVar').value;
    const field = $('rdCapField').value.trim();
    if (field) body.extract_field = field;
  }
  load(true,'Redis åŸ·è¡Œä¸­...');
  const r = await R('POST','/api/redis/operate/', body);
  load(false);
  // reset display
  ['rdKeyListWrap','rdResWrap','rdCapResWrap'].forEach(id => { const e=$(id); if(e) e.style.display='none'; });
  $('rdResTitle').textContent = 'çµæœ';

  if (action==='scan' && r.data?.keys !== undefined) {
    $('rdResTitle').textContent = 'SCAN çµæœ';
    $('rdKeyListWrap').style.display = '';
    $('rdKeyCount').textContent = 'å…± ' + r.data.total + ' å€‹ Keyï¼ˆPattern: ' + r.data.pattern + 'ï¼‰';
    $('rdKeyList').innerHTML = r.data.keys.length
      ? r.data.keys.map(k => '<div class="rki"><i class="fas fa-key fa-xs text-muted"></i><code style="flex:1">'+eh(k)+'</code><button class="btn btn-outline-secondary" style="font-size:.65rem;padding:1px 5px" onclick="rdFillKey(\''+esc(k)+'\')">å¡«å…¥</button></div>').join('')
      : '<div class="text-center text-muted py-3">ç„¡åŒ¹é… Key</div>';
  } else if (action==='fetch_captcha' && r.data?.success) {
    $('rdCapResWrap').style.display = '';
    $('rdCapMsg').innerHTML = '<i class="fas fa-check-circle me-2"></i>' + eh(r.data.message || 'ç²å–æˆåŠŸ');
    // FIX: use r.data.var_name directly (string interpolation without double-escaping)
    const varName = r.data.var_name || '';
    $('rdCapDetail').innerHTML =
      '<tr><td class="fw-bold text-nowrap">Redis Key</td><td><code>'+eh(r.data.key)+'</code></td></tr>' +
      '<tr><td class="fw-bold text-nowrap">åŸå§‹å€¼</td><td><code>'+eh(String(r.data.raw_value))+'</code></td></tr>' +
      '<tr><td class="fw-bold text-nowrap">æå–å€¼</td><td><code class="text-success fw-bold">'+eh(String(r.data.extracted_value))+'</code></td></tr>' +
      '<tr><td class="fw-bold text-nowrap">å­˜å…¥è®Šé‡</td><td><code class="text-primary">{{' + eh(varName) + '}}</code><small class="text-muted ms-2">æ¥å£Bodyä¸­å¯ç›´æ¥ä½¿ç”¨</small></td></tr>' +
      '<tr><td class="fw-bold text-nowrap">TTL</td><td>' + (r.data.ttl > 0 ? r.data.ttl+'ç§’å¾ŒéæœŸ' : r.data.ttl===-1 ? 'æ°¸ä¸éæœŸ' : 'å·²éæœŸ') + '</td></tr>';
    toast('é©—è­‰ç¢¼å·²å­˜å…¥å…¨å±€è®Šé‡ {{' + varName + '}}', 'success');
  } else {
    $('rdResWrap').style.display = '';
    $('rdResBox').textContent = r.data ? JSON.stringify(r.data, null, 2) : (r.message || 'æ“ä½œå¤±æ•—');
    if (!r.data?.success && r.code !== 0) toast(r.message || 'æ“ä½œå¤±æ•—', 'danger');
    else if (r.data?.success) toast(r.data.message || 'æ“ä½œæˆåŠŸ', 'success');
  }
}
function rdFillKey(k) { $('rdKey').value=k; $('rdAction').value='get'; rdToggleFields(); }
function rdCopyKeys() {
  const keys = [...$('rdKeyList').querySelectorAll('code')].map(c=>c.textContent).join('\n');
  navigator.clipboard?.writeText(keys).then(()=>toast('å·²è¤‡è£½ '+$('rdKeyList').querySelectorAll('code').length+' å€‹ Key'));
}

// â•â•â•â•â•â•â•â•â•â• EMAIL â•â•â•â•â•â•â•â•â•â•
async function loadEmails() {
  const r = await R('GET','/api/email/configs/'); if (r.code !== 0) return;
  const cc = $('emailCards'); if (!cc) return;
  if (!r.data?.length) { cc.innerHTML='<div class="col-12 text-center text-muted py-4">æš«ç„¡éƒµä»¶é…ç½®ï¼Œé»æ“Šå³ä¸Šè§’æ·»åŠ </div>'; return; }
  cc.innerHTML = r.data.map(d =>
    '<div class="col-md-6 col-lg-4"><div class="card p-3">' +
    '<div class="d-flex align-items-center gap-2 mb-2"><div style="font-size:1.6rem;color:#4f46e5"><i class="fas fa-envelope"></i></div><div><div class="fw-bold">'+eh(d.name)+' '+(d.is_active?'<span class="badge bg-success">å•Ÿç”¨</span>':'<span class="badge bg-secondary">åœç”¨</span>')+'</div><div class="text-muted small">'+eh(d.smtp_host)+':'+d.smtp_port+' Â· '+eh(d.username)+'</div></div></div>' +
    '<div class="text-muted small mb-2">'+(d.use_ssl?'SSL':d.use_tls?'TLS':'æ™®é€š')+' Â· ç™¼ä»¶äºº: '+eh(d.from_name)+'</div>' +
    '<div class="d-flex gap-1"><button class="btn btn-sm btn-outline-primary flex-fill" onclick="editEmail('+d.id+')"><i class="fas fa-edit me-1"></i>ç·¨è¼¯</button><button class="btn btn-sm btn-outline-danger" onclick="delEmail('+d.id+')"><i class="fas fa-trash"></i></button></div>' +
    '</div></div>'
  ).join('');
}
function openEmailModal() {
  ['emailId','emailSmtpHost','emailUser','emailPwd','emailFrom'].forEach(id=>{const e=$(id);if(e)e.value='';});
  $('emailName').value='é»˜èªéƒµä»¶é…ç½®'; $('emailFromName').value='APIæ¸¬è©¦å¹³å°';
  $('emailSmtpPort').value='465'; $('emailSsl').checked=true; $('emailTls').checked=false; $('emailActive').checked=true;
  $('emailMT').textContent='æ·»åŠ éƒµä»¶é…ç½®'; bootstrap.Modal.getOrCreateInstance($('emailModal')).show();
}
async function editEmail(id) {
  const r = await R('GET','/api/email/configs/'+id+'/'); if (r.code !== 0) return;
  const d = r.data;
  $('emailId').value=d.id; $('emailName').value=d.name; $('emailSmtpHost').value=d.smtp_host;
  $('emailSmtpPort').value=d.smtp_port; $('emailSsl').checked=d.use_ssl; $('emailTls').checked=d.use_tls;
  $('emailUser').value=d.username; $('emailPwd').value='';
  $('emailFrom').value=d.from_addr; $('emailFromName').value=d.from_name; $('emailActive').checked=d.is_active;
  $('emailMT').textContent='ç·¨è¼¯éƒµä»¶é…ç½®'; bootstrap.Modal.getOrCreateInstance($('emailModal')).show();
}
async function saveEmail() {
  const id = $('emailId').value;
  const body={name:$('emailName').value.trim(),smtp_host:$('emailSmtpHost').value,smtp_port:+$('emailSmtpPort').value,use_ssl:$('emailSsl').checked,use_tls:$('emailTls').checked,username:$('emailUser').value,password:$('emailPwd').value,from_addr:$('emailFrom').value||$('emailUser').value,from_name:$('emailFromName').value,is_active:$('emailActive').checked};
  if (!body.smtp_host||!body.username) { toast('è«‹å¡«å¯«SMTPä¸»æ©Ÿå’Œéƒµç®±è³¬è™Ÿ','warning'); return; }
  const r = id ? await R('PUT','/api/email/configs/'+id+'/',body) : await R('POST','/api/email/configs/',body);
  r.code===0 ? (toast(r.message), bootstrap.Modal.getInstance($('emailModal'))?.hide(), loadEmails()) : toast(r.message,'danger');
}
async function delEmail(id) { if (!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return; const r=await R('DELETE','/api/email/configs/'+id+'/'); r.code===0?(toast('åˆªé™¤æˆåŠŸ'),loadEmails()):toast(r.message,'danger'); }
async function testEmailSend() {
  const to = prompt('è«‹è¼¸å…¥æ¸¬è©¦æ”¶ä»¶äººéƒµç®±:'); if (!to) return;
  const id = $('emailId').value; if (!id) { toast('è«‹å…ˆä¿å­˜é…ç½®å†æ¸¬è©¦','warning'); return; }
  load(true,'ç™¼é€æ¸¬è©¦éƒµä»¶...');
  const r = await R('POST','/api/email/configs/'+id+'/test/',{to});
  load(false); toast(r.data?.message||r.message, r.data?.sent?'success':'danger');
}

// â•â•â•â•â•â•â•â•â•â• SCHEDULER â•â•â•â•â•â•â•â•â•â•
async function loadTasks() {
  const r = await R('GET','/api/scheduler/tasks/'); if (r.code !== 0) return;
  const tb = $('taskTb');
  if (!r.data?.length) { tb.innerHTML='<tr><td colspan="7" class="text-center text-muted py-4">æš«ç„¡å®šæ™‚ä»»å‹™ï¼Œé»æ“Šå³ä¸Šè§’æ–°å»º</td></tr>'; return; }
  tb.innerHTML = r.data.map(t => {
    const sc = {active:'ts-active',paused:'ts-paused',stopped:'ts-stopped'}[t.status]||'';
    const sl = {active:'âœ“ é‹è¡Œä¸­',paused:'â¸ å·²æš«åœ',stopped:'â¬› å·²åœæ­¢'}[t.status]||t.status;
    const trig = t.trigger_type==='cron'
      ? '<span class="badge bg-light text-dark border"><i class="fas fa-clock me-1"></i>'+eh(t.cron_expr)+'</span>'
      : '<span class="badge bg-light text-dark border"><i class="fas fa-redo me-1"></i>æ¯'+t.interval_secs+'ç§’</span>';
    const nxt = t.scheduler_status?.next_run ? '<small class="text-success">'+t.scheduler_status.next_run+'</small>' : '<small class="text-muted">-</small>';
    return '<tr>' +
      '<td><strong>'+eh(t.name)+'</strong>'+(t.description?'<br><small class="text-muted">'+eh(t.description)+'</small>':'')+'</td>' +
      '<td>'+trig+'</td><td>'+nxt+'</td>' +
      '<td><span class="'+sc+'">'+sl+'</span></td>' +
      '<td><small>'+eh(t.last_result||'-')+'</small>'+(t.last_report_id?'<br><a href="#" onclick="showRpt('+t.last_report_id+');return false" class="badge bg-info text-decoration-none" style="font-size:.65rem">æŸ¥çœ‹å ±å‘Š</a>':'')+'</td>' +
      '<td>'+(t.send_email?'<i class="fas fa-check text-success" title="'+eh(t.email_to)+'"></i>':'<i class="fas fa-times text-muted"></i>')+'</td>' +
      '<td class="text-nowrap">' +
      '<button class="btn btn-sm btn-outline-success me-1" onclick="runTask('+t.id+')" title="ç«‹å³åŸ·è¡Œ"><i class="fas fa-play fa-xs"></i></button>' +
      '<button class="btn btn-sm btn-outline-'+(t.status==='active'?'warning':'success')+' me-1" onclick="toggleTask('+t.id+')" title="'+(t.status==='active'?'æš«åœ':'æ¢å¾©')+'"><i class="fas fa-'+(t.status==='active'?'pause':'play-circle')+' fa-xs"></i></button>' +
      '<button class="btn btn-sm btn-outline-primary me-1" onclick="editTask('+t.id+')" title="ç·¨è¼¯"><i class="fas fa-edit fa-xs"></i></button>' +
      '<button class="btn btn-sm btn-outline-danger" onclick="delTask('+t.id+')" title="åˆªé™¤"><i class="fas fa-trash fa-xs"></i></button>' +
      '</td></tr>';
  }).join('');
}
async function loadTaskApis() {
  const r = await R('GET','/api/apis/?page=1&page_size=200');
  const list = $('taskApiList'); if (!list) return;
  if (!r.data?.items?.length) { list.innerHTML='<div class="text-center text-muted py-3">æš«ç„¡æ¥å£</div>'; return; }
  list.innerHTML = r.data.items.map(a =>
    '<div class="asi"><input type="checkbox" class="form-check-input task-api-cb" value="'+a.id+'"><span class="bm '+a.method.toLowerCase()+'">'+a.method+'</span>'+(a.use_async?'<span class="at2 ms-1">async</span>':'')+'<span style="flex:1">'+eh(a.name)+'</span><small class="text-muted">'+eh(a.category_name)+'</small></div>'
  ).join('');
}
function openTaskModal() {
  ['taskId','taskName','taskDesc','taskEmailTo'].forEach(id=>{const e=$(id);if(e)e.value='';});
  $('taskTrigger').value='cron'; $('taskCron').value='0 9 * * *'; $('taskInterval').value='3600';
  $('taskStatus').value='active'; $('taskRptTpl').value='å®šæ™‚ä»»å‹™-{task}'; $('taskSendEmail').checked=false;
  document.querySelectorAll('.task-api-cb').forEach(c=>c.checked=false);
  togTaskTrigger(); $('taskMT').textContent='æ–°å»ºå®šæ™‚ä»»å‹™';
  bootstrap.Modal.getOrCreateInstance($('taskModal')).show();
}
function togTaskTrigger() {
  const t = $('taskTrigger').value;
  $('taskCronWrap').style.display = t==='cron' ? '' : 'none';
  $('taskIntervalWrap').style.display = t==='interval' ? '' : 'none';
}
async function editTask(id) {
  const r = await R('GET','/api/scheduler/tasks/'+id+'/'); if (r.code !== 0) return;
  const t = r.data;
  $('taskId').value=t.id; $('taskName').value=t.name; $('taskTrigger').value=t.trigger_type;
  $('taskCron').value=t.cron_expr; $('taskInterval').value=t.interval_secs;
  $('taskStatus').value=t.status; $('taskRptTpl').value=t.report_name_tpl;
  $('taskSendEmail').checked=t.send_email; $('taskEmailTo').value=t.email_to; $('taskDesc').value=t.description;
  togTaskTrigger();
  document.querySelectorAll('.task-api-cb').forEach(cb => { cb.checked = t.api_ids.includes(+cb.value); });
  $('taskMT').textContent='ç·¨è¼¯å®šæ™‚ä»»å‹™'; bootstrap.Modal.getOrCreateInstance($('taskModal')).show();
}
async function saveTask() {
  const id = $('taskId').value;
  const api_ids = [...$('taskApiList').querySelectorAll('.task-api-cb:checked')].map(c=>+c.value);
  const body={name:$('taskName').value.trim(),api_ids,trigger_type:$('taskTrigger').value,cron_expr:$('taskCron').value,interval_secs:+$('taskInterval').value,status:$('taskStatus').value,report_name_tpl:$('taskRptTpl').value,send_email:$('taskSendEmail').checked,email_to:$('taskEmailTo').value,description:$('taskDesc').value};
  if (!body.name) { toast('è«‹å¡«å¯«ä»»å‹™åç¨±','warning'); return; }
  if (!body.api_ids.length) { toast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¥å£','warning'); return; }
  const r = id ? await R('PUT','/api/scheduler/tasks/'+id+'/',body) : await R('POST','/api/scheduler/tasks/',body);
  r.code===0 ? (toast(r.message), bootstrap.Modal.getInstance($('taskModal'))?.hide(), loadTasks()) : toast(r.message,'danger');
}
async function runTask(id) { load(true,'ç«‹å³åŸ·è¡Œä»»å‹™...'); const r=await R('POST','/api/scheduler/tasks/'+id+'/run/',{}); load(false); toast(r.message,r.code===0?'success':'danger'); setTimeout(loadTasks,2000); }
async function toggleTask(id) { const r=await R('POST','/api/scheduler/tasks/'+id+'/toggle/',{}); r.code===0?(toast(r.message),loadTasks()):toast(r.message,'danger'); }
async function delTask(id) { if(!confirm('ç¢ºèªåˆªé™¤ä»»å‹™ï¼Ÿ'))return; const r=await R('DELETE','/api/scheduler/tasks/'+id+'/'); r.code===0?(toast('åˆªé™¤æˆåŠŸ'),loadTasks()):toast(r.message,'danger'); }

// â•â•â•â•â•â•â•â•â•â• RUNNER â•â•â•â•â•â•â•â•â•â•
S.rnrSel = new Set();
async function loadRnrApis() {
  const kw=$('rnrSrc')?.value||'', cat=$('rnrCat')?.value||'';
  let url='/api/apis/?page=1&page_size=200&keyword='+encodeURIComponent(kw);
  if (cat) url+='&category_id='+cat;
  const r = await R('GET',url); const list=$('rnrList');
  if (r.code!==0||!r.data.items.length) { list.innerHTML='<div class="text-center text-muted py-4">æš«ç„¡æ¥å£</div>'; return; }
  list.innerHTML = r.data.items.map(a =>
    '<div class="asi" onclick="togRnr('+a.id+',this)">' +
    '<input type="checkbox" class="form-check-input rnr-cb" value="'+a.id+'"'+(S.rnrSel.has(a.id)?' checked':'')+'>' +
    '<span class="bm '+a.method.toLowerCase()+'">'+a.method+'</span>' +
    (a.use_async?'<span class="at2 ms-1">async</span>':'') +
    '<span style="flex:1">'+eh(a.name)+'</span>' +
    '<small class="text-muted">'+eh(a.category_name)+'</small></div>'
  ).join('');
  updRnrBadges();
}
function togRnr(id, row) { const cb=row.querySelector('.rnr-cb'); cb.checked=!cb.checked; cb.checked?S.rnrSel.add(id):S.rnrSel.delete(id); updRnrBadges(); }
function rnrAll() { document.querySelectorAll('.rnr-cb').forEach(c=>{c.checked=true;S.rnrSel.add(+c.value);}); updRnrBadges(); }
function rnrNone() { document.querySelectorAll('.rnr-cb').forEach(c=>c.checked=false); S.rnrSel.clear(); updRnrBadges(); }
function updRnrBadges() {
  const w=$('rnrSel');
  if (!S.rnrSel.size) { w.innerHTML='<span class="text-muted small">æœªé¸æ“‡æ¥å£</span>'; return; }
  w.innerHTML = [...S.rnrSel].map(id => {
    const item = document.querySelector('.rnr-cb[value="'+id+'"]');
    const lbl = item?.closest('.asi')?.querySelector('span[style]')?.textContent || 'ID:'+id;
    return '<span class="badge bg-primary">'+eh(lbl.trim())+' <span style="cursor:pointer" onclick="rmRnr('+id+')">âœ•</span></span>';
  }).join(' ');
}
function rmRnr(id) { S.rnrSel.delete(id); const cb=document.querySelector('.rnr-cb[value="'+id+'"]'); if(cb)cb.checked=false; updRnrBadges(); }
async function runBatch() {
  const ids=[...S.rnrSel]; if(!ids.length){toast('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ¥å£','warning');return;}
  load(true,'æ‰¹é‡åŸ·è¡Œ '+ids.length+' å€‹æ¥å£...');
  const stopOnFail = !!$('rnrStopOnFail')?.checked;
  const body={api_ids:ids, report_name:$('rnrName').value.trim(), stop_on_failure: stopOnFail};
  const r = await R('POST','/api/run/batch/',body);
  load(false);
  if (r.code!==0){toast(r.message,'danger');return;}
  const d=r.data;
  const pc=d.pass_rate===100?'success':d.pass_rate>=60?'warning':'danger';
  const fw=d.total>0?(d.failed/d.total*100).toFixed(1):0;
  const ew=d.total>0?(d.error/d.total*100).toFixed(1):0;
  $('rnrRes').style.display='';
  $('rnrResBody').innerHTML =
    '<div class="row g-2 mb-2 text-center">' +
    '<div class="col-3"><div class="fw-bold fs-5">'+d.total+'</div><div class="text-muted small">ç¸½æ•¸</div></div>' +
    '<div class="col-3"><div class="fw-bold fs-5 text-success">'+d.passed+'</div><div class="text-muted small">é€šé</div></div>' +
    '<div class="col-3"><div class="fw-bold fs-5 text-danger">'+d.failed+'</div><div class="text-muted small">å¤±æ•—</div></div>' +
    '<div class="col-3"><div class="fw-bold fs-5 text-warning">'+d.error+'</div><div class="text-muted small">éŒ¯èª¤</div></div></div>' +
    '<div class="rbar mb-2"><div class="rp" style="width:'+d.pass_rate+'%"></div><div class="rf" style="width:'+fw+'%"></div><div class="re" style="width:'+ew+'%"></div></div>' +
    '<div class="d-flex justify-content-between small mb-3"><span>é€šéç‡ï¼š<strong class="text-'+pc+'">'+d.pass_rate+'%</strong></span><span>è€—æ™‚ï¼š'+d.duration+'s</span></div>';
  // éƒµä»¶
  if ($('rnrEmail').checked && $('rnrEmailTo').value.trim()) {
    const er = await R('POST','/api/email/send-report/',{report_id:d.report_id,email_to:$('rnrEmailTo').value.trim()});
    $('rnrResBody').innerHTML += '<div class="alert '+(er.code===0?'alert-success':'alert-warning')+' py-2 small mb-2"><i class="fas fa-envelope me-1"></i>'+(er.data?.message||er.message)+'</div>';
  }
  $('rnrResBody').innerHTML += '<button class="btn btn-outline-primary w-100 btn-sm" onclick="showRpt('+d.report_id+')"><i class="fas fa-file-alt me-1"></i>æŸ¥çœ‹è©³ç´°å ±å‘Š</button>';
  toast('åŸ·è¡Œå®Œæˆï¼Œé€šéç‡ '+d.pass_rate+'%', d.pass_rate===100?'success':'warning');
}

// â•â•â•â•â•â•â•â•â•â• LOCUST â•â•â•â•â•â•â•â•â•â•
async function loadLocustApis() {
  const r = await R('GET','/api/apis/?page=1&page_size=200');
  const list=$('locustApiList'); if (!list) return;
  if (!r.data?.items?.length) { list.innerHTML='<div class="text-center text-muted py-3">æš«ç„¡æ¥å£</div>'; return; }
  list.innerHTML = r.data.items.map(a =>
    '<div class="asi"><input type="checkbox" class="form-check-input locust-cb" value="'+a.id+'"><span class="bm '+a.method.toLowerCase()+'">'+a.method+'</span><span style="flex:1">'+eh(a.name)+'</span><small class="text-muted">'+eh(a.category_name)+'</small></div>'
  ).join('');
}
function getLocustIds() { return [...document.querySelectorAll('.locust-cb:checked')].map(c=>+c.value); }
async function locustPreview() {
  const ids = getLocustIds(); if (!ids.length){toast('è«‹é¸æ“‡æ¥å£','warning');return;}
  load(true,'ç”Ÿæˆè…³æœ¬...');
  const r = await R('POST','/api/locust/preview/',{api_ids:ids});
  load(false);
  $('lstScriptCard').style.display='';
  $('lstScript').textContent = r.data || r.message || 'ç”Ÿæˆå¤±æ•—';
}
async function locustStart() {
  const ids = getLocustIds(); if (!ids.length){toast('è«‹é¸æ“‡æ¥å£','warning');return;}
  const body={api_ids:ids,users:+$('lstUsers').value||10,spawn_rate:+$('lstSpawn').value||2,run_time:$('lstTime').value||'60s'};
  load(true,'å•Ÿå‹•Locust...');
  const r = await R('POST','/api/locust/start/',body);
  load(false);
  if (r.code!==0||!r.data?.success){toast(r.data?.message||r.message,'danger');return;}
  S.lstTaskId = r.data.task_id;
  toast('Locust å·²å•Ÿå‹•ï¼ŒPID='+r.data.pid,'success');
  $('lstStartBtn').style.display='none'; $('lstStopBtn').style.display='';
  $('lstStatusBadge').className='badge bg-success pulse'; $('lstStatusBadge').textContent='â–¶ åŸ·è¡Œä¸­';
  lstPollStatus();
}
function lstPollStatus() {
  if (S.lstPollTimer) clearInterval(S.lstPollTimer);
  S.lstPollTimer = setInterval(async ()=>{
    if (!S.lstTaskId) { clearInterval(S.lstPollTimer); return; }
    const r = await R('GET','/api/locust/status/'+S.lstTaskId+'/');
    const d = r.data;
    if (!d) return;
    const elapsed = d.elapsed || 0;
    $('lstStatusBody').innerHTML =
      '<div class="row g-2 text-center">' +
      '<div class="col-4 col-md-2"><div class="locust-stat"><div class="val">'+d.users+'</div><div class="lbl">ç”¨æˆ¶æ•¸</div></div></div>' +
      '<div class="col-4 col-md-2"><div class="locust-stat"><div class="val">'+eh(d.run_time||'-')+'</div><div class="lbl">è¨­å®šæ™‚é•·</div></div></div>' +
      '<div class="col-4 col-md-2"><div class="locust-stat"><div class="val">'+elapsed+'s</div><div class="lbl">å·²åŸ·è¡Œ</div></div></div>' +
      '<div class="col-6 col-md-3"><div class="locust-stat"><div class="val">'+eh(d.status||'-')+'</div><div class="lbl">ç‹€æ…‹</div></div></div>' +
      '<div class="col-6 col-md-3"><div class="locust-stat"><div class="val">'+eh(String(d.pid||'-'))+'</div><div class="lbl">PID</div></div></div>' +
      '</div>';
    if (d.status==='completed'||d.status==='error'||d.status==='stopped') {
      clearInterval(S.lstPollTimer);
      $('lstStartBtn').style.display=''; $('lstStopBtn').style.display='none';
      $('lstStatusBadge').className='badge bg-'+(d.status==='completed'?'success':'danger');
      $('lstStatusBadge').textContent = d.status==='completed'?'âœ“ å®Œæˆ':'âœ— '+(d.status==='error'?'éŒ¯èª¤':'å·²åœæ­¢');
      if (d.status==='completed') lstCollect();
    }
  }, 2000);
}
async function locustStop() {
  if (!S.lstTaskId){toast('ç„¡é‹è¡Œä¸­ä»»å‹™','warning');return;}
  const r = await R('GET','/api/locust/stop/'+S.lstTaskId+'/');
  clearInterval(S.lstPollTimer);
  $('lstStartBtn').style.display=''; $('lstStopBtn').style.display='none';
  $('lstStatusBadge').className='badge bg-secondary'; $('lstStatusBadge').textContent='å·²åœæ­¢';
  toast(r.data?.message||'å·²åœæ­¢','warning');
  lstCollect();
}
async function lstCollect() {
  if (!S.lstTaskId) return;
  const rname = $('lstRptName').value.trim() || '';
  const r = await R('POST','/api/locust/collect/'+S.lstTaskId+'/',{report_name:rname});
  if (!r.data?.success) { toast(r.data?.message||'æ”¶é›†çµæœå¤±æ•—','warning'); return; }
  const stats = r.data.stats;
  $('lstResultCard').style.display='';
  $('lstResultBody').innerHTML =
    '<div class="row g-2 text-center mb-3">' +
    '<div class="col"><div class="locust-stat"><div class="val">'+stats.total_requests+'</div><div class="lbl">ç¸½è«‹æ±‚</div></div></div>' +
    '<div class="col"><div class="locust-stat"><div class="val text-danger">'+stats.total_failures+'</div><div class="lbl">å¤±æ•—æ•¸</div></div></div>' +
    '<div class="col"><div class="locust-stat"><div class="val">'+stats.avg_response_time+'ms</div><div class="lbl">å¹³å‡éŸ¿æ‡‰</div></div></div>' +
    '<div class="col"><div class="locust-stat"><div class="val">'+stats.p90+'ms</div><div class="lbl">P90</div></div></div>' +
    '<div class="col"><div class="locust-stat"><div class="val">'+stats.p99+'ms</div><div class="lbl">P99</div></div></div>' +
    '<div class="col"><div class="locust-stat"><div class="val">'+stats.rps+'</div><div class="lbl">RPS</div></div></div>' +
    '</div>' +
    '<table class="table table-sm table-bordered" style="font-size:.77rem"><thead><tr><th>æ¥å£</th><th>è«‹æ±‚æ•¸</th><th>å¤±æ•—</th><th>å¹³å‡ms</th><th>P90ms</th><th>RPS</th></tr></thead><tbody>' +
    (stats.per_endpoint||[]).map(ep=>'<tr><td>'+eh(ep.name)+'</td><td>'+ep.requests+'</td><td class="text-danger">'+ep.failures+'</td><td>'+ep.avg_ms+'</td><td>'+ep.p90_ms+'</td><td>'+ep.rps+'</td></tr>').join('') +
    '</tbody></table>' +
    '<button class="btn btn-outline-primary btn-sm w-100" onclick="showRpt('+r.data.report_id+')"><i class="fas fa-chart-bar me-1"></i>æŸ¥çœ‹æ¸¬è©¦å ±å‘Š</button>';
  toast('å£“æ¸¬å ±å‘Šå·²ä¿å­˜ (ID='+r.data.report_id+')','success');
}

// â•â•â•â•â•â•â•â•â•â• SQL TOOL â•â•â•â•â•â•â•â•â•â•
async function loadSqlDbs() {
  const r = await R('GET','/api/db/configs/'); if (r.code !== 0) return;
  S.dbs = r.data || [];
  const sel=$('sqlDb'); if (!sel) return;
  sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>' +
    r.data.map(d=>'<option value="'+d.id+'">'+d.name+' ('+d.host+'/'+d.database+')</option>').join('');
}
function insSql(t) { const ta=$('sqlText'); ta.value=(ta.value?ta.value+'\n\n':'')+SQL_TPL[t]; ta.focus(); }
async function runSql() {
  const db=$('sqlDb').value, sql=$('sqlText').value.trim();
  if (!db){toast('è«‹é¸æ“‡æ•¸æ“šåº«','warning');return;}
  if (!sql){toast('è«‹è¼¸å…¥SQL','warning');return;}
  load(true,'åŸ·è¡ŒSQL...');
  const r = await R('POST','/api/db/execute/',{db_id:db, sql});
  load(false);
  $('sqlResWrap').style.display='';
  $('sqlResTitle').textContent='åŸ·è¡Œçµæœ ('+(r.data?.statements?.length||0)+' æ¢èªå¥)';
  if (r.code!==0) { $('sqlResBody').innerHTML='<div class="p-3"><div class="alert alert-danger">'+eh(r.message)+'</div></div>'; return; }
  let h='';
  (r.data?.statements||[]).forEach(s => {
    const ok = !s.error;
    h += '<div class="p-3 border-bottom"><div class="d-flex align-items-center gap-2 mb-2"><span class="badge bg-'+(ok?'success':'danger')+'">'+(ok?'âœ“':'âœ—')+'</span><span class="badge bg-secondary">'+eh(s.type)+'</span><code class="text-muted small">'+eh(s.sql.substring(0,80))+(s.sql.length>80?'..':'')+'</code><span class="ms-auto text-muted small">å½±éŸ¿è¡Œ: '+s.affected+'</span></div>' +
      (s.error?'<div class="alert alert-danger py-1 small mb-2">'+eh(s.error)+'</div>':'') +
      (s.rows?.length?'<div class="table-responsive"><table class="table table-sm table-bordered mb-0" style="font-size:.74rem"><thead><tr>'+Object.keys(s.rows[0]).map(k=>'<th>'+eh(k)+'</th>').join('')+'</tr></thead><tbody>'+s.rows.slice(0,50).map(row=>'<tr>'+Object.values(row).map(v=>'<td>'+eh(String(v??''))+'</td>').join('')+'</tr>').join('')+'</tbody></table>'+(s.rows.length>50?'<div class="text-muted small p-1">é¡¯ç¤ºå‰50è¡Œï¼Œå…±'+s.rows.length+'è¡Œ</div>':'')+'</div>':'') +
      '</div>';
  });
  $('sqlResBody').innerHTML = h || '<div class="p-3 text-muted">ç„¡çµæœ</div>';
}

// â•â•â•â•â•â•â•â•â•â• REPORTS â•â•â•â•â•â•â•â•â•â•
async function loadRpts(p) {
  if (p) S.rptPg = p;
  const r = await R('GET','/api/reports/?page='+S.rptPg+'&page_size=10');
  if (r.code !== 0) return;
  const {items, total, pages, page:cur} = r.data;
  const tb=$('rptTb');
  if (!items.length) { tb.innerHTML='<tr><td colspan="7" class="text-center text-muted py-4">æš«ç„¡æ¸¬è©¦å ±å‘Š</td></tr>'; return; }
  tb.innerHTML = items.map(r => {
    const fw=r.total>0?(r.failed/r.total*100).toFixed(1):0;
    const ew=r.total>0?(r.error/r.total*100).toFixed(1):0;
    const pc=r.pass_rate===100?'success':r.pass_rate>=60?'warning':'danger';
    return '<tr><td><strong>'+eh(r.name)+'</strong></td>' +
      '<td style="min-width:100px"><div class="rbar mb-1"><div class="rp" style="width:'+r.pass_rate+'%"></div><div class="rf" style="width:'+fw+'%"></div><div class="re" style="width:'+ew+'%"></div></div><small class="text-'+pc+' fw-bold">'+r.pass_rate+'%</small></td>' +
      '<td><span class="text-success">'+r.passed+'</span>/<span class="text-danger">'+r.failed+'</span>/<span class="text-warning">'+r.error+'</span></td>' +
      '<td>'+r.total+'</td><td class="text-muted small">'+r.duration+'s</td><td class="text-muted small">'+r.created_at+'</td>' +
      '<td class="text-nowrap"><button class="btn btn-sm btn-outline-primary me-1" onclick="showRpt('+r.id+')">è©³æƒ…</button><button class="btn btn-sm btn-outline-warning me-1" onclick="sendRptEmail('+r.id+')" title="ç™¼é€éƒµä»¶"><i class="fas fa-envelope fa-xs"></i></button><button class="btn btn-sm btn-outline-danger" onclick="delRpt('+r.id+')"><i class="fas fa-trash fa-xs"></i></button></td></tr>';
  }).join('');
  $('rptTot').textContent='å…± '+total+' æ¢'; pgRender('rptPg',cur,pages,'loadRpts');
}
async function delRpt(id) { if(!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ'))return; const r=await R('DELETE','/api/reports/'+id+'/'); r.code===0?(toast('åˆªé™¤æˆåŠŸ'),loadRpts()):toast(r.message,'danger'); }
async function sendRptEmail(id) {
  const to = prompt('æ”¶ä»¶äººéƒµç®±ï¼ˆå¤šå€‹é€—è™Ÿåˆ†éš”ï¼‰:'); if (!to) return;
  load(true,'ç™¼é€éƒµä»¶å ±å‘Š...');
  const r = await R('POST','/api/email/send-report/',{report_id:id,email_to:to});
  load(false); toast(r.data?.message||r.message, r.code===0?'success':'danger');
}
async function showRpt(id) {
  $('rptBody').innerHTML='<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
  bootstrap.Modal.getOrCreateInstance($('rptModal')).show();
  const r = await R('GET','/api/reports/'+id+'/'); if (r.code!==0){$('rptBody').innerHTML='<div class="alert alert-danger">'+r.message+'</div>';return;}
  const d=r.data; $('rptMT').textContent='å ±å‘Š: '+d.name;
  const fw=d.total>0?(d.failed/d.total*100).toFixed(1):0;
  const ew=d.total>0?(d.error/d.total*100).toFixed(1):0;
  let h='<div class="row g-2 mb-3 text-center">' +
    '<div class="col"><div class="p-2 bg-light rounded"><div class="fw-bold fs-5">'+d.total+'</div><div class="text-muted small">ç¸½æ•¸</div></div></div>' +
    '<div class="col"><div class="p-2 rounded" style="background:#d1fae5"><div class="fw-bold fs-5 text-success">'+d.passed+'</div><div class="text-muted small">é€šé</div></div></div>' +
    '<div class="col"><div class="p-2 rounded" style="background:#fee2e2"><div class="fw-bold fs-5 text-danger">'+d.failed+'</div><div class="text-muted small">å¤±æ•—</div></div></div>' +
    '<div class="col"><div class="p-2 rounded" style="background:#fef3c7"><div class="fw-bold fs-5 text-warning">'+d.error+'</div><div class="text-muted small">éŒ¯èª¤</div></div></div>' +
    '<div class="col"><div class="p-2 bg-light rounded"><div class="fw-bold fs-5">'+d.pass_rate+'%</div><div class="text-muted small">é€šéç‡</div></div></div>' +
    '<div class="col"><div class="p-2 bg-light rounded"><div class="fw-bold fs-5">'+d.duration+'s</div><div class="text-muted small">è€—æ™‚</div></div></div></div>' +
    '<div class="rbar mb-3" style="height:10px"><div class="rp" style="width:'+d.pass_rate+'%"></div><div class="rf" style="width:'+fw+'%"></div><div class="re" style="width:'+ew+'%"></div></div>' +
    '<div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-warning" onclick="sendRptEmail('+d.id+')"><i class="fas fa-envelope me-1"></i>ç™¼é€éƒµä»¶å ±å‘Š</button></div>' +
    '<div class="accordion">';
  d.results.forEach((res,i) => {
    const sc=res.status==='pass'?'success':res.status==='fail'?'danger':'warning';
    const hc=res.response_status>=200&&res.response_status<300?'success':'danger';
    const statusIcon = res.status==='pass'?'âœ“':res.status==='fail'?'âœ—':'âš ';
    const hasDD = res.deepdiff_results?.length;
    const hasDB = res.db_assertion_results?.length||res.pre_sql_result||res.post_sql_result;
    h += '<div class="accordion-item border rounded mb-2">' +
      '<h2 class="accordion-header"><button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#r'+i+'">' +
      '<span class="badge bg-'+sc+' me-2">'+statusIcon+'</span>' +
      '<span class="bm '+res.method.toLowerCase()+' me-2">'+res.method+'</span>' +
      (res.use_async?'<span class="at2 me-1">async</span>':'') +
      '<strong>'+eh(res.api_name)+'</strong>' +
      (hasDD?'<span class="dt ms-2">DD</span>':'') +
      (hasDB?'<span class="dt ms-1">DB</span>':'') +
      '<span class="ms-auto me-3 badge bg-'+hc+'">'+res.response_status+'</span>' +
      '<span class="badge bg-secondary">'+res.response_time+'ms</span></button></h2>' +
      '<div id="r'+i+'" class="accordion-collapse collapse"><div class="accordion-body p-3 small">' +
      '<div class="row g-2">' +
      '<div class="col-md-6">' +
      (res.error_message?'<div class="alert alert-danger py-1 mb-2">'+eh(res.error_message)+'</div>':'') +
      (res.assertion_results?.length?'<div class="mb-2"><strong>HTTPæ–·è¨€ï¼š</strong>'+res.assertion_results.map(a=>'<span class="badge bg-'+(a.passed?'success':'danger')+' d-inline-block me-1 mb-1">'+eh(a.passed?'âœ“':'âœ—')+' '+eh(a.message||'')+'</span>').join('')+'</div>':'') +
      (hasDD?'<div class="mb-2"><strong>DeepDiff <span class="dt">DD</span>ï¼š</strong>'+res.deepdiff_results.map(a=>'<div class="badge bg-'+(a.passed?'success':'danger')+' d-block text-start mb-1">'+eh(a.message||'')+(a.diff?'<br><small>'+eh(a.diff.substring(0,100))+'</small>':'')+'</div>').join('')+'</div>':'') +
      (res.db_assertion_results?.length?'<div class="mb-2"><strong>DBæ–·è¨€ <span class="dt">DB</span>ï¼š</strong>' +
        res.db_assertion_results.map(a => {
          const main = '<span class="badge bg-'+(a.passed?'success':'danger')+' d-block text-start mb-1">'+eh(a.passed?'âœ“':'âœ—')+' '+eh(a.message||'')+'</span>';
          const subs = (a.field_results||[]).length > 1
            ? '<div class="ms-3 mb-1">' + a.field_results.map(f=>'<span class="badge bg-'+(f.passed?'success':'danger')+' d-inline-block me-1 mb-1">'+eh(f.message||'')+'</span>').join('') + '</div>'
            : '';
          return main + subs;
        }).join('') + '</div>':'') +
      (res.extracted_vars&&Object.keys(res.extracted_vars||{}).length?'<div class="mb-2"><strong>æå–ï¼š</strong>'+Object.entries(res.extracted_vars).map(([k,v])=>'<code>'+k+'='+eh(String(v))+'</code> ').join('')+'</div>':'') +
      (res.pre_sql_result?'<div class="mb-1"><strong>å‰ç½®SQLï¼š</strong><div class="sqr mt-1" style="max-height:70px">'+eh(res.pre_sql_result.substring(0,300))+'</div></div>':'') +
      (res.post_sql_result?'<div class="mb-1"><strong>å¾Œç½®SQLï¼š</strong><div class="sqr mt-1" style="max-height:70px">'+eh(res.post_sql_result.substring(0,300))+'</div></div>':'') +
      '</div>' +
      '<div class="col-md-6"><strong>éŸ¿æ‡‰é«”ï¼š</strong><div class="rb mt-1" style="max-height:220px">'+hl(res.response_body)+'</div></div>' +
      '</div></div></div></div>';
  });
  $('rptBody').innerHTML = h + '</div>';
}

// â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  initAuth();   // å…ˆé©—è­‰ç™»éŒ„ç‹€æ…‹ï¼Œæœªç™»éŒ„è·³è½‰åˆ° /login
  // Pre-load global data
  R('GET','/api/db/configs/').then(r=>{ if(r.code===0) S.dbs=r.data||[]; });
  R('GET','/api/redis/configs/').then(r=>{ if(r.code===0) S.redis=r.data||[]; });
  loadCats();
  loadDash();
  rdToggleFields();
  // body type hint update
  const apiBodyType = $('apiBodyType');
  if (apiBodyType) apiBodyType.addEventListener('change', updBodyTypeHint);
  const apiMth = $('apiMth');
  if (apiMth) apiMth.addEventListener('change', togApiBody);
  // å…§å»ºå‹•æ…‹è®Šé‡ badge é»æ“Šè¤‡è£½
  document.querySelectorAll('.badge[title] code, code.badge[title]').forEach(el => {
    el.style.cursor = 'pointer';
    el.addEventListener('click', () => {
      navigator.clipboard.writeText(el.textContent).then(() => toast('å·²è¤‡è£½ ' + el.textContent));
    });
  });
});
</script>

<!-- â•â•â• Account Modal â•â•â• -->
<div class="modal fade" id="accModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="accMT">æ–°å»ºè³¬æˆ¶</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <input type="hidden" id="accId">
    <div class="mb-2"><label class="form-label">ç”¨æˆ¶å *</label>
      <input type="text" class="form-control" id="accUsername" placeholder="login name (å­—æ¯+æ•¸å­—)"></div>
    <div class="mb-2"><label class="form-label">é¡¯ç¤ºåç¨±</label>
      <input type="text" class="form-control" id="accDisplay" placeholder="å±•ç¤ºçµ¦å…¶ä»–äººçš„åå­—"></div>
    <div class="mb-2"><label class="form-label">è§’è‰² *</label>
      <select class="form-select" id="accRole">
        <option value="normal">æ™®é€šç”¨æˆ¶ â€” é™¤è³¬æˆ¶ç®¡ç†å¤–æ‰€æœ‰åŠŸèƒ½</option>
        <option value="admin">ç®¡ç†å“¡ â€” å…¨éƒ¨åŠŸèƒ½</option>
      </select></div>
    <div class="mb-2" id="accPwdWrap"><label class="form-label">å¯†ç¢¼ * <small class="text-muted">ï¼ˆæœ€å°‘6ä½ï¼‰</small></label>
      <input type="password" class="form-control" id="accPwd" placeholder="è¨­ç½®åˆå§‹å¯†ç¢¼"></div>
    <div class="mb-2" id="accNewPwdWrap" style="display:none"><label class="form-label">æ–°å¯†ç¢¼ <small class="text-muted">ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰</small></label>
      <input type="password" class="form-control" id="accNewPwd" placeholder="ç•™ç©ºå‰‡ä¸ä¿®æ”¹å¯†ç¢¼"></div>
    <div class="form-check form-switch mb-1" id="accActiveWrap">
      <input class="form-check-input" type="checkbox" id="accActive" checked>
      <label class="form-check-label">è³¬æˆ¶å•Ÿç”¨</label>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button>
    <button class="btn btn-primary btn-sm" onclick="saveAcc()">ä¿å­˜</button>
  </div>
</div></div></div>

<!-- â•â•â• Change Password Modal â•â•â• -->
<div class="modal fade" id="chPwdModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">ä¿®æ”¹å¯†ç¢¼</h5><button class="btn-close bcw" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <div class="mb-2"><label class="form-label">åŸå¯†ç¢¼</label>
      <input type="password" class="form-control" id="chOldPwd"></div>
    <div class="mb-2"><label class="form-label">æ–°å¯†ç¢¼ <small class="text-muted">ï¼ˆæœ€å°‘6ä½ï¼‰</small></label>
      <input type="password" class="form-control" id="chNewPwd"></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button>
    <button class="btn btn-primary btn-sm" onclick="doChangePwd()">ç¢ºèªä¿®æ”¹</button>
  </div>
</div></div></div>

<script>
// â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•
let CU = null; // current user

async function initAuth() {
  const r = await R('GET', '/api/auth/me/');
  if (r.code === 401 || !r.data) {
    window.location.href = '/login';
    return;
  }
  CU = r.data;
  // æ›´æ–° sidebar ç”¨æˆ¶ä¿¡æ¯
  const dn = CU.display_name || CU.username;
  const el = id => document.getElementById(id);
  el('sbUsername').textContent = dn;
  el('sbAvatar').textContent   = dn.charAt(0).toUpperCase();
  el('sbRole').textContent     = CU.role === 'admin' ? 'ç®¡ç†å“¡' : 'æ™®é€šç”¨æˆ¶';
  // ç®¡ç†å“¡é¡¯ç¤ºè³¬æˆ¶ç®¡ç†å…¥å£
  if (CU.role === 'admin') {
    document.querySelectorAll('.admin-only').forEach(e => e.style.display = '');
  }
}

async function doLogout() {
  await R('POST', '/api/auth/logout/');
  window.location.href = '/login';
}

function openChangePwd() {
  ['chOldPwd','chNewPwd'].forEach(id => document.getElementById(id).value = '');
  bootstrap.Modal.getOrCreateInstance(document.getElementById('chPwdModal')).show();
}

async function doChangePwd() {
  const old_password = document.getElementById('chOldPwd').value;
  const new_password = document.getElementById('chNewPwd').value;
  const r = await R('POST', '/api/auth/change-password/', { old_password, new_password });
  if (r.code === 0) {
    toast('å¯†ç¢¼å·²ä¿®æ”¹');
    bootstrap.Modal.getInstance(document.getElementById('chPwdModal'))?.hide();
  } else {
    toast(r.message, 'danger');
  }
}

// â•â•â•â•â•â•â•â•â•â• ACCOUNT MANAGEMENT â•â•â•â•â•â•â•â•â•â•
async function loadAccs() {
  const r = await R('GET', '/api/accounts/');
  if (r.code !== 0) { toast(r.message, 'danger'); return; }
  const items = r.data.items || [];
  const roleBadge = role => role === 'admin'
    ? '<span class="badge bg-danger">ç®¡ç†å“¡</span>'
    : '<span class="badge bg-secondary">æ™®é€šç”¨æˆ¶</span>';
  document.getElementById('accTb').innerHTML = items.length ? items.map(u =>
    '<tr>' +
    '<td><code>' + eh(u.username) + '</code>' + (u.username==='admin'?'  <span class="badge bg-warning text-dark" style="font-size:.65rem">ç³»çµ±</span>':'') + '</td>' +
    '<td>' + eh(u.display_name || '-') + '</td>' +
    '<td>' + roleBadge(u.role) + '</td>' +
    '<td>' + (u.is_active ? '<span class="badge bg-success">å•Ÿç”¨</span>' : '<span class="badge bg-secondary">åœç”¨</span>') + '</td>' +
    '<td class="text-muted small">' + u.created_at + '</td>' +
    '<td>' +
      '<button class="btn bi btn-outline-primary btn-sm me-1" onclick="editAcc(' + u.id + ')" title="ç·¨è¼¯"><i class="fas fa-edit fa-xs"></i></button>' +
      (u.username !== 'admin'
        ? '<button class="btn bi btn-outline-danger btn-sm" onclick="delAcc(' + u.id + ',\'' + eh(u.username) + '\')" title="åˆªé™¤"><i class="fas fa-trash fa-xs"></i></button>'
        : '') +
    '</td>' +
    '</tr>'
  ).join('') : '<tr><td colspan="6" class="text-center text-muted py-4">æš«ç„¡è³¬æˆ¶</td></tr>';
}

function openAccModal() {
  ['accId','accUsername','accDisplay','accPwd','accNewPwd'].forEach(id => { const e=document.getElementById(id); if(e) e.value=''; });
  document.getElementById('accRole').value = 'normal';
  document.getElementById('accActive').checked = true;
  document.getElementById('accPwdWrap').style.display   = '';
  document.getElementById('accNewPwdWrap').style.display = 'none';
  document.getElementById('accUsername').readOnly = false;
  document.getElementById('accMT').textContent = 'æ–°å»ºè³¬æˆ¶';
  bootstrap.Modal.getOrCreateInstance(document.getElementById('accModal')).show();
}

async function editAcc(id) {
  const r = await R('GET', '/api/accounts/' + id + '/');
  if (r.code !== 0) { toast(r.message, 'danger'); return; }
  const u = r.data;
  document.getElementById('accId').value      = u.id;
  document.getElementById('accUsername').value = u.username;
  document.getElementById('accDisplay').value  = u.display_name || '';
  document.getElementById('accRole').value     = u.role;
  document.getElementById('accActive').checked = u.is_active;
  document.getElementById('accPwdWrap').style.display    = 'none';
  document.getElementById('accNewPwdWrap').style.display = '';
  document.getElementById('accUsername').readOnly = true;
  document.getElementById('accMT').textContent = 'ç·¨è¼¯è³¬æˆ¶ï¼š' + u.username;
  bootstrap.Modal.getOrCreateInstance(document.getElementById('accModal')).show();
}

async function saveAcc() {
  const id = document.getElementById('accId').value;
  const isEdit = !!id;
  const body = {
    username:     document.getElementById('accUsername').value.trim(),
    display_name: document.getElementById('accDisplay').value.trim(),
    role:         document.getElementById('accRole').value,
    is_active:    document.getElementById('accActive').checked,
  };
  if (isEdit) {
    const np = document.getElementById('accNewPwd').value;
    if (np) body.password = np;
  } else {
    body.password = document.getElementById('accPwd').value;
    if (!body.username) { toast('è«‹å¡«å¯«ç”¨æˆ¶å', 'warning'); return; }
    if (!body.password) { toast('è«‹å¡«å¯«å¯†ç¢¼', 'warning'); return; }
  }
  const r = isEdit
    ? await R('PUT',  '/api/accounts/' + id + '/', body)
    : await R('POST', '/api/accounts/', body);
  if (r.code === 0) {
    toast(r.message);
    bootstrap.Modal.getInstance(document.getElementById('accModal'))?.hide();
    loadAccs();
  } else {
    toast(r.message, 'danger');
  }
}

async function delAcc(id, uname) {
  if (!confirm('ç¢ºèªåˆªé™¤è³¬æˆ¶ã€Œ' + uname + 'ã€ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚')) return;
  const r = await R('DELETE', '/api/accounts/' + id + '/');
  r.code === 0 ? (toast('è³¬æˆ¶å·²åˆªé™¤'), loadAccs()) : toast(r.message, 'danger');
}
</script>
</body>
</html>
